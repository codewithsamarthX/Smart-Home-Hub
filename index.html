<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Smart Home Hub </title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <style>
        :root {
            --thumb-border-color: #3b82f6;
            /* --light-hue is now set per-card */
            --fan-hue: 200;   /* Default fan hue (cyan) */
        }

        /* --- Custom Scrollbar (Light Theme) --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f3f4f6; border-radius: 10px; } /* gray-100 */
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; } /* gray-400 */
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; } /* gray-500 */

        /* --- Dynamic Background (Light Theme) --- */
        body {
            /* Light default: white to gray-100 */
            background-image: radial-gradient(circle at 10% 20%, rgb(255, 255, 255) 0%, rgb(243, 244, 246) 90%);
            transition: background-image 1s linear;
        }
        /* These dynamic themes are fine, they will override the default light theme as intended */
        body.theme-morning { background-image: radial-gradient(circle at 10% 20%, rgb(222, 230, 240) 0%, rgb(240, 243, 247) 90%); } /* Lighter morning */
        body.theme-evening { background-image: radial-gradient(circle at 10% 20%, rgb(240, 230, 242) 0%, rgb(220, 218, 230) 90%); } /* Lighter evening */
        body.theme-night { background-image: radial-gradient(circle at 10% 20%, rgb(200, 202, 215) 0%, rgb(190, 190, 200) 90%); } /* "Night light" theme */

        /* --- Sliders (Light Theme) --- */
        input[type="range"] {
            -webkit-appearance: none; appearance: none; width: 100%; height: 8px;
            background-color: #d1d5db; /* gray-300 */
            border-radius: 8px; outline: none;
            transition: background 0.2s ease;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px;
            background-color: white; border-radius: 50%;
            border: 3px solid var(--thumb-border-color);
            cursor: pointer; margin-top: -6px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* Added subtle shadow */
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px; height: 20px; background-color: white; border-radius: 50%;
            border: 3px solid var(--thumb-border-color);
            cursor: pointer; transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* Added subtle shadow */
        }
        input[type="range"].color-slider {
            background: linear-gradient(to right,
                #ff0000, #ff8000, #ffff00, #00ff00, #00ffff, #0000ff, #8000ff, #ff0080, #ff0000
            );
        }

        /* --- Ripple Effect --- */
        .ripple-button { position: relative; overflow: hidden; }
        .ripple {
            position: absolute; border-radius: 50%;
            transform: scale(0); animation: ripple 0.6s linear;
            background-color: rgba(0, 0, 0, 0.2); /* Darker ripple for light theme */
            pointer-events: none;
        }
        @keyframes ripple { to { transform: scale(4); opacity: 0; } }

        /* --- Buttons (Light Theme) --- */
        .temp-button {
            width: 3rem; height: 3rem; border-radius: 9999px; 
            background-color: #e5e7eb; /* gray-200 */
            color: #1f2937; /* gray-800 */
            display: flex; align-items: center; justify-content: center; font-size: 1.875rem; font-weight: bold;
            transition: all 150ms;
        }
        .temp-button:active { background-color: #d1d5db; transform: scale(0.95); } /* gray-300 */

        .scene-button { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 1rem; border-radius: .5rem; 
            background-color: rgba(255,255,255,0.7); /* white/70 */
            border: 1px solid rgba(209,213,219,0.5); /* border-gray-300/50 */
            backdrop-filter: blur(8px); 
            color: #374151; /* text-gray-700 */
            transition: 200ms;
            position: relative; overflow: hidden;
        }
        .scene-button:hover { 
            background-color: rgba(243,244,246,0.8); /* bg-gray-100/80 */
            color: #111827; /* text-gray-900 */
        }
        .scene-button.active { 
            background-color: rgba(37,99,235,0.9); 
            color: white; 
            border-color:#3B82F6; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); 
        }

        /* --- Icons --- */
        .icon-on { color: hsl(var(--light-hue,60),100%,50%); filter: drop-shadow(0 0 8px hsl(var(--light-hue,60),100%,50%)); }
        .icon-locked { color: #EF4444; }
        .icon-unlocked { color: #10B981; }
        #fan-icon { will-change: transform; }
        .icon-fan-on { color: hsl(var(--fan-hue, 200), 100%, 50%); filter: drop-shadow(0 0 8px hsl(var(--fan-hue, 200), 100%, 50%)); }

        @keyframes glow { /* Kept for speaker 'Now Playing' icon */
            0%,100% { filter: drop-shadow(0 0 6px var(--glow-color, #3b82f6)); }
            50% { filter: drop-shadow(0 0 12px var(--glow-color, #3b82f6)); }
        }
        .glow-animate { animation: glow 1.5s infinite; }

        /* --- Device Card (Light Theme) --- */
        .device-card {
            background-color: rgba(255, 255, 255, 0.7); /* bg-white/70 */
            backdrop-filter: blur(8px);
            border: 1px solid rgba(209, 213, 219, 0.5); /* border-gray-300/50 */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); /* shadow-lg */
            padding: 1.5rem; /* p-6 */
            
            /* NEW: Transition for filtering */
            transition: transform 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease, 
                        opacity 0.3s ease, max-height 0.4s ease, 
                        margin 0.4s ease, padding 0.4s ease;
            transform-origin: center top;
            overflow: hidden;
        }
        .device-card:hover:not(.card-is-active):not(:has(input:focus)):not(:has(button:focus)) {
            transform: translateY(-4px) scale(1.02);
            border-color: rgba(156, 163, 175, 0.7); /* gray-400/70 */
        }

        /* NEW: Hidden state for device filtering */
        .device-hidden {
            opacity: 0;
            transform: scale(0.95);
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-bottom: 0;
            border-width: 0;
            pointer-events: none;
        }

        /* --- Card Active States (V1 Style: Border Only) --- */
        .card-active-blue { border-color: #3b82f6; }
        .card-active-red { border-color: #ef4444; }
        .card-active-green { border-color: #10b981; }
        .card-active-cyan { border-color: #22d3ee; }
        .card-active-purple { border-color: #a78bfa; }

        /* --- Expandable Card UX --- */
        .collapsible-controls {
            display: grid;
            grid-template-rows: 0fr; /* Collapsed by default */
            transition: grid-template-rows 0.4s ease-in-out;
            overflow: hidden;
        }
        .collapsible-controls > div {
            min-height: 0;
            opacity: 0;
            transition: opacity 0.3s ease-out 0.1s;
        }
        .card-is-active .collapsible-controls {
            grid-template-rows: 1fr; /* Expands to fit content */
            margin-top: 1rem; /* Add some space when open */
        }
        .card-is-active .collapsible-controls > div {
            opacity: 1;
        }
        .card-status-text {
            transition: color 0.3s ease;
            color: #6b7280; /* text-gray-500 */
        }
        .card-is-active .card-status-text {
            color: #111827; /* text-gray-900 */
            font-weight: 600;
        }

        /* --- Active Card Glow Effects --- */
        .card-is-active[data-device="light"] {
            border-color: hsl(var(--light-hue), 100%, 70%);
            box-shadow: 0 0 20px 5px hsla(var(--light-hue), 100%, 60%, 0.3);
        }
        .card-is-active[data-device="fan"] {
            border-color: hsl(var(--fan-hue), 100%, 70%);
            box-shadow: 0 0 20px 5px hsla(var(--fan-hue), 100%, 60%, 0.3);
        }
        /* --- End New Styles --- */

        /* --- Add Device Button (Light Theme) --- */
        @keyframes pulse-border {
            0%, 100% { border-color: rgba(156, 163, 175, 0.7); } /* gray-400/70 */
            50% { border-color: rgba(59, 130, 246, 0.9); }
        }
        #add-device-button { animation: pulse-border 2.5s infinite; }

        /* --- Modal (Light Theme) --- */
        .modal-hidden { display: none; }
        #modal-overlay {
            position: fixed; inset: 0;
            background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px);
            opacity: 0; transition: opacity 0.3s ease; z-index: 40;
        }
        #modal-overlay.active { opacity: 1; }
        #modal-box {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background-color: #ffffff; /* white */
            color: #1f2937; /* gray-800 */
            border-radius: 0.75rem; 
            border: 1px solid #d1d5db; /* gray-300 */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.2);
            padding: 1.5rem; width: 90%; max-width: 512px;
            opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease; z-index: 50;
        }
        #modal-box.active { opacity: 1; transform: translate(-50%, -50%) scale(1); }

        /* --- Slider Tooltip --- */
        .slider-tooltip {
            position: absolute; background-color: #3b82f6;
            color: white; font-weight: 600; padding: 4px 8px;
            border-radius: 4px; font-size: 0.875rem;
            bottom: 30px; left: 50%;
            transform: translateX(-50%);
            pointer-events: none; opacity: 0;
            transition: opacity 0.2s ease, bottom 0.2s ease;
            white-space: nowrap; z-index: 10;
        }
        .slider-container:has(input[type="range"]:active) .slider-tooltip {
            opacity: 1; bottom: 40px;
        }

        /* --- NEW: Room Tab Button (Light Theme) --- */
        .room-tab-button {
            padding: 0.5rem 1.25rem;
            border-radius: 9999px;
            font-weight: 500;
            color: #4b5563; /* text-gray-600 */
            background-color: transparent;
            border: 1px solid #d1d5db; /* border-gray-300 */
            transition: all 0.2s ease;
        }
        .room-tab-button:hover {
            color: #111827; /* text-gray-900 */
            background-color: #e5e7eb; /* bg-gray-200 */
        }
        .room-tab-button.active {
            color: white;
            background-color: #2563eb; /* bg-blue-600 */
            border-color: #2563eb;
        }

    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans antialiased min-h-screen flex flex-col">

    <main class="flex-grow p-4 md:p-8">
        <header class="mb-8 flex justify-between items-center max-w-7xl mx-auto">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold">Smart Hub</h1>
                <p id="date-display" class="text-lg text-gray-600">Loading date...</p>
            </div>
             <div class="text-right flex items-center gap-4">
                <div class="flex gap-3 justify-end items-center">
                    <i data-lucide="cloud-sun" class="w-10 h-10 text-yellow-400" id="weather-icon"></i>
                    <div>
                        <div id="weather-temp" class="text-2xl font-bold">75&deg;F</div>
                        <div id="weather-desc" class="text-sm text-gray-600">Partly Cloudy</div>
                    </div>
                </div>
                <div>
                    <div id="time-display" class="text-3xl md:text-4xl font-bold">--:--:--</div>
                    <div id="ampm-display" class="text-lg text-gray-600">&nbsp;</div>
                </div>
            </div>
        </header>

         <section class="max-w-7xl mx-auto mb-8">
            <h2 class="text-2xl font-semibold mb-4">Scenes</h2>
            <div class="grid grid-cols-3 md:grid-cols-6 gap-4">
                <button id="scene-good-morning" class="scene-button ripple-button" data-scene="goodMorning">
                    <i data-lucide="sunrise" class="mb-2"></i>
                    <span class="pointer-events-none">Good Morning</span>
                </button>
                <button id="scene-movie-night" class="scene-button ripple-button" data-scene="movieNight">
                    <i data-lucide="film" class="mb-2"></i>
                    <span class="pointer-events-none">Movie Night</span>
                </button>
                <button id="scene-good-night" class="scene-button ripple-button" data-scene="goodNight">
                    <i data-lucide="moon" class="mb-2"></i>
                    <span class="pointer-events-none">Good Night</span>
                </button>
                <button id="scene-all-off" class="scene-button ripple-button" data-scene="allOff">
                    <i data-lucide="power-off" class="mb-2"></i>
                    <span class="pointer-events-none">All Off</span>
                </button>
                <button id="scene-party-time" class="scene-button ripple-button" data-scene="partyTime">
                    <i data-lucide="party-popper" class="mb-2"></i>
                    <span class="pointer-events-none">Party Time</span>
                </button>
                <button id="scene-focus-mode" class="scene-button ripple-button" data-scene="focusMode">
                    <i data-lucide="brain" class="mb-2"></i>
                    <span class="pointer-events-none">Focus Mode</span>
                </button>
            </div>
        </section>

        <section class="max-w-7xl mx-auto mb-6">
            <h2 class="text-2xl font-semibold mb-4">Devices</h2>
            <div id="room-tab-container" class="flex flex-wrap gap-3">
                <button class="room-tab-button ripple-button active" data-room="all">All</button>
                <button class="room-tab-button ripple-button" data-room="living-room">Living Room</button>
                <button class="room-tab-button ripple-button" data-room="bedroom">Bedroom</button>
                <button class="room-tab-button ripple-button" data-room="entry">Entry</button>
            </div>
        </section>
        <div id="device-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-7xl mx-auto">
            
            <div id="living-light-card" class="device-card cursor-pointer" 
                 style="--light-hue: 200;"
                 role="button" tabindex="0" aria-pressed="false" aria-label="Living Room Light toggle"
                 data-device="light" data-room="living-room">
                
                <div class="flex justify-between items-center pointer-events-none">
                    <div class="flex items-center space-x-3">
                        <i id="living-light-icon" data-lucide="lightbulb" class="w-7 h-7 text-gray-500 transition-all duration-300"></i>
                        <h2 class="text-2xl font-semibold">Living Room Light</h2>
                    </div>
                    <span id="living-light-status-text" class="text-lg font-medium card-status-text">Off</span>
                </div>

                <div class="collapsible-controls">
                    <div class="space-y-3">
                        <div class="space-y-3 transition-opacity duration-300">
                            <label for="living-light-intensity" class="block text-sm font-medium text-gray-600">Intensity</label>
                            <div class="slider-container relative">
                                <input type="range" id="living-light-intensity" min="0" max="100" value="50" class="w-full" aria-label="Light intensity">
                                <div id="living-light-intensity-tooltip" class="slider-tooltip">50%</div>
                            </div>
                        </div>
                        <div class="space-y-3 mt-4 transition-opacity duration-300">
                            <label for="living-light-color" class="block text-sm font-medium text-gray-600">Color</label>
                            <div class="slider-container relative">
                                <input type="range" id="living-light-color" min="0" max="360" value="200" class="w-full color-slider" aria-label="Light color">
                                <div id="living-light-color-tooltip" class="slider-tooltip" style="background-color: hsl(200, 100%, 50%)">Hue: 200°</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="bed-light-card" class="device-card cursor-pointer" 
                 style="--light-hue: 30;"
                 role="button" tabindex="0" aria-pressed="false" aria-label="Bedroom Light toggle"
                 data-device="light" data-room="bedroom">
                
                <div class="flex justify-between items-center pointer-events-none">
                    <div class="flex items-center space-x-3">
                        <i id="bed-light-icon" data-lucide="lightbulb" class="w-7 h-7 text-gray-500 transition-all duration-300"></i>
                        <h2 class="text-2xl font-semibold">Bedroom Light</h2>
                    </div>
                    <span id="bed-light-status-text" class="text-lg font-medium card-status-text">Off</span>
                </div>

                <div class="collapsible-controls">
                    <div class="space-y-3">
                        <div class="space-y-3 transition-opacity duration-300">
                            <label for="bed-light-intensity" class="block text-sm font-medium text-gray-600">Intensity</label>
                            <div class="slider-container relative">
                                <input type="range" id="bed-light-intensity" min="0" max="100" value="50" class="w-full" aria-label="Light intensity">
                                <div id="bed-light-intensity-tooltip" class="slider-tooltip">50%</div>
                            </div>
                        </div>
                        <div class="space-y-3 mt-4 transition-opacity duration-300">
                            <label for="bed-light-color" class="block text-sm font-medium text-gray-600">Color</label>
                            <div class="slider-container relative">
                                <input type="range" id="bed-light-color" min="0" max="360" value="30" class="w-full color-slider" aria-label="Light color">
                                <div id="bed-light-color-tooltip" class="slider-tooltip" style="background-color: hsl(30, 100%, 50%)">Hue: 30°</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="fan-card" class="device-card cursor-pointer"
                 role="button" tabindex="0" aria-pressed="false" aria-label="Bedroom Fan toggle"
                 data-device="fan" data-room="bedroom">
                
                <div class="flex justify-between items-center pointer-events-none">
                    <div class="flex items-center space-x-3">
                        <i id="fan-icon" data-lucide="fan" class="w-7 h-7 text-gray-500 transition-all duration-300"></i>
                        <h2 class="text-2xl font-semibold">Bedroom Fan</h2>
                    </div>
                    <span id="fan-status-text" class="text-lg font-medium card-status-text">Off</span>
                </div>
                
                <div class="collapsible-controls">
                    <div class="space-y-3">
                        <div class="space-y-3 transition-opacity duration-300">
                            <label for="fan-speed" class="block text-sm font-medium text-gray-600">Speed</label>
                            <div class="slider-container relative">
                                <input type="range" id="fan-speed" min="0" max="5" value="2" step="1" class="w-full" aria-label="Fan speed">
                                <div id="fan-speed-tooltip" class="slider-tooltip">Level 2</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="thermostat-card" class="device-card" data-room="all"> <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center space-x-3">
                        <i id="thermostat-icon" data-lucide="thermometer" class="w-7 h-7 text-gray-500 transition-colors duration-300"></i>
                        <h2 class="text-2xl font-semibold">Thermostat</h2>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <button id="temp-down" class="temp-button ripple-button" aria-label="Temperature Down">-</button>
                    <div class="text-center">
                        <div id="temp-display" class="text-6xl font-bold">68&deg;</div>
                        <div id="temp-mode-display" class="text-lg text-gray-600">Off</div>
                    </div>
                    <button id="temp-up" class="temp-button ripple-button" aria-label="Temperature Up">+</button>
                </div>
                <div id="temp-mode-container" class="flex justify-around mt-4">
                    <button id="temp-mode-heat" class="temp-mode-button ripple-button p-2 rounded-lg border-2 border-transparent" data-mode="Heat" aria-label="Set Heat Mode"><i data-lucide="flame" class="w-6 h-6 text-gray-600 pointer-events-none transition-colors"></i></button>
                    <button id="temp-mode-cool" class="temp-mode-button ripple-button p-2 rounded-lg border-2 border-transparent" data-mode="Cool" aria-label="Set Cool Mode"><i data-lucide="snowflake" class="w-6 h-6 text-gray-600 pointer-events-none transition-colors"></i></button>
                    <button id="temp-mode-off" class="temp-mode-button ripple-button p-2 rounded-lg border-2 border-transparent" data-mode="Off" aria-label="Set Mode Off"><i data-lucide="power" class="w-6 h-6 text-gray-600 pointer-events-none transition-colors"></i></button>
                </div>
            </div>

            <div id="lock-card" class="device-card card-active-red" data-room="entry">
                 <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center space-x-3">
                        <i id="lock-icon-locked" data-lucide="lock" class="w-7 h-7 icon-locked transition-all duration-300"></i>
                        <i id="lock-icon-unlocked" data-lucide="lock-open" class="w-7 h-7 icon-unlocked transition-all duration-300 hidden"></i>
                        <h2 class="text-2xl font-semibold">Front Door</h2>
                    </div>
                </div>
                <button id="lock-toggle-button" class="w-full h-24 rounded-lg text-2xl font-semibold transition-colors duration-200 ripple-button bg-gray-200 hover:bg-gray-300">
                    Unlock
                </button>
            </div>

            <div id="speaker-card" class="device-card" data-room="living-room">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center space-x-3">
                        <i id="speaker-icon" data-lucide="volume-2" class="w-7 h-7 text-gray-500 transition-colors duration-300"></i>
                        <h2 class="text-2xl font-semibold">Living Room Speaker</h2>
                    </div>
                </div>
                <div id="speaker-controls" class="space-y-3">
                    <label for="speaker-volume" class="block text-sm font-medium text-gray-600">Volume</label>
                    <div class="slider-container relative">
                        <input type="range" id="speaker-volume" min="0" max="100" value="30" class="w-full" aria-label="Speaker volume">
                        <div class="slider-tooltip" id="speaker-volume-tooltip">30%</div>
                    </div>
                    <div id="speaker-volume-value" class="text-center text-lg font-medium">30%</div>
                </div>
                <div class="mt-4 text-center">
                    <div id="track-title" class="text-lg text-gray-700 mb-2 h-6 truncate">Paused</div>
                    <div class="relative w-full h-1 bg-gray-300 rounded-full my-3 group cursor-pointer" id="progress-bar-container">
                        <div id="track-progress" class="absolute h-1 bg-purple-500 rounded-full" style="width: 0%;"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-600">
                        <span id="track-current-time">0:00</span>
                        <span id="track-duration">0:00</span>
                    </div>
                    <div class="flex justify-center items-center space-x-4 mt-2">
                        <button id="prev-track" class="p-3 rounded-full bg-gray-200 hover:bg-gray-300 transition-all shadow-md hover:scale-110 ripple-button" aria-label="Previous Track"><i data-lucide="skip-back" class="w-6 h-6 pointer-events-none"></i></button>
                        <button id="play-pause" class="p-4 rounded-full bg-blue-600 hover:bg-blue-700 transition-all transform hover:scale-110 shadow-lg ripple-button" aria-label="Play Music">
                            <i id="play-icon" data-lucide="play" class="w-7 h-7 pointer-events-none"></i>
                            <i id="pause-icon" data-lucide="pause" class="w-7 h-7 pointer-events-none hidden"></i>
                        </button>
                        <button id="next-track" class="p-3 rounded-full bg-gray-200 hover:bg-gray-300 transition-all shadow-md hover:scale-110 ripple-button" aria-label="Next Track"><i data-lucide="skip-forward" class="w-6 h-6 pointer-events-none"></i></button>
                    </div>
                    <div class="mt-3 flex justify-center items-center space-x-2">
                        <i id="now-playing-icon" data-lucide="radio" class="w-5 h-5 text-gray-600 transition-all duration-300" style="--glow-color: #a78bfa;"></i>
                        <span id="now-playing-text" class="text-sm text-gray-600">Idle</span>
                    </div>
                </div>
            </div>

            <div id="add-device-button" class="device-card border-dashed cursor-pointer"
                 role="button" tabindex="0" aria-label="Add new device" data-room="all"> <div class="flex items-center justify-center h-full pointer-events-none">
                    <div class="text-center text-gray-500">
                        <i data-lucide="plus-circle" class="w-12 h-12 mb-2 inline-block"></i>
                        <p>Add New Device</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="modal-overlay" class="modal-hidden"></div>
        <div id="modal-box" class="modal-hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold">Add New Device</h2>
                <button id="modal-close-button" class="p-1 rounded-full text-gray-500 hover:bg-gray-200 hover:text-gray-900 ripple-button" aria-label="Close modal">
                    <i data-lucide="x" class="w-6 h-6 pointer-events-none"></i>
                </button>
            </div>
            <p class="text-gray-700 mb-6">Select a device type to add to your hub. (This is a demo, no new device will be added).</p>
            <div class="grid grid-cols-2 gap-4">
                <button class="scene-button ripple-button" aria-label="Add smart light">
                    <i data-lucide="lightbulb" class="mb-2"></i><span>Smart Light</span>
                </button>
                <button class="scene-button ripple-button" aria-label="Add smart plug">
                    <i data-lucide="plug" class="mb-2"></i><span>Smart Plug</span>
                </button>
                <button class="scene-button ripple-button" aria-label="Add camera">
                    <i data-lucide="camera" class="mb-2"></i><span>Camera</span>
                </button>
                <button class="scene-button ripple-button" aria-label="Add door lock">
                    <i data-lucide="lock" class="mb-2"></i><span>Door Lock</span>
                </button>
            </div>
        </div>
    </main>

    <footer class="sticky bottom-0 bg-white/80 backdrop-blur-md p-4 w-full border-t border-gray-300/50 z-20">
        <div class="max-w-3xl mx-auto flex flex-col items-center space-y-3">
            <div id="status-message" class="text-gray-600 text-sm h-5 transition-opacity">Tap mic to speak</div>
            <button id="mic-button" class="bg-blue-600 hover:bg-blue-700 text-white p-5 rounded-full shadow-lg transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-500/50 ripple-button"
                    aria-label="Activate voice control">
                <i id="mic-icon" data-lucide="mic" class="w-7 h-7"></i>
                <i id="mic-active-icon" data-lucide="radio" class="w-7 h-7 hidden"></i>
            </button>
            <p id="transcript-display" class="text-center text-gray-700 min-h-[1.5em] text-lg px-4"></p>
        </div>
    </footer>

    <audio id="audio-player" preload="metadata"></audio>
    <audio id="audio-click" preload="auto" src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//tQwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAZGVoAAAAgAAAAREBBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8DzPQ//tQwRAAlwAACpAAAAP/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////8AAAAAAAADyAABQIR0ADSIAY2BsoBBNpgAAAYEUQCgKAABsxUQCgAB/gRqAR2AAAYEQCgGgAF/hpkAR0BCAYEQAgGgAF/hpkAR0BCQYEQAgGgAF/hpkAR0BCT//tQwRMAHAAACPAED/8EHAAAECQcABwgYBgYFAAABsxQRCgAANVUAQgECAQUCgYEOAYeBPIBA3kDmQGhAQMBBgWBgoEBgYKYobVAQgEBAQABAwEBAYGChQGBgEBAAEDAAAECgQGAgABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVIndiamEAAAAPAAAACAAADSAAAAAPAAAACAAADSAAAAAPAAAACAAADSAAAAAPAAAACAAADSAAD/tQwQcAJwAACNABA//EGGAAAECQcABwgYBgYFAAABsxQRCgAANVUAQgECAQUCgYEOAYeBPIBA3kDmQGhAQMBBgWBgoEBgYKYobVAQgEBAQABAwEBAYGChQGBgEBAAEDAAAECgQGAgABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVTAAAAAAAADyAAAAAAAAAAEAAAJiZmFtaWx5AAAAAAAAAABMYXZjNTguNzYuMTAwAAAAAAAAAAAAAAAAAAAAAAD/mZzAzAAAADv/7UMIJwP/9P/9AAGjABwA3bW1BAAggAATYwEQFADEQAAdjd1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1D1d1d1d1d1c="></audio>
    <audio id="audio-toggle" preload="auto" src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//tQwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAZGVoAAAAgAAAAREBBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8DzPQ//tQwRMAHgAACpAAAAP/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////8AAAAAAAADyAABQIR0ADSIAY2BsoBBNpgAAAYEUQCgKAABsxUQCgAB/gRqAR2AAAYEQCgGgAF/hpkAR0BCAYEQAgGgAF/hpkAR0BCQYEQAgGgAF/hpkAR0BCT//tQwROAHAAACPAED/8EHAAAECQcABwgYBgYFAAABsxQRCgAANVUAQgECAQUCgYEOAYeBPIBA3kDmQGhAQMBBgWBgoEBgYKYobVAQgEBAQABAwEBAYGChQGBgEBAAEDAAAECgQGAgABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVIndiamEAAAAPAAAACAAADSAAAAAPAAAACAAADSAAAAAPAAAACAAADSAAAAAPAAAACAAADSAAD/Type/7UMFPAAABuAACNABA//EGGAAAECQcABwgYBgYFAAABsxQRCgAANVUAQgECAQUCgYEOAYeBPIBA3kDmQGhAQMBBgWBgoEBgYKYobVAQgEBAQABAwEBAYGChQGBgEBAAEDAAAECgQGAgABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV"></audio>
    

  <script>
    // --- Main App Initializer ---
    document.addEventListener('DOMContentLoaded', () => {
        SmartHub.init();
    });

    // --- Main SmartHub Application Object ---
    const SmartHub = {

        // --- 1. Application State ---
        state: {
            // NEW: Added a second light state
            livingLight: { intensity: 50, lastKnownIntensity: 50, hue: 200 },
            bedLight: { intensity: 50, lastKnownIntensity: 50, hue: 30 },
            fan: { speed: 2, lastKnownSpeed: 2 },
            thermostat: { temperature: 68, mode: 'Off' },
            lock: { isLocked: true },
            speaker: { isPlaying: false, volume: 30, trackIndex: 0 },
            activeScene: null,
            currentRoom: 'all', // NEW: State for room filtering
            statusTimer: null,
            listening: false,
            currentMockWeatherIndex: 1,
            currentTheme: null 
        },

        // --- 2. Static Configuration ---
        config: {
            // ... (All other configs are the same)
            playlist: [
                'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
                'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',
                'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3'
            ],
            colorMap: { red: 0, orange: 30, yellow: 60, green: 120, cyan: 180, blue: 240, purple: 270, magenta: 300, pink: 330 },
            wordToNumberMap: { 'zero':0,'oh':0,'one':1,'two':2,'three':3,'four':4,'five':5,'six':6,'seven':7,'eight':8,'nine':9,'ten':10,'eleven':11,'twelve':12,'thirteen':13,'fourteen':14,'fifteen':15,'sixteen':16,'seventeen':17,'eighteen':18,'nineteen':19,'twenty':20,'thirty':30,'forty':40,'fifty':50,'sixty':60,'seventy':70,'eighty':80,'ninety':90,'hundred':100,'a':1 },
            mockWeather: [
                { desc: 'Sunny', temp: 78, icon: 'sun', color: 'text-yellow-400' },
                { desc: 'Partly Cloudy', temp: 75, icon: 'cloud-sun', color: 'text-yellow-400' },
                { desc: 'Cloudy', temp: 72, icon: 'cloud', color: 'text-gray-400' },
                { desc: 'Rain', temp: 68, icon: 'cloud-rain', color: 'text-blue-400' },
                { desc: 'Clear Night', temp: 65, icon: 'moon', color: 'text-blue-200' }
            ],
            scenes: {
                'goodMorning': {
                    message: "Activated 'Good Morning' scene.",
                    updates: {
                        livingLight: { intensity: 70, lastKnownIntensity: 70, hue: 50 },
                        bedLight: { intensity: 60, lastKnownIntensity: 60, hue: 40 },
                        fan: { speed: 0 },
                        thermostat: { temperature: 68, mode: 'Heat' },
                        lock: { isLocked: false }
                    }
                },
                'movieNight': {
                    message: "Activated 'Movie Night' scene.",
                    updates: {
                        livingLight: { intensity: 20, lastKnownIntensity: 20, hue: 240 },
                        bedLight: { intensity: 0 },
                        fan: { speed: 1, lastKnownSpeed: 1 },
                        lock: { isLocked: true }
                    },
                    audio: { volume: 40, play: true }
                },
                'goodNight': {
                    message: "Activated 'Good Night' scene.",
                    updates: {
                        livingLight: { intensity: 0 },
                        bedLight: { intensity: 0 },
                        fan: { speed: 0 },
                        thermostat: { temperature: 65, mode: 'Heat' },
                        lock: { isLocked: true }
                    },
                    audio: { volume: 0, pause: true }
                },
                'allOff': {
                    message: "Turned all devices off.",
                    updates: {
                        livingLight: { intensity: 0 },
                        bedLight: { intensity: 0 },
                        fan: { speed: 0 },
                        thermostat: { mode: 'Off' }
                    },
                    audio: { volume: 0, pause: true }
                },
                'partyTime': {
                    message: "Let's get this party started!",
                    updates: {
                        livingLight: { intensity: 100, lastKnownIntensity: 100, hue: 300 },
                        bedLight: { intensity: 80, lastKnownIntensity: 80, hue: 200 },
                        fan: { speed: 1, lastKnownSpeed: 1 },
                        thermostat: { temperature: 70, mode: 'Cool' },
                        lock: { isLocked: true }
                    },
                    audio: { volume: 70, play: true }
                },
                'focusMode': {
                    message: "Activating 'Focus Mode'.",
                    updates: {
                        livingLight: { intensity: 60, lastKnownIntensity: 60, hue: 220 },
                        bedLight: { intensity: 0 },
                        fan: { speed: 1, lastKnownSpeed: 1 },
                        thermostat: { temperature: 68, mode: 'Heat' },
                        lock: { isLocked: true }
                    },
                    audio: { volume: 0, pause: true }
                }
            },
            
            // --- UPDATED: Commands to target specific lights ---
            commands: [
                // ... (Scenes, thermostat, fan, lock commands are the same)
                { regex: /good morning/i, handler: () => SmartHub.EventHandlers.runScene('goodMorning') },
                { regex: /movie night/i, handler: () => SmartHub.EventHandlers.runScene('movieNight') },
                { regex: /good night/i, handler: () => SmartHub.EventHandlers.runScene('goodNight') },
                { regex: /(turn everything off|all off)/i, handler: () => SmartHub.EventHandlers.runScene('allOff') },
                { regex: /party time/i, handler: () => SmartHub.EventHandlers.runScene('partyTime') },
                { regex: /focus mode/i, handler: () => SmartHub.EventHandlers.runScene('focusMode') },
                
                // NEW: Light commands
                { 
                    regex: /(living room light|living light) (on|off)/i,
                    handler: (matches) => {
                        const state = SmartHub.state.livingLight;
                        if (matches[2] === 'on') {
                            state.intensity = state.lastKnownIntensity;
                        } else {
                            state.intensity = 0;
                        }
                        SmartHub.Speech.showStatus(`OK, turning ${matches[2]} the living room light.`);
                    }
                },
                { 
                    regex: /(bedroom light|bed light) (on|off)/i,
                    handler: (matches) => {
                        const state = SmartHub.state.bedLight;
                        if (matches[2] === 'on') {
                            state.intensity = state.lastKnownIntensity;
                        } else {
                            state.intensity = 0;
                        }
                        SmartHub.Speech.showStatus(`OK, turning ${matches[2]} the bedroom light.`);
                    }
                },
                { 
                    regex: /(turn on all lights|lights on)/i,
                    handler: () => {
                        SmartHub.state.livingLight.intensity = SmartHub.state.livingLight.lastKnownIntensity;
                        SmartHub.state.bedLight.intensity = SmartHub.state.bedLight.lastKnownIntensity;
                        SmartHub.Speech.showStatus(`OK, turning on all lights.`);
                    }
                },
                { 
                    regex: /(turn off all lights|lights off)/i,
                    handler: () => {
                        SmartHub.state.livingLight.intensity = 0;
                        SmartHub.state.bedLight.intensity = 0;
                        SmartHub.Speech.showStatus(`OK, turning off all lights.`);
                    }
                },
                { 
                    regex: /(set living room light to|set living light to)/i,
                    handler: (matches, command) => SmartHub.EventHandlers.handleLightCommand(command, 'livingLight')
                },
                { 
                    regex: /(set bedroom light to|set bed light to)/i,
                    handler: (matches, command) => SmartHub.EventHandlers.handleLightCommand(command, 'bedLight')
                },
                // Fallback for "set light" - assume living room
                { 
                    regex: /(set light to|change light to|set light intensity to)/i,
                    handler: (matches, command) => SmartHub.EventHandlers.handleLightCommand(command, 'livingLight')
                },

                // Fan commands (unchanged)
                { 
                    regex: /fan (on|off)/i,
                    handler: (matches) => {
                        const state = SmartHub.state;
                        if (matches[1] === 'on') {
                            state.fan.speed = state.fan.lastKnownSpeed;
                            SmartHub.Speech.showStatus("OK, turning on the fan.");
                        } else {
                            state.fan.speed = 0;
                            SmartHub.Speech.showStatus("OK, turning off the fan.");
                        }
                    }
                },
                { 
                    regex: /set fan speed to/i,
                    handler: (matches, command) => {
                        const speed = SmartHub.Speech.parseNumber(command);
                        if (speed !== null && speed >= 0 && speed <= 5) {
                            SmartHub.state.fan.speed = speed;
                            if (speed > 0) SmartHub.state.fan.lastKnownSpeed = speed;
                            SmartHub.Speech.showStatus(`Set fan speed to level ${speed}.`);
                        } else {
                            SmartHub.Speech.showStatus("Sorry, fan speed is from 0 to 5.");
                        }
                    }
                },
                // ... (Thermostat, Lock, Speaker commands are the same)
                 { 
                    regex: /set temperature to/i,
                    handler: (matches, command) => {
                        const temp = SmartHub.Speech.parseNumber(command);
                        if (temp) { 
                            SmartHub.state.thermostat.temperature = temp; 
                            SmartHub.Speech.showStatus(`Set temperature to ${temp} degrees.`); 
                        } else {
                            SmartHub.Speech.showStatus("Didn't catch the temperature.");
                        }
                    }
                },
                { regex: /(heat on|set to heat)/i, handler: () => { SmartHub.state.thermostat.mode = 'Heat'; SmartHub.Speech.showStatus("OK, heat mode is on."); } },
                { regex: /(ac on|set to cool|turn on ac)/i, handler: () => { SmartHub.state.thermostat.mode = 'Cool'; SmartHub.Speech.showStatus("OK, AC mode is on."); } },
                { regex: /thermostat off/i, handler: () => { SmartHub.state.thermostat.mode = 'Off'; SmartHub.Speech.showStatus("OK, thermostat is off."); } },
                { regex: /lock the door/i, handler: () => { SmartHub.state.lock.isLocked = true; SmartHub.Speech.showStatus("OK, front door is locked."); } },
                { regex: /unlock the door/i, handler: () => { SmartHub.state.lock.isLocked = false; SmartHub.Speech.showStatus("OK, front door is unlocked."); } },
                { regex: /(play music|play)/i, handler: () => { SmartHub.AudioPlayer.play(); SmartHub.Speech.showStatus("OK, playing music."); } },
                { regex: /(pause music|pause|stop music|stop)/i, handler: () => { SmartHub.AudioPlayer.pause(); SmartHub.Speech.showStatus("OK, stopping music."); } },
                { regex: /(next track|skip)/i, handler: () => SmartHub.AudioPlayer.next() },
                { regex: /previous track/i, handler: () => SmartHub.AudioPlayer.prev() },
                { 
                    regex: /volume/i,
                    handler: (matches, command) => {
                        const vol = SmartHub.Speech.parseNumber(command);
                        if (vol !== null && vol >= 0 && vol <= 100) { 
                            SmartHub.AudioPlayer.setVolume(vol); 
                            SmartHub.Speech.showStatus(`Setting volume to ${vol}%`); 
                        } else {
                            SmartHub.Speech.showStatus("Didn't catch the volume level.");
                        }
                    }
                },
            ]
        },

        // --- 3. UI Element Cache ---
        UI: {},

        // --- 4. Main Initializer ---
        init: function() {
            try {
                if (window.lucide) {
                    lucide.createIcons();
                } else {
                    console.warn("Lucide icons not loaded. Skipping icon creation.");
                }
            } catch (e) {
                console.error("Error creating icons (this is safe to ignore):", e);
            }
            
            // --- UPDATED: UI Element Cache ---
            SmartHub.UI = {
              body: document.body,
              timeDisplay: document.getElementById('time-display'),
              ampmDisplay: document.getElementById('ampm-display'),
              dateDisplay: document.getElementById('date-display'),
              weather: {
                iconContainer: (function(){
                  const ico = document.getElementById('weather-icon');
                  if (!ico) return null;
                  const wrap = document.createElement('div');
                  wrap.id = 'weather-icon-container';
                  ico.parentNode.insertBefore(wrap, ico);
                  wrap.appendChild(ico);
                  return wrap;
                })(),
                temp: document.getElementById('weather-temp'),
                desc: document.getElementById('weather-desc')
              },
              // NEW: Caching two separate lights
              livingLight: {
                card: document.getElementById('living-light-card'),
                intensity: document.getElementById('living-light-intensity'),
                statusText: document.getElementById('living-light-status-text'),
                icon: document.getElementById('living-light-icon'),
                colorSlider: document.getElementById('living-light-color'),
                intensityTooltip: document.getElementById('living-light-intensity-tooltip'),
                colorTooltip: document.getElementById('living-light-color-tooltip')
              },
              bedLight: {
                card: document.getElementById('bed-light-card'),
                intensity: document.getElementById('bed-light-intensity'),
                statusText: document.getElementById('bed-light-status-text'),
                icon: document.getElementById('bed-light-icon'),
                colorSlider: document.getElementById('bed-light-color'),
                intensityTooltip: document.getElementById('bed-light-intensity-tooltip'),
                colorTooltip: document.getElementById('bed-light-color-tooltip')
              },
              fan: {
                card: document.getElementById('fan-card'),
                speed: document.getElementById('fan-speed'),
                statusText: document.getElementById('fan-status-text'),
                icon: document.getElementById('fan-icon'),
                speedTooltip: document.getElementById('fan-speed-tooltip')
              },
              thermostat: {
                card: document.getElementById('thermostat-card'),
                display: document.getElementById('temp-display'),
                modeDisplay: document.getElementById('temp-mode-display'),
                icon: document.getElementById('thermostat-icon'),
                tempUp: document.getElementById('temp-up'),
                tempDown: document.getElementById('temp-down'),
                modeContainer: document.getElementById('temp-mode-container'),
                modeButtons: document.querySelectorAll('.temp-mode-button')
              },
              lock: {
                card: document.getElementById('lock-card'),
                iconLocked: document.getElementById('lock-icon-locked'),
                iconUnlocked: document.getElementById('lock-icon-unlocked'),
                button: document.getElementById('lock-toggle-button')
              },
              speaker: {
                card: document.getElementById('speaker-card'),
                icon: document.getElementById('speaker-icon'),
                volume: document.getElementById('speaker-volume'),
                value: document.getElementById('speaker-volume-value'),
                volumeTooltip: document.getElementById('speaker-volume-tooltip'),
                playButton: document.getElementById('play-pause'),
                playIcon: document.getElementById('play-icon'),
                pauseIcon: document.getElementById('pause-icon'),
                prevButton: document.getElementById('prev-track'),
                nextButton: document.getElementById('next-track'),
                trackTitle: document.getElementById('track-title'),
                nowIcon: document.getElementById('now-playing-icon'),
                nowText: document.getElementById('now-playing-text')
              },
              scenes: {
                goodMorning: document.getElementById('scene-good-morning'),
                movieNight: document.getElementById('scene-movie-night'),
                goodNight: document.getElementById('scene-good-night'),
                allOff: document.getElementById('scene-all-off'),
                partyTime: document.getElementById('scene-party-time'),
                focusMode: document.getElementById('scene-focus-mode')
              },
              voice: {
                micButton: document.getElementById('mic-button'),
                micIcon: document.getElementById('mic-icon'),
                micActiveIcon: document.getElementById('mic-active-icon'),
                statusMessage: document.getElementById('status-message'),
                transcriptDisplay: document.getElementById('transcript-display')
              },
              addDeviceCard: document.getElementById('add-device-button'),
              modal: {
                overlay: document.getElementById('modal-overlay'),
                box: document.getElementById('modal-box'),
                closeButton: document.getElementById('modal-close-button')
              },
              audioElement: document.getElementById('audio-player'),
              // NEW: Caching for room filtering
              room: {
                tabContainer: document.getElementById('room-tab-container'),
                tabs: document.querySelectorAll('.room-tab-button'),
                deviceGrid: document.getElementById('device-grid'),
                allDevices: document.querySelectorAll('#device-grid .device-card')
              }
            };
            // --- End UI Cache Update ---


            // --- Initialize Modules ---
            SmartHub.Persistence.loadState();
            SmartHub.AudioPlayer.init();
            SmartHub.Speech.init();
            SmartHub.EventHandlers.registerAll();

            // --- Run Initial Updates ---
            SmartHub.UIUpdater.updateAllUIs();
            SmartHub.HeaderDisplay.updateClock();
            SmartHub.HeaderDisplay.updateWeather(); 
            SmartHub.UIUpdater.filterDevicesByRoom(); // NEW: Run filter on load
            
            // --- Start Timers ---
            setInterval(() => SmartHub.HeaderDisplay.updateClock(), 1000); 
            setInterval(() => SmartHub.HeaderDisplay.updateWeather(), 300000); 
        },
        
        // --- 5. Persistence Module (Unchanged) ---
        Persistence: {
            saveState: function() {
                try {
                    const stateToSave = { ...SmartHub.state };
                    // ... (delete transient state)
                    delete stateToSave.statusTimer;
                    delete stateToSave.listening;
                    delete stateToSave.activeScene;
                    delete stateToSave.currentTheme;
                    delete stateToSave.currentRoom; // Don't save the active room
                    localStorage.setItem('smartHubState', JSON.stringify(stateToSave));
                } catch (e) {
                    console.warn("Could not save state to localStorage", e);
                }
            },
            loadState: function() {
                try {
                    const savedState = localStorage.getItem('smartHubState');
                    if (savedState) {
                        const parsedState = JSON.parse(savedState);
                        Object.assign(SmartHub.state, parsedState);
                        // ... (reset transient state)
                        SmartHub.state.listening = false;
                        SmartHub.state.statusTimer = null;
                        SmartHub.state.activeScene = null;
                        SmartHub.state.currentTheme = null;
                        SmartHub.state.currentRoom = 'all'; // Default to 'all'
                    }
                } catch (e) {
                    console.warn("Could not load state from localStorage", e);
                }
            }
        },

        // --- 6. Audio Player Module (Unchanged) ---
        AudioPlayer: {
            init: function() {
                const el = SmartHub.UI.audioElement;
                if (!el) { console.warn("Audio element not found."); return; }
                el.volume = SmartHub.state.speaker.volume / 100;
                el.addEventListener('ended', () => SmartHub.AudioPlayer.next());
                el.addEventListener('play', () => {
                    SmartHub.state.speaker.isPlaying = true;
                    SmartHub.UIUpdater.updateSpeakerUI();
                });
                el.addEventListener('pause', () => {
                    SmartHub.state.speaker.isPlaying = false;
                    SmartHub.UIUpdater.updateSpeakerUI();
                });
            },
            loadTrack: function(index) {
                const el = SmartHub.UI.audioElement;
                if (!el) return;
                const playlist = SmartHub.config.playlist;
                if (!playlist.length) return;
                
                SmartHub.state.speaker.trackIndex = ((index % playlist.length) + playlist.length) % playlist.length;
                const file = playlist[SmartHub.state.speaker.trackIndex];
                
                el.src = file;
                el.load();
                if (SmartHub.UI.speaker.trackTitle) {
                    SmartHub.UI.speaker.trackTitle.textContent = file.split('/').pop().replace('.mp3', '');
                }
                SmartHub.Persistence.saveState();
            },
            play: function() {
                const el = SmartHub.UI.audioElement;
                if (!el) return;
                if (!el.src) {
                    this.loadTrack(SmartHub.state.speaker.trackIndex);
                }
                const p = el.play();
                if (p && p.catch) {
                    p.catch(err => {
                        console.warn("Audio playback error:", err);
                        SmartHub.Speech.showStatus('Tap play to enable audio playback.', 4000, false);
                    });
                }
            },
            pause: function() {
                const el = SmartHub.UI.audioElement;
                if (!el) return;
                el.pause();
            },
            next: function() {
                this.loadTrack(SmartHub.state.speaker.trackIndex + 1);
                this.play();
                SmartHub.Speech.showStatus('Skipped to next track', 2000, false);
            },
            prev: function() {
                this.loadTrack(SmartHub.state.speaker.trackIndex - 1);
                this.play();
                SmartHub.Speech.showStatus('Playing previous track', 2000, false);
            },
            setVolume: function(v) {
                const el = SmartHub.UI.audioElement;
                if (!el) return;
                const value = Math.max(0, Math.min(100, Number(v)));
                SmartHub.state.speaker.volume = value;
                el.volume = value / 100;
                SmartHub.UIUpdater.updateSpeakerUI();
            }
        },
        
        // --- 7. Header Display Module (Unchanged) ---
        HeaderDisplay: {
            updateClock: function() {
                const now = new Date();
                const UI = SmartHub.UI;
                
                if (UI.dateDisplay) {
                    UI.dateDisplay.textContent = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                }
                
                let hours = now.getHours();
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const seconds = now.getSeconds().toString().padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 ? (hours % 12) : 12; 
                
                if (UI.timeDisplay) {
                    UI.timeDisplay.textContent = `${displayHours.toString().padStart(2, ' ')}:${minutes}:${seconds}`;
                }
                if (UI.ampmDisplay) {
                    UI.ampmDisplay.textContent = ampm;
                }
                
                // --- BODY THEME LOGIC (LIGHT THEME) ---
                // The default is now light. We only apply overrides.
                let newTheme = null; // Default (light)
                if (hours >= 5 && hours < 12) newTheme = 'theme-morning';
                else if (hours >= 12 && hours < 18) newTheme = null; // Use default light
                else if (hours >= 18 && hours < 22) newTheme = 'theme-evening';
                else newTheme = 'theme-night'; // Use "night light"

                if (newTheme !== SmartHub.state.currentTheme && UI.body) {
                    if (SmartHub.state.currentTheme) UI.body.classList.remove(SmartHub.state.currentTheme);
                    if (newTheme) UI.body.classList.add(newTheme);
                    SmartHub.state.currentTheme = newTheme;
                }
            },
           updateWeather: function() {
                const mockWeather = SmartHub.config.mockWeather;
                SmartHub.state.currentMockWeatherIndex = (SmartHub.state.currentMockWeatherIndex + 1) % mockWeather.length;
                const weather = mockWeather[SmartHub.state.currentMockWeatherIndex];
                
                const tempFluctuation = Math.floor(Math.random() * 3) - 1; 
                const displayTemp = weather.temp + tempFluctuation;
                
                if (SmartHub.UI.weather && SmartHub.UI.weather.temp && SmartHub.UI.weather.iconContainer) {
                    SmartHub.UI.weather.temp.innerHTML = `${displayTemp}&deg;F`;
                    SmartHub.UI.weather.desc.textContent = weather.desc;
                    SmartHub.UI.weather.iconContainer.innerHTML = `<i data-lucide="${weather.icon}" class="w-10 h-10 ${weather.color}"></i>`;
                    
                    try {
                        if (window.lucide) {
                            lucide.createIcons({
                                nodes: [SmartHub.UI.weather.iconContainer.querySelector('i')]
                            });
                        }
                    } catch (e) {
                        console.error("Failed to create weather icon:", e);
                    }
                }
            }
        },

        // --- 8. UI Updater Module ---
        UIUpdater: {
            updateSliderBackground: function(slider, color = '#3b82f6') {
                if (!slider) return;
                const value = (slider.value - slider.min) / (slider.max - slider.min) * 100;
                // JAVASCRIPT UPDATED: Changed #374151 to #d1d5db (gray-300)
                slider.style.background = `linear-gradient(to right, ${color} ${value}%, #d1d5db ${value}%)`;
            },

            // --- NEW: Generalized updateLightUI function ---
            _updateLightUI: function(state, UI) {
                if (!UI || !UI.card) return;
                const { intensity, hue } = state;
                const isOn = intensity > 0;
                const color = `hsl(${hue}, 100%, 50%)`;
                
                UI.card.style.setProperty('--light-hue', hue);
                UI.intensity.style.setProperty('--thumb-border-color', isOn ? color : '#3b82f6');

                UI.intensity.value = intensity;
                UI.colorSlider.value = hue;
                SmartHub.UIUpdater.updateSliderBackground(UI.intensity, color);
                
                if (UI.intensityTooltip) UI.intensityTooltip.textContent = `${intensity}%`;
                if (UI.colorTooltip) {
                    UI.colorTooltip.textContent = `Hue: ${hue}°`;
                    UI.colorTooltip.style.backgroundColor = color;
                }

                if (isOn) {
                    UI.card.classList.add('card-is-active');
                    UI.icon.classList.add('icon-on');
                    if (UI.statusText) UI.statusText.textContent = `${intensity}%`;
                } else {
                    UI.card.classList.remove('card-is-active');
                    UI.icon.classList.remove('icon-on');
                    if (UI.statusText) UI.statusText.textContent = "Off";
                }
                
                UI.card.setAttribute('aria-pressed', isOn ? 'true' : 'false');
            },
            
            // --- NEW: Specific callers for each light ---
            updateLivingLightUI: function() {
                SmartHub.UIUpdater._updateLightUI(SmartHub.state.livingLight, SmartHub.UI.livingLight);
                SmartHub.Persistence.saveState();
            },
            updateBedLightUI: function() {
                SmartHub.UIUpdater._updateLightUI(SmartHub.state.bedLight, SmartHub.UI.bedLight);
                SmartHub.Persistence.saveState();
            },

            updateFanUI: function() {
                const { speed } = SmartHub.state.fan;
                const isOn = speed > 0;
                const UI = SmartHub.UI.fan;
                if (!UI || !UI.card) return;
                const color = `hsl(${UI.card.style.getPropertyValue('--fan-hue') || 200}, 100%, 50%)`;
                UI.speed.value = speed;
                UI.speed.style.setProperty('--thumb-border-color', isOn ? color : '#3b82f6');
                SmartHub.UIUpdater.updateSliderBackground(UI.speed, color);
                if (UI.speedTooltip) UI.speedTooltip.textContent = `Level ${speed}`;
                if (isOn) {
                    UI.card.classList.add('card-is-active');
                    UI.icon.classList.add('icon-fan-on', 'animate-spin');
                    if (UI.statusText) UI.statusText.textContent = `Level ${speed}`;
                    const duration = Math.max(0.5, 6 - speed); 
                    UI.icon.style.animationDuration = `${duration}s`;
                } else {
                    UI.card.classList.remove('card-is-active');
                    UI.icon.classList.remove('icon-fan-on', 'animate-spin');
                    if (UI.statusText) UI.statusText.textContent = "Off";
                    UI.icon.style.animationDuration = ``;
                }
                UI.card.setAttribute('aria-pressed', isOn ? 'true' : 'false');
                SmartHub.Persistence.saveState();
            },

            // **** JAVASCRIPT FIX APPLIED HERE ****
            updateThermostatUI: function() {
                const { temperature, mode } = SmartHub.state.thermostat;
                const UI = SmartHub.UI.thermostat;
                if (!UI || !UI.card) return;
                UI.display.textContent = `${temperature}\u00B0`;
                UI.modeDisplay.textContent = `Mode: ${mode}`;
                UI.icon.classList.remove('text-red-500', 'text-blue-500', 'text-gray-500');
                UI.card.classList.remove('card-active-red', 'card-active-blue');
                
                // Reset all buttons to INACTIVE state
                UI.modeButtons.forEach(btn => {
                    // Remove all potential active BG/Border colors
                    btn.classList.remove('bg-gray-600', 'bg-red-500', 'bg-blue-500', 'bg-white', 'border-gray-700');
                    const icon = btn.querySelector('i');
                    if (icon) { 
                        // Set icon to default INACTIVE color (gray-600)
                        icon.classList.add('text-gray-600'); 
                        // Remove all potential ACTIVE icon colors
                        icon.classList.remove('text-red-500', 'text-blue-500', 'text-white', 'text-gray-900', 'text-gray-500'); 
                    }
                });
                
                let activeBtn;
                if (mode === 'Heat') { 
                    UI.icon.classList.add('text-red-500'); 
                    UI.card.classList.add('card-active-red'); 
                    activeBtn = document.getElementById('temp-mode-heat'); 
                    if (activeBtn) {
                        activeBtn.classList.add('bg-red-500'); // Active BG
                        activeBtn.querySelector('i').classList.add('text-white'); // Active Icon
                        activeBtn.querySelector('i').classList.remove('text-gray-600'); // Remove inactive
                    }
                }
                else if (mode === 'Cool') { 
                    UI.icon.classList.add('text-blue-500'); 
                    UI.card.classList.add('card-active-blue'); 
                    activeBtn = document.getElementById('temp-mode-cool'); 
                    if (activeBtn) {
                        activeBtn.classList.add('bg-blue-500'); // Active BG
                        activeBtn.querySelector('i').classList.add('text-white'); // Active Icon
                        activeBtn.querySelector('i').classList.remove('text-gray-600'); // Remove inactive
                    }
                }
                else { // mode === 'Off'
                    UI.icon.classList.add('text-gray-500');
                    activeBtn = document.getElementById('temp-mode-off'); 
                    if (activeBtn) {
                        // **** THIS IS THE FIX ****
                        // Make background white, add a border, and make icon dark
                        activeBtn.classList.add('bg-white'); // Active BG (as requested)
                        activeBtn.classList.add('border-gray-700'); // Added border for visibility
                        activeBtn.querySelector('i').classList.add('text-gray-900'); // Active Icon (dark)
                        activeBtn.querySelector('i').classList.remove('text-gray-600'); // Remove inactive
                    }
                }
                SmartHub.Persistence.saveState();
            },
            
            updateLockUI: function() {
                const { isLocked } = SmartHub.state.lock;
                const UI = SmartHub.UI.lock;
                if (!UI || !UI.card) return;
                if (isLocked) {
                    UI.iconLocked.classList.remove('hidden');
                    UI.iconUnlocked.classList.add('hidden');
                    UI.button.textContent = 'Unlock';
                    // LIGHT THEME UPDATED: Use gray-200 and gray-300
                    UI.button.classList.add('bg-gray-200', 'hover:bg-gray-300');
                    UI.button.classList.remove('bg-green-600', 'hover:bg-green-500');
                    UI.card.classList.add('card-active-red');
                    UI.card.classList.remove('card-active-green');
                } else {
                    UI.iconLocked.classList.add('hidden');
                    UI.iconUnlocked.classList.remove('hidden');
                    UI.button.textContent = 'Lock';
                    // LIGHT THEME UPDATED: Remove light gray classes
                    UI.button.classList.remove('bg-gray-200', 'hover:bg-gray-300');
                    UI.button.classList.add('bg-green-600', 'hover:bg-green-500');
                    UI.card.classList.remove('card-active-red');
                    UI.card.classList.add('card-active-green');
                }
                SmartHub.Persistence.saveState();
            },
            updateSpeakerUI: function() {
                const { isPlaying, volume, trackIndex } = SmartHub.state.speaker;
                const UI = SmartHub.UI.speaker;
                if (!UI || !UI.card) return; 
                const trackName = (SmartHub.config.playlist[trackIndex] || 'Unknown track').split('/').pop().replace('.mp3', '');
                UI.volume.value = volume;
                UI.value.textContent = `${volume}%`;
                if (UI.volumeTooltip) UI.volumeTooltip.textContent = `${volume}%`;
                SmartHub.UIUpdater.updateSliderBackground(UI.volume, '#a78bfa'); // Purple color
                UI.playButton.setAttribute('aria-label', isPlaying ? 'Pause Music' : 'Play Music');
                if (isPlaying) {
                    UI.playIcon.classList.add('hidden');
                    UI.pauseIcon.classList.remove('hidden');
                    UI.icon.classList.add('text-purple-400'); // Use same purple
                    UI.card.classList.add('card-active-purple');
                    UI.trackTitle.textContent = `Playing: ${trackName}`;
                    UI.nowIcon.classList.add('text-purple-400', 'glow-animate');
                    UI.nowText.textContent = 'Now Playing';
                    UI.nowText.classList.add('text-purple-300');
                } else {
                    UI.playIcon.classList.remove('hidden');
                    UI.pauseIcon.classList.add('hidden');
                    UI.icon.classList.remove('text-purple-400');
                    UI.card.classList.remove('card-active-purple');
                    UI.trackTitle.textContent = SmartHub.UI.audioElement && SmartHub.UI.audioElement.src ? `Paused: ${trackName}` : 'Paused';
                    UI.nowIcon.classList.remove('text-purple-400', 'glow-animate');
                    UI.nowText.textContent = 'Idle';
                    UI.nowText.classList.remove('text-purple-300');
                }
                SmartHub.Persistence.saveState();
            },
            updateActiveScene: function() {
                Object.values(SmartHub.UI.scenes).forEach(button => {
                    if (button) button.classList.remove('active');
                });
                const key = SmartHub.state.activeScene;
                if (key && SmartHub.UI.scenes[key]) SmartHub.UI.scenes[key].classList.add('active');
            },

            // --- NEW: Room Filtering Function ---
            filterDevicesByRoom: function() {
                const newRoom = SmartHub.state.currentRoom;
                const UI = SmartHub.UI.room;
                
                // Update Tab active states
                UI.tabs.forEach(tab => {
                    if (tab.dataset.room === newRoom) {
                        tab.classList.add('active');
                    } else {
                        tab.classList.remove('active');
                    }
                });

                // Filter device cards
                UI.allDevices.forEach(card => {
                    const cardRoom = card.dataset.room;
                    if (newRoom === 'all' || cardRoom === 'all' || cardRoom === newRoom) {
                        card.classList.remove('device-hidden');
                    } else {
                        card.classList.add('device-hidden');
                    }
                });
            },

            updateAllUIs: function() {
                this.updateLivingLightUI(); // UPDATED
                this.updateBedLightUI();     // UPDATED
                this.updateFanUI();
                this.updateThermostatUI();
                this.updateLockUI();
                this.updateSpeakerUI();
                this.updateActiveScene();
            }
        },
        
        // --- 9. Event Handlers Module ---
        EventHandlers: {
            registerAll: function() {
                const UI = SmartHub.UI;
                const Handlers = SmartHub.EventHandlers;

                // --- NEW: Living Room Light ---
                if (UI.livingLight.card) {
                    UI.livingLight.card.addEventListener('click', (e) => Handlers.lightCardClickHandler(e, 'livingLight'));
                    UI.livingLight.card.addEventListener('keydown', (e) => Handlers.handleCardKeyPress(e, (e) => Handlers.lightCardClickHandler(e, 'livingLight')));
                    UI.livingLight.intensity.addEventListener('input', (e) => {
                        const newValue = Number(e.target.value);
                        SmartHub.state.livingLight.intensity = newValue;
                        if (newValue > 0) { SmartHub.state.livingLight.lastKnownIntensity = newValue; }
                        SmartHub.UIUpdater.updateLivingLightUI();
                    });
                    UI.livingLight.colorSlider.addEventListener('input', (e) => { 
                        SmartHub.state.livingLight.hue = e.target.value; 
                        if (SmartHub.state.livingLight.intensity === 0) { SmartHub.state.livingLight.intensity = SmartHub.state.livingLight.lastKnownIntensity; }
                        SmartHub.UIUpdater.updateLivingLightUI(); 
                    });
                }
                
                // --- NEW: Bedroom Light ---
                if (UI.bedLight.card) {
                    UI.bedLight.card.addEventListener('click', (e) => Handlers.lightCardClickHandler(e, 'bedLight'));
                    UI.bedLight.card.addEventListener('keydown', (e) => Handlers.handleCardKeyPress(e, (e) => Handlers.lightCardClickHandler(e, 'bedLight')));
                    UI.bedLight.intensity.addEventListener('input', (e) => {
                        const newValue = Number(e.target.value);
                        SmartHub.state.bedLight.intensity = newValue;
                        if (newValue > 0) { SmartHub.state.bedLight.lastKnownIntensity = newValue; }
                        SmartHub.UIUpdater.updateBedLightUI();
                    });
                    UI.bedLight.colorSlider.addEventListener('input', (e) => { 
                        SmartHub.state.bedLight.hue = e.target.value; 
                        if (SmartHub.state.bedLight.intensity === 0) { SmartHub.state.bedLight.intensity = SmartHub.state.bedLight.lastKnownIntensity; }
                        SmartHub.UIUpdater.updateBedLightUI(); 
                    });
                }

                // --- (Fan, Thermostat, Lock, Speaker handlers are the same) ---
                if (UI.fan.card) {
                    UI.fan.card.addEventListener('click', Handlers.fanCardClickHandler);
                    UI.fan.card.addEventListener('keydown', (e) => Handlers.handleCardKeyPress(e, Handlers.fanCardClickHandler));
                    UI.fan.speed.addEventListener('input', (e) => {
                        const newValue = Number(e.target.value);
                        SmartHub.state.fan.speed = newValue;
                        if (newValue > 0) { SmartHub.state.fan.lastKnownSpeed = newValue; }
                        SmartHub.UIUpdater.updateFanUI();
                    });
                }
                if (UI.thermostat.tempUp) {
                    UI.thermostat.tempUp.addEventListener('click', () => { SmartHub.state.thermostat.temperature++; SmartHub.UIUpdater.updateThermostatUI(); });
                    UI.thermostat.tempDown.addEventListener('click', () => { SmartHub.state.thermostat.temperature--; SmartHub.UIUpdater.updateThermostatUI(); });
                    UI.thermostat.modeContainer.addEventListener('click', (e) => { 
                        const btn = e.target.closest('.temp-mode-button'); 
                        if (btn && btn.dataset.mode) { 
                            SmartHub.state.thermostat.mode = btn.dataset.mode; 
                            SmartHub.UIUpdater.updateThermostatUI(); 
                        } 
                    });
                }
                if (UI.lock.button) {
                    UI.lock.button.addEventListener('click', () => { SmartHub.state.lock.isLocked = !SmartHub.state.lock.isLocked; SmartHub.UIUpdater.updateLockUI(); });
                }
                if (UI.speaker.volume) {
                    UI.speaker.volume.addEventListener('input', (e) => SmartHub.AudioPlayer.setVolume(Number(e.target.value)));
                    UI.speaker.playButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (!SmartHub.state.speaker.isPlaying) { 
                            SmartHub.AudioPlayer.play();
                        } else {
                            SmartHub.AudioPlayer.pause();
                        }
                    });
                    UI.speaker.nextButton.addEventListener('click', (e) => { e.stopPropagation(); SmartHub.AudioPlayer.next(); });
                    UI.speaker.prevButton.addEventListener('click', (e) => { e.stopPropagation(); SmartHub.AudioPlayer.prev(); });
                }

                // --- (Scene, Modal, Ripple, Voice handlers are the same) ---
                Object.values(UI.scenes).forEach(button => { 
                    if (button) button.addEventListener('click', (e) => Handlers.runScene(e.currentTarget.dataset.scene)); 
                });
                if (UI.addDeviceCard) {
                    UI.addDeviceCard.addEventListener('click', SmartHub.Modal.open);
                    UI.addDeviceCard.addEventListener('keydown', (e) => Handlers.handleCardKeyPress(e, SmartHub.Modal.open));
                }
                if (UI.modal.closeButton) {
                    UI.modal.closeButton.addEventListener('click', SmartHub.Modal.close);
                    UI.modal.overlay.addEventListener('click', SmartHub.Modal.close);
                }
                document.querySelectorAll(".ripple-button").forEach(button => {
                    button.addEventListener("click", SmartHub.Effects.createRipple);
                });
                if (UI.voice.micButton) {
                    UI.voice.micButton.addEventListener('click', () => SmartHub.Speech.toggleListen());
                }

                // --- NEW: Room Tab Click Handler ---
                if (UI.room.tabContainer) {
                    UI.room.tabContainer.addEventListener('click', (e) => {
                        const button = e.target.closest('.room-tab-button');
                        if (button && button.dataset.room) {
                            SmartHub.state.currentRoom = button.dataset.room;
                            SmartHub.UIUpdater.filterDevicesByRoom();
                        }
                    });
                }
            },

            // --- REWRITTEN: Generalized lightCardClickHandler ---
            lightCardClickHandler: function(e, lightKey) {
                if (e.target.closest('.collapsible-controls')) return;
                
                const state = SmartHub.state[lightKey];
                const updater = lightKey === 'livingLight' ? SmartHub.UIUpdater.updateLivingLightUI : SmartHub.UIUpdater.updateBedLightUI;

                if (state.intensity > 0) {
                    state.intensity = 0;
                } else {
                    state.intensity = state.lastKnownIntensity;
                }
                updater();
            },
            
            // --- NEW: Helper for voice commands ---
            handleLightCommand: function(command, lightKey) {
                const state = SmartHub.state[lightKey];
                const parser = SmartHub.Speech.parseNumber;
                const colorMap = SmartHub.config.colorMap;
                
                const colorWord = Object.keys(colorMap).find(c => command.includes(c));
                const intensity = parser(command);
                const lightName = lightKey === 'livingLight' ? 'Living Room light' : 'Bedroom light';

                if (colorWord) {
                    state.hue = colorMap[colorWord];
                    if (state.intensity === 0) state.intensity = state.lastKnownIntensity;
                    SmartHub.Speech.showStatus(`Set ${lightName} color to ${colorWord}.`);
                } else if (intensity !== null && intensity >= 0 && intensity <= 100) {
                    state.intensity = intensity;
                    if (intensity > 0) state.lastKnownIntensity = intensity;
                    SmartHub.Speech.showStatus(`Set ${lightName} intensity to ${intensity}%.`);
                } else {
                    SmartHub.Speech.showStatus("Didn't catch that. Try 'set light to 50%' or 'set light to blue'.");
                }
            },


            fanCardClickHandler: function(e) {
                if (e.target.closest('.collapsible-controls')) return;
                if (SmartHub.state.fan.speed > 0) {
                    SmartHub.state.fan.speed = 0;
                } else {
                    SmartHub.state.fan.speed = SmartHub.state.fan.lastKnownSpeed;
                }
                SmartHub.UIUpdater.updateFanUI();
            },

            handleCardKeyPress: function(event, clickHandler) {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    clickHandler(event);
                }
            },

            runScene: function(sceneName) {
                const scene = SmartHub.config.scenes[sceneName];
                if (!scene) {
                    console.warn(`Scene "${sceneName}" not found.`);
                    return;
                }
                SmartHub.state.activeScene = sceneName;
                if (scene.updates) {
                    for (const key in scene.updates) {
                        // Check for both 'light' (old) and specific lights
                        if (SmartHub.state[key]) {
                            Object.assign(SmartHub.state[key], scene.updates[key]);
                        }
                    }
                }
                if (scene.audio) {
                    if (scene.audio.volume !== undefined) {
                        SmartHub.AudioPlayer.setVolume(scene.audio.volume);
                    }
                    if (scene.audio.play) {
                        SmartHub.AudioPlayer.play();
                    } else if (scene.audio.pause) {
                        SmartHub.AudioPlayer.pause();
                    }
                }
                SmartHub.Speech.showStatus(scene.message);
                SmartHub.UIUpdater.updateAllUIs();
            }
        },
        
        // --- 10. Modal Module (Unchanged) ---
        Modal: {
            open: function() {
                if (!SmartHub.UI.modal.overlay) return; 
                SmartHub.UI.modal.overlay.classList.remove('modal-hidden');
                SmartHub.UI.modal.box.classList.remove('modal-hidden');
                try {
                    if (window.lucide) {
                        lucide.createIcons({
                            nodes: SmartHub.UI.modal.box.querySelectorAll('[data-lucide]')
                        });
                    }
                } catch (e) {
                    console.error("Failed to create modal icons:", e);
                }
                setTimeout(() => {
                    SmartHub.UI.modal.overlay.classList.add('active');
                    SmartHub.UI.modal.box.classList.add('active');
                }, 10);
            },
            close: function() {
                if (!SmartHub.UI.modal.overlay) return;
                SmartHub.UI.modal.overlay.classList.remove('active');
                SmartHub.UI.modal.box.classList.remove('active');
                setTimeout(() => {
                    SmartHub.UI.modal.overlay.classList.add('modal-hidden');
                    SmartHub.UI.modal.box.classList.add('modal-hidden');
                }, 300);
            }
        },

        // --- 11. Effects Module (Unchanged) ---
        Effects: {
            createRipple: function(event) {
                const button = event.currentTarget;
                if (!button) return;
                const oldRipple = button.querySelector(".ripple");
                if (oldRipple) { oldRipple.remove(); }
                const circle = document.createElement("span");
                const diameter = Math.max(button.clientWidth, button.clientHeight);
                const radius = diameter / 2;
                const rect = button.getBoundingClientRect();
                circle.style.width = circle.style.height = `${diameter}px`;
                circle.style.left = `${event.clientX - rect.left - radius}px`;
                circle.style.top = `${event.clientY - rect.top - radius}px`;
                circle.classList.add("ripple");
                button.appendChild(circle);
            }
        },
        
        // --- 12. Speech Recognition & TTS Module ---
        Speech: {
            // ... (All speech functions are the same, but processCommand is now smarter)
             recognition: null,
            init: function() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    if (SmartHub.UI.voice && SmartHub.UI.voice.statusMessage) { 
                        this.showStatus("Speech recognition not supported.", 4000, false); 
                        if (SmartHub.UI.voice.micButton) {
                            SmartHub.UI.voice.micButton.disabled = true;
                            SmartHub.UI.voice.micButton.classList.add('opacity-50', 'cursor-not-allowed');
                        }
                    }
                    return;
                }
                
                this.recognition = new SpeechRecognition();
                this.recognition.continuous = false;
                this.recognition.lang = 'en-US';
                this.recognition.interimResults = false;
                this.recognition.maxAlternatives = 1;

                this.recognition.onstart = this.onStart.bind(this);
                this.recognition.onresult = this.onResult.bind(this);
                this.recognition.onspeechend = () => this.recognition.stop();
                this.recognition.onerror = this.onError.bind(this);
                this.recognition.onend = this.onEnd.bind(this);
            },
            toggleListen: function() {
                if (!this.recognition) return;
                if (SmartHub.state.listening) {
                    this.recognition.stop();
                } else {
                    try { this.recognition.start(); } 
                    catch (err) { this.showStatus("Cannot start mic. Check permissions.", 4000, false); }
                }
            },
            onStart: function() {
                if (!SmartHub.UI.voice) return;
                SmartHub.state.listening = true;
                this.showStatus("Listening...", 10000, false);
                SmartHub.UI.voice.transcriptDisplay.textContent = "";
                SmartHub.UI.voice.micButton.classList.add('animate-pulse', 'bg-red-600');
                SmartHub.UI.voice.micIcon.classList.add('hidden');
                SmartHub.UI.voice.micActiveIcon.classList.remove('hidden');
            },
            onEnd: function() {
                if (!SmartHub.UI.voice) return;
                SmartHub.state.listening = false;
                SmartHub.UI.voice.micButton.classList.remove('animate-pulse', 'bg-red-600');
                SmartHub.UI.voice.micIcon.classList.remove('hidden');
                SmartHub.UI.voice.micActiveIcon.classList.add('hidden');
            },
            onError: function(event) {
                this.showStatus(event.error === 'no-speech' ? "Didn't hear anything." : `Error: ${event.error}`, 4000, false);
            },
            onResult: function(event) {
                if (!SmartHub.UI.voice) return;
                const transcript = event.results[0][0].transcript.toLowerCase().trim();
                SmartHub.UI.voice.transcriptDisplay.textContent = `"${transcript}"`;
                this.processCommand(transcript);
            },
            speak: function(text) {
                if (!('speechSynthesis' in window)) return;
                try {
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = 'en-US';
                    window.speechSynthesis.speak(u);
                } catch (e) { console.warn('TTS failed', e); }
            },
            showStatus: function(message, duration = 4000, speakMessage = true) {
                if (SmartHub.UI.voice && SmartHub.UI.voice.statusMessage) {
                    SmartHub.UI.voice.statusMessage.textContent = message;
                }
                if (SmartHub.state.statusTimer) clearTimeout(SmartHub.state.statusTimer);
                SmartHub.state.statusTimer = setTimeout(() => {
                    if (SmartHub.UI.voice && SmartHub.UI.voice.statusMessage && SmartHub.UI.voice.statusMessage.textContent === message) {
                        SmartHub.UI.voice.statusMessage.textContent = "Tap mic to speak";
                    }
                }, duration);
                if (speakMessage) this.speak(message);
            },
            parseNumber: function(command) {
                if (!command || typeof command !== 'string') return null;
                const digitMatch = command.match(/(\d+)/);
                if (digitMatch) return parseInt(digitMatch[1], 10);
                
                const tokens = command.toLowerCase().split(/[^a-z]+/).filter(Boolean);
                let total = 0, current = 0, found = false;
                for (const t of tokens) {
                    const map = SmartHub.config.wordToNumberMap;
                    if (!(t in map)) { if (current > 0) { total += current; current = 0; } continue; }
                    found = true;
                    const val = map[t];
                    if (val === 100) current = (current || 1) * 100; else current += val;
                }
                total += current;
                return found ? total : null;
            },
            
            processCommand: function(command) {
                let processed = false;
                for (const cmd of SmartHub.config.commands) {
                    const matches = command.match(cmd.regex);
                    if (matches) {
                        cmd.handler(matches, command);
                        processed = true;
                        break;
                    }
                }
                
                if (processed) {
                    SmartHub.UIUpdater.updateAllUIs();
                } else {
                    this.showStatus("Sorry, I don't understand that command.", 4000, false);
                }
            }
        }
    };
    function updateClockAndDate() {
        const now = new Date();

        const dateStr = now.toLocaleDateString(undefined, {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric"
        });

        const timeStr = now.toLocaleTimeString(undefined, { hour12: true });

        const dateEl = document.getElementById("date-display");
        const timeEl = document.getElementById("time-display");
        const ampmEl = document.getElementById("ampm-display");

        if (dateEl) dateEl.textContent = dateStr;

        if (timeEl && ampmEl) {
          const [time, ampm] = timeStr.split(" ");
          timeEl.textContent = time;
          ampmEl.textContent = ampm || "";
        }
      }

      updateClockAndDate();
      setInterval(updateClockAndDate, 1000);
    // [FIX] Removed the entire redundant updateClockAndDate function block
    // that was here. The main SmartHub.init() function already handles
    // starting the clock and weather.
    
    </script>
</body>
</html>
