<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Smart Home Hub (V1 Effects)</title> <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <style>
        :root {
            --thumb-border-color: #3b82f6;
        }

        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* --- Dynamic Background --- */
        body {
            background-image: radial-gradient(circle at 10% 20%, rgb(30, 41, 59) 0%, rgb(17, 24, 39) 90%);
            transition: background-image 1s linear;
        }
        body.theme-morning { background-image: radial-gradient(circle at 10% 20%, rgb(90, 107, 136) 0%, rgb(45, 58, 74) 90%); }
        body.theme-evening { background-image: radial-gradient(circle at 10% 20%, rgb(71, 39, 78) 0%, rgb(28, 25, 44) 90%); }
        body.theme-night { background-image: radial-gradient(circle at 10% 20%, rgb(28, 30, 48) 0%, rgb(10, 10, 20) 90%); }

        /* --- Sliders --- */
        input[type="range"] {
            -webkit-appearance: none; appearance: none; width: 100%; height: 8px;
            background-color: #374151; border-radius: 8px; outline: none;
            transition: background 0.2s ease;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px;
            background-color: white; border-radius: 50%;
            border: 3px solid var(--thumb-border-color);
            cursor: pointer; margin-top: -6px;
            transition: all 0.2s ease;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px; height: 20px; background-color: white; border-radius: 50%;
            border: 3px solid var(--thumb-border-color);
            cursor: pointer; transition: all 0.2s ease;
        }
        input[type="range"].color-slider {
            background: linear-gradient(to right,
                #ff0000, #ff8000, #ffff00, #00ff00, #00ffff, #0000ff, #8000ff, #ff0080, #ff0000
            );
        }

        /* --- Ripple Effect --- */
        .ripple-button { position: relative; overflow: hidden; }
        .ripple {
            position: absolute; border-radius: 50%;
            transform: scale(0); animation: ripple 0.6s linear;
            background-color: rgba(255, 255, 255, 0.4);
            pointer-events: none;
        }
        @keyframes ripple { to { transform: scale(4); opacity: 0; } }

        /* --- Buttons --- */
        .temp-button {
            width: 3rem; height: 3rem; border-radius: 9999px; background-color: #374151; color: white;
            display: flex; align-items: center; justify-content: center; font-size: 1.875rem; font-weight: bold;
            transition: all 150ms;
        }
        .temp-button:active { background-color: #4B5563; transform: scale(0.95); }

        .scene-button {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 1rem; border-radius: .5rem; background-color: rgba(31,41,55,0.7);
            border: 1px solid rgba(55,65,81,0.5); backdrop-filter: blur(8px); color: #D1D5DB; transition: 200ms;
            width: 140px; flex-shrink: 0;
        }
        .scene-button:hover { background-color: rgba(55,65,81,0.8); color:white; }
        .scene-button.active { background-color: rgba(37,99,235,0.9); color:white; border-color:#3B82F6; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }

        /* --- Icons --- */
        .icon-on { color: hsl(var(--light-hue,60),100%,50%); filter: drop-shadow(0 0 8px hsl(var(--light-hue,60),100%,50%)); }
        .icon-locked { color: #EF4444; }
        .icon-unlocked { color: #10B981; }
        #fan-icon { will-change: transform; }

        @keyframes glow { /* Kept for speaker 'Now Playing' icon */
            0%,100% { filter: drop-shadow(0 0 6px var(--glow-color, #3b82f6)); }
            50% { filter: drop-shadow(0 0 12px var(--glow-color, #3b82f6)); }
        }
        .glow-animate {
            animation: glow 1.5s infinite;
        }

        /* --- Device Card --- */
        .device-card {
            transition: transform 0.2s ease-in-out, border-color 0.3s ease; /* Adjusted transition */
        }
        .device-card:hover:not(:has(input:focus)):not(:has(button:focus)) {
            transform: translateY(-4px) scale(1.02);
            border-color: rgba(107, 114, 128, 0.7);
            /* Removed box-shadow on hover to match V1's simpler style */
        }

        /* --- Card Active States (V1 Style: Border Only) --- */
        /* Light card border is set dynamically via JS */
        .card-active-blue { /* Thermostat Cool */
            border-color: #3b82f6; /* Tailwind blue-500 */
        }
        .card-active-red { /* Thermostat Heat / Lock Locked */
            border-color: #ef4444; /* Tailwind red-500 */
        }
        .card-active-green { /* Lock Unlocked */
            border-color: #10b981; /* Tailwind green-500 */
        }
        .card-active-cyan { /* Fan */
            border-color: #22d3ee; /* cyan-400 */
        }
        .card-active-purple { /* Speaker */
            border-color: #a78bfa; /* violet-400 */
        }

        /* --- Add Device Button --- */
        @keyframes pulse-border {
            0%, 100% { border-color: rgba(107, 114, 128, 0.7); }
            50% { border-color: rgba(59, 130, 246, 0.9); }
        }
        #add-device-button { animation: pulse-border 2.5s infinite; }

        /* --- Modal --- */
        .modal-hidden { display: none; }
        #modal-overlay {
            position: fixed; inset: 0;
            background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px);
            opacity: 0; transition: opacity 0.3s ease; z-index: 40;
        }
        #modal-overlay.active { opacity: 1; }
        #modal-box {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background-color: #1f2937; color: white;
            border-radius: 0.75rem; border: 1px solid #4b5563;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
            padding: 1.5rem; width: 90%; max-width: 512px;
            opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease; z-index: 50;
        }
        #modal-box.active { opacity: 1; transform: translate(-50%, -50%) scale(1); }

        /* --- Slider Tooltip --- */
        .slider-tooltip {
            position: absolute; background-color: #3b82f6;
            color: white; font-weight: 600; padding: 4px 8px;
            border-radius: 4px; font-size: 0.875rem;
            bottom: 30px; left: 50%;
            transform: translateX(-50%);
            pointer-events: none; opacity: 0;
            transition: opacity 0.2s ease, bottom 0.2s ease;
            white-space: nowrap; z-index: 10;
        }
        .slider-container:has(input[type="range"]:active) .slider-tooltip {
            opacity: 1; bottom: 40px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-sans antialiased min-h-screen flex flex-col">

    <main class="flex-grow p-4 md:p-8">
        <header class="mb-8 flex justify-between items-center max-w-7xl mx-auto">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold">Smart Hub</h1>
                <p id="date-display" class="text-lg text-gray-400">Loading date...</p>
            </div>
            <div class="text-right flex items-center gap-4">
                <div class="flex gap-3 justify-end items-center">
                    <i data-lucide="cloud-sun" class="w-10 h-10 text-yellow-400" id="weather-icon"></i>
                    <div>
                        <div id="weather-temp" class="text-2xl font-bold">--&deg;F</div>
                        <div id="weather-desc" class="text-sm text-gray-400">Loading...</div>
                    </div>
                </div>
                <div>
                    <div id="time-display" class="text-3xl md:text-4xl font-bold">--:--:--</div>
                    <div id="ampm-display" class="text-lg text-gray-400">&nbsp;</div>
                </div>
            </div>
        </header>

        <section class="max-w-7xl mx-auto mb-8">
            <h2 class="text-2xl font-semibold mb-4">Scenes</h2>
            <div class="flex overflow-x-auto gap-4 pb-4">
                <button id="scene-good-morning" class="scene-button ripple-button" data-scene="goodMorning">
                    <i data-lucide="sunrise" class="mb-2"></i>
                    <span class="pointer-events-none">Good Morning</span>
                </button>
                <button id="scene-movie-night" class="scene-button ripple-button" data-scene="movieNight">
                    <i data-lucide="film" class="mb-2"></i>
                    <span class="pointer-events-none">Movie Night</span>
                </button>
                <button id="scene-good-night" class="scene-button ripple-button" data-scene="goodNight">
                    <i data-lucide="moon" class="mb-2"></i>
                    <span class="pointer-events-none">Good Night</span>
                </button>
                <button id="scene-all-off" class="scene-button ripple-button" data-scene="allOff">
                    <i data-lucide="power-off" class="mb-2"></i>
                    <span class="pointer-events-none">All Off</span>
                </button>
                <button class="scene-button ripple-button" data-scene="party">
                    <i data-lucide="music" class="mb-2"></i>
                    <span class="pointer-events-none">Party Time</span>
                </button>
                <button class="scene-button ripple-button" data-scene="focus">
                    <i data-lucide="brain" class="mb-2"></i>
                    <span class="pointer-events-none">Focus Mode</span>
                </button>
            </div>
        </section>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-7xl mx-auto">
            <div id="light-card" class="device-card bg-gray-800/70 backdrop-blur-lg border border-gray-700/50 rounded-xl shadow-lg p-6 cursor-pointer" style="--light-hue: 200;"
                 role="button" tabindex="0" aria-pressed="false" aria-label="Living Room Light toggle">
                <div class="flex justify-between items-center mb-4 pointer-events-none">
                    <div class="flex items-center space-x-3">
                        <i id="light-icon" data-lucide="lightbulb" class="w-7 h-7 text-gray-500 transition-all duration-300"></i>
                        <h2 class="text-2xl font-semibold">Living Room Light</h2>
                    </div>
                </div>
                <div id="light-controls" class="space-y-3 transition-opacity duration-300">
                    <label for="light-intensity" class="block text-sm font-medium text-gray-400">Intensity</label>
                    <div class="slider-container relative">
                        <input type="range" id="light-intensity" min="0" max="100" value="50" class="w-full" aria-label="Light intensity">
                        <div class="slider-tooltip" id="light-intensity-tooltip">50%</div>
                    </div>
                    <div id="light-intensity-value" class="text-center text-lg font-medium">50%</div>
                </div>
                <div id="light-color-controls" class="space-y-3 mt-4 transition-opacity duration-300">
                    <label for="light-color" class="block text-sm font-medium text-gray-400">Color</label>
                    <div class="slider-container relative">
                        <input type="range" id="light-color" min="0" max="360" value="200" class="w-full color-slider" aria-label="Light color">
                        <div class="slider-tooltip" id="light-color-tooltip" style="background-color: hsl(200, 100%, 50%)">Hue: 200°</div>
                    </div>
                </div>
            </div>

            <div id="fan-card" class="device-card bg-gray-800/70 backdrop-blur-lg border border-gray-700/50 rounded-xl shadow-lg p-6 cursor-pointer"
                 role="button" tabindex="0" aria-pressed="false" aria-label="Bedroom Fan toggle">
                <div class="flex justify-between items-center mb-4 pointer-events-none">
                    <div class="flex items-center space-x-3">
                        <i id="fan-icon" data-lucide="fan" class="w-7 h-7 text-gray-500 transition-all duration-300"></i>
                        <h2 class="text-2xl font-semibold">Bedroom Fan</h2>
                    </div>
                </div>
                <div id="fan-controls" class="space-y-3 transition-opacity duration-300">
                    <label for="fan-speed" class="block text-sm font-medium text-gray-400">Speed</label>
                    <div class="slider-container relative">
                        <input type="range" id="fan-speed" min="0" max="5" value="2" step="1" class="w-full" aria-label="Fan speed">
                        <div class="slider-tooltip" id="fan-speed-tooltip">Level 2</div>
                    </div>
                    <div id="fan-speed-value" class="text-center text-lg font-medium">Level 2</div>
                </div>
            </div>

            <div id="thermostat-card" class="device-card bg-gray-800/70 backdrop-blur-lg border border-gray-700/50 rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center space-x-3">
                        <i id="thermostat-icon" data-lucide="thermometer" class="w-7 h-7 text-gray-500 transition-colors duration-300"></i>
                        <h2 class="text-2xl font-semibold">Thermostat</h2>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <button id="temp-down" class="temp-button ripple-button" aria-label="Temperature Down">-</button>
                    <div class="text-center">
                        <div id="temp-display" class="text-6xl font-bold">68&deg;</div>
                        <div id="temp-mode-display" class="text-lg text-gray-400">Off</div>
                    </div>
                    <button id="temp-up" class="temp-button ripple-button" aria-label="Temperature Up">+</button>
                </div>
                <div id="temp-mode-container" class="flex justify-around mt-4">
                    <button id="temp-mode-heat" class="temp-mode-button ripple-button p-2 rounded-lg" data-mode="Heat" aria-label="Set Heat Mode"><i data-lucide="flame" class="w-6 h-6 text-gray-500 pointer-events-none transition-colors"></i></button>
                    <button id="temp-mode-cool" class="temp-mode-button ripple-button p-2 rounded-lg" data-mode="Cool" aria-label="Set Cool Mode"><i data-lucide="snowflake" class="w-6 h-6 text-gray-500 pointer-events-none transition-colors"></i></button>
                    <button id="temp-mode-off" class="temp-mode-button ripple-button p-2 rounded-lg bg-gray-600" data-mode="Off" aria-label="Set Mode Off"><i data-lucide="power" class="w-6 h-6 text-white pointer-events-none transition-colors"></i></button>
                </div>
            </div>

            <div id="lock-card" class="device-card bg-gray-800/70 backdrop-blur-lg border border-gray-700/50 rounded-xl shadow-lg p-6 card-active-red"> <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center space-x-3">
                        <i id="lock-icon-locked" data-lucide="lock" class="w-7 h-7 icon-locked transition-all duration-300"></i>
                        <i id="lock-icon-unlocked" data-lucide="lock-open" class="w-7 h-7 icon-unlocked transition-all duration-300 hidden"></i>
                        <h2 class="text-2xl font-semibold">Front Door</h2>
                    </div>
                </div>
                <button id="lock-toggle-button" class="w-full h-24 rounded-lg text-2xl font-semibold transition-colors duration-200 ripple-button bg-gray-700 hover:bg-gray-600">
                    Unlock
                </button>
            </div>

            <div id="speaker-card" class="device-card bg-gray-800/70 backdrop-blur-lg border border-gray-700/50 rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center space-x-3">
                        <i id="speaker-icon" data-lucide="volume-2" class="w-7 h-7 text-gray-500 transition-colors duration-300"></i>
                        <h2 class="text-2xl font-semibold">Living Room Speaker</h2>
                    </div>
                </div>
                <div id="speaker-controls" class="space-y-3">
                    <label for="speaker-volume" class="block text-sm font-medium text-gray-400">Volume</label>
                    <div class="slider-container relative">
                        <input type="range" id="speaker-volume" min="0" max="100" value="30" class="w-full" aria-label="Speaker volume">
                        <div class="slider-tooltip" id="speaker-volume-tooltip">30%</div>
                    </div>
                    <div id="speaker-volume-value" class="text-center text-lg font-medium">30%</div>
                </div>
                <div class="mt-4 text-center">
                    <div id="track-title" class="text-lg text-gray-300 mb-2 h-6 truncate">Paused</div>
                    <div class="relative w-full h-1 bg-gray-700 rounded-full my-3 group cursor-pointer" id="progress-bar-container">
                        <div id="track-progress" class="absolute h-1 bg-purple-500 rounded-full" style="width: 0%;"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-400">
                        <span id="track-current-time">0:00</span>
                        <span id="track-duration">0:00</span>
                    </div>
                    <div class="flex justify-center items-center space-x-4 mt-2">
                        <button id="prev-track" class="p-3 rounded-full bg-gray-700 hover:bg-gray-600 transition-all shadow-md hover:scale-110 ripple-button" aria-label="Previous Track"><i data-lucide="skip-back" class="w-6 h-6 pointer-events-none"></i></button>
                        <button id="play-pause" class="p-4 rounded-full bg-blue-600 hover:bg-blue-700 transition-all transform hover:scale-110 shadow-lg ripple-button" aria-label="Play Music">
                            <i id="play-icon" data-lucide="play" class="w-7 h-7 pointer-events-none"></i>
                            <i id="pause-icon" data-lucide="pause" class="w-7 h-7 pointer-events-none hidden"></i>
                        </button>
                        <button id="next-track" class="p-3 rounded-full bg-gray-700 hover:bg-gray-600 transition-all shadow-md hover:scale-110 ripple-button" aria-label="Next Track"><i data-lucide="skip-forward" class="w-6 h-6 pointer-events-none"></i></button>
                    </div>
                    <div class="mt-3 flex justify-center items-center space-x-2">
                        <i id="now-playing-icon" data-lucide="radio" class="w-5 h-5 text-gray-500 transition-all duration-300" style="--glow-color: #a78bfa;"></i>
                        <span id="now-playing-text" class="text-sm text-gray-400">Idle</span>
                    </div>
                </div>
            </div>

            <div id="add-device-button" class="device-card bg-gray-800/70 backdrop-blur-lg border border-dashed border-gray-700/50 rounded-xl shadow-lg p-6 flex items-center justify-center cursor-pointer"
                 role="button" tabindex="0" aria-label="Add new device">
                <div class="text-center text-gray-500 pointer-events-none">
                    <i data-lucide="plus-circle" class="w-12 h-12 mb-2 inline-block"></i>
                    <p>Add New Device</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="sticky bottom-0 bg-gray-900/80 backdrop-blur-md p-4 w-full border-t border-gray-700/50 z-20">
        <div class="max-w-3xl mx-auto flex flex-col items-center space-y-3">
            <div id="status-message" class="text-gray-400 text-sm h-5 transition-opacity">Tap mic to speak</div>
            <button id="mic-button" class="bg-blue-600 hover:bg-blue-700 text-white p-5 rounded-full shadow-lg transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-500/50 ripple-button"
                    aria-label="Activate voice control">
                <i id="mic-icon" data-lucide="mic" class="w-7 h-7"></i>
                <i id="mic-active-icon" data-lucide="radio" class="w-7 h-7 hidden"></i>
            </button>
            <p id="transcript-display" class="text-center text-gray-300 min-h-[1.5em] text-lg px-4"></p>
        </div>
    </footer>

    <audio id="audio-player" preload="metadata"></audio>
    <audio id="audio-click" preload="auto" src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//tQwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAZGVoAAAAgAAAAREBBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8DzPQ//tQwRAAlwAACpAAAAP/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////8AAAAAAAADyAABQIR0ADSIAY2BsoBBNpgAAAYEUQCgKAABsxUQCgAB/gRqAR2AAAYEQCgGgAF/hpkAR0BCAYEQAgGgAF/hpkAR0BCQYEQAgGgAF/hpkAR0BCT//tQwRMAHAAACPAED/8EHAAAECQcABwgYBgYFAAABsxQRCgAANVUAQgECAQUCgYEOAYeBPIBA3kDmQGhAQMBBgWBgoEBgYKYobVAQgEBAQABAwEBAYGChQGBgEBAAEDAAAECgQGAgABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVIndiamEAAAAPAAAACAAADSAAAAAPAAAACAAADSAAAAAPAAAACAAADSAAAAAPAAAACAAADSAAD/tQwQcAJwAACNABA//EGGAAAECQcABwgYBgYFAAABsxQRCgAANVUAQgECAQUCgYEOAYeBPIBA3kDmQGhAQMBBgWBgoEBgYKYobVAQgEBAQABAwEBAYGChQGBgEBAAEDAAAECgQGAgABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVTAAAAAAAADyAAAAAAAAAAEAAAJiZmFtaWx5AAAAAAAAAABMYXZjNTguNzYuMTAwAAAAAAAAAAAAAAAAAAAAAAD/mZzAzAAAADv/7UMIJwP/9P/9AAGjABwA3bW1BAAggAATYwEQFADEQAAdjd1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1c="></audio>
    <audio id="audio-toggle" preload="auto" src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//tQwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAZGVoAAAAgAAAAREBBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8DzPQ//tQwRMAHgAACpAAAAP/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////8AAAAAAAADyAABQIR0ADSIAY2BsoBBNpgAAAYEUQCgKAABsxUQCgAB/gRqAR2AAAYEQCgGgAF/hpkAR0BCAYEQAgGgAF/hpkAR0BCQYEQAgGgAF/hpkAR0BCT//tQwROAHAAACPAED/8EHAAAECQcABwgYBgYFAAABsxQRCgAANVUAQgECAQUCgYEOAYeBPIBA3kDmQGhAQMBBgWBgoEBgYKYobVAQgEBAQABAwEBAYGChQGBgEBAAEDAAAECgQGAgABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVIndiamEAAAAPAAAACAAADSAAAAAPAAAACAAADSAAAAAPAAAACAAADSAAAAAPAAAACAAADSAAD/Type/7UMFPAAABuAACNABA//EGGAAAECQcABwgYBgYFAAABsxQRCgAANVUAQgECAQUCgYEOAYeBPIBA3kDmQGhAQMBBgWBgoEBgYKYobVAQgEBAQABAwEBAYGChQGBgEBAAEDAAAECgQGAgABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV"></audio>

    <div id="modal-overlay" class="modal-hidden"></div>
    <div id="modal-box" class="modal-hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-semibold">Add New Device</h2>
            <button id="modal-close-button" class="p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white ripple-button" aria-label="Close modal">
                <i data-lucide="x" class="w-6 h-6 pointer-events-none"></i>
            </button>
        </div>
        <p class="text-gray-300 mb-6">Select a device type to add. (Demo only).</p>
        <div class="grid grid-cols-2 gap-4">
            <button class="scene-button ripple-button"><i data-lucide="lightbulb" class="mb-2"></i><span>Smart Light</span></button>
            <button class="scene-button ripple-button"><i data-lucide="plug" class="mb-2"></i><span>Smart Plug</span></button>
            <button class="scene-button ripple-button"><i data-lucide="camera" class="mb-2"></i><span>Camera</span></button>
            <button class="scene-button ripple-button"><i data-lucide="lock" class="mb-2"></i><span>Door Lock</span></button>
        </div>
    </div>

    <script>
    /**
     * Main application namespace.
     */
    const SmartHub = {
        // --- Application State ---
        state: {
            light: { intensity: 50, lastKnownIntensity: 50, hue: 200 },
            fan: { speed: 2, lastKnownSpeed: 2 },
            thermostat: { temperature: 68, mode: 'Off' },
            lock: { isLocked: true },
            speaker: { isPlaying: false, volume: 30, trackIndex: 0 },
            activeScene: null,
            statusTimer: null,
            listening: false
        },
        // --- Configuration ---
        config: {
            storageKey: 'smartHubState_v2_v1fx', // Updated key for this version
            playlist: [
                'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
                'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',
                'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3'
            ],
            colorMap: { red: 0, orange: 30, yellow: 60, green: 120, cyan: 180, blue: 240, purple: 270, magenta: 300, pink: 330 },
            wordToNumberMap: { 'zero':0,'oh':0,'one':1,'two':2,'three':3,'four':4,'five':5,'six':6,'seven':7,'eight':8,'nine':9,'ten':10,'eleven':11,'twelve':12,'thirteen':13,'fourteen':14,'fifteen':15,'sixteen':16,'seventeen':17,'eighteen':18,'nineteen':19,'twenty':20,'thirty':30,'forty':40,'fifty':50,'sixty':60,'seventy':70,'eighty':80,'ninety':90,'hundred':100,'a':1 }
        },

        // --- UI Elements Cache ---
        UI: {
            cache: function() {
                this.body = document.body;
                this.timeDisplay = document.getElementById('time-display');
                this.ampmDisplay = document.getElementById('ampm-display');
                this.dateDisplay = document.getElementById('date-display');
                this.weather = {
                     icon: document.getElementById('weather-icon'),
                     temp: document.getElementById('weather-temp'),
                     desc: document.getElementById('weather-desc')
                };
                this.light = {
                    card: document.getElementById('light-card'),
                    intensity: document.getElementById('light-intensity'),
                    value: document.getElementById('light-intensity-value'),
                    icon: document.getElementById('light-icon'),
                    colorSlider: document.getElementById('light-color'),
                    intensityTooltip: document.getElementById('light-intensity-tooltip'),
                    colorTooltip: document.getElementById('light-color-tooltip')
                };
                this.fan = {
                    card: document.getElementById('fan-card'),
                    speed: document.getElementById('fan-speed'),
                    value: document.getElementById('fan-speed-value'),
                    icon: document.getElementById('fan-icon'),
                    speedTooltip: document.getElementById('fan-speed-tooltip')
                };
                this.thermostat = {
                    card: document.getElementById('thermostat-card'),
                    display: document.getElementById('temp-display'),
                    modeDisplay: document.getElementById('temp-mode-display'),
                    icon: document.getElementById('thermostat-icon'),
                    tempUp: document.getElementById('temp-up'),
                    tempDown: document.getElementById('temp-down'),
                    modeContainer: document.getElementById('temp-mode-container'),
                    modeButtons: document.querySelectorAll('.temp-mode-button')
                };
                this.lock = {
                    card: document.getElementById('lock-card'),
                    iconLocked: document.getElementById('lock-icon-locked'),
                    iconUnlocked: document.getElementById('lock-icon-unlocked'),
                    button: document.getElementById('lock-toggle-button'),
                };
                this.speaker = {
                    card: document.getElementById('speaker-card'),
                    icon: document.getElementById('speaker-icon'),
                    volume: document.getElementById('speaker-volume'),
                    value: document.getElementById('speaker-volume-value'),
                    volumeTooltip: document.getElementById('speaker-volume-tooltip'),
                    playButton: document.getElementById('play-pause'),
                    playIcon: document.getElementById('play-icon'),
                    pauseIcon: document.getElementById('pause-icon'),
                    prevButton: document.getElementById('prev-track'),
                    nextButton: document.getElementById('next-track'),
                    trackTitle: document.getElementById('track-title'),
                    progressBarContainer: document.getElementById('progress-bar-container'),
                    trackProgress: document.getElementById('track-progress'),
                    trackCurrentTime: document.getElementById('track-current-time'),
                    trackDuration: document.getElementById('track-duration'),
                    nowIcon: document.getElementById('now-playing-icon'),
                    nowText: document.getElementById('now-playing-text')
                };
                this.scenes = document.querySelectorAll('.scene-button');
                this.voice = {
                    micButton: document.getElementById('mic-button'),
                    micIcon: document.getElementById('mic-icon'),
                    micActiveIcon: document.getElementById('mic-active-icon'),
                    statusMessage: document.getElementById('status-message'),
                    transcriptDisplay: document.getElementById('transcript-display')
                };
                this.audio = {
                    player: document.getElementById('audio-player'),
                    click: document.getElementById('audio-click'),
                    toggle: document.getElementById('audio-toggle')
                };
                this.modal = {
                    overlay: document.getElementById('modal-overlay'),
                    box: document.getElementById('modal-box'),
                    closeButton: document.getElementById('modal-close-button'),
                    addButton: document.getElementById('add-device-button')
                };
            },
            showModal: function() {
                // ... (modal logic remains the same)
                 if (!this.modal.overlay || !this.modal.box) return;
                this.modal.overlay.classList.remove('modal-hidden');
                this.modal.box.classList.remove('modal-hidden');
                setTimeout(() => {
                    this.modal.overlay.classList.add('active');
                    this.modal.box.classList.add('active');
                    if (window.lucide) {
                        lucide.createIcons({ nodes: this.modal.box.querySelectorAll('[data-lucide]')});
                    }
                }, 10);
            },
            hideModal: function() {
                // ... (modal logic remains the same)
                if (!this.modal.overlay || !this.modal.box) return;
                this.modal.overlay.classList.remove('active');
                this.modal.box.classList.remove('active');
                setTimeout(() => {
                    this.modal.overlay.classList.add('modal-hidden');
                    this.modal.box.classList.add('modal-hidden');
                }, 300);
            }
        },

        // --- State Persistence (LocalStorage) ---
        Persistence: {
            save: function() {
                 try {
                    const stateToSave = { ...SmartHub.state };
                    delete stateToSave.statusTimer;
                    delete stateToSave.listening;
                    localStorage.setItem(SmartHub.config.storageKey, JSON.stringify(stateToSave));
                } catch (e) {
                    console.warn("Could not save state to localStorage", e);
                }
            },
            load: function() {
                try {
                    const savedState = localStorage.getItem(SmartHub.config.storageKey);
                    if (savedState) {
                        const parsedState = JSON.parse(savedState);
                        Object.assign(SmartHub.state, parsedState);
                    }
                    SmartHub.state.listening = false;
                    SmartHub.state.statusTimer = null;
                    SmartHub.state.activeScene = null;
                } catch (e) {
                    console.warn("Could not load state from localStorage", e);
                }
            }
        },

        // --- Clock, Weather & Background Module ---
        Clock: {
            // ... (Clock logic remains the same)
             intervalId: null,
            init: function() {
                this.update();
                this.updateWeather();
                this.intervalId = setInterval(() => this.update(), 1000);
                setInterval(() => this.updateWeather(), 600000);
            },
            update: function() {
                const now = new Date();
                const ui = SmartHub.UI;
                if (ui.dateDisplay) {
                    ui.dateDisplay.textContent = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                }
                let hours = now.getHours();
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const seconds = now.getSeconds().toString().padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12; hours = hours ? hours : 12;
                const displayHours = hours.toString().padStart(2, ' ');
                if (ui.timeDisplay) ui.timeDisplay.textContent = `${displayHours}:${minutes}:${seconds}`;
                if (ui.ampmDisplay) ui.ampmDisplay.textContent = ampm;

                const currentHour = now.getHours();
                const body = ui.body;
                let newTheme = 'theme-day';
                if (currentHour >= 5 && currentHour < 10) newTheme = 'theme-morning';
                else if (currentHour >= 17 && currentHour < 21) newTheme = 'theme-evening';
                else if (currentHour >= 21 || currentHour < 5) newTheme = 'theme-night';

                if (!body.classList.contains(newTheme)) {
                    body.classList.remove('theme-morning', 'theme-day', 'theme-evening', 'theme-night');
                    body.classList.add(newTheme);
                }
            },
             updateWeather: function() {
                const weatherOptions = [
                    { desc: 'Sunny', icon: 'sun', color: 'text-yellow-400', tempBase: 75 },
                    { desc: 'Partly Cloudy', icon: 'cloud-sun', color: 'text-yellow-400', tempBase: 72 },
                    { desc: 'Cloudy', icon: 'cloud', color: 'text-blue-300', tempBase: 68 },
                    { desc: 'Overcast', icon: 'cloudy', color: 'text-gray-400', tempBase: 65 },
                    { desc: 'Rain', icon: 'cloud-rain', color: 'text-blue-400', tempBase: 62 },
                ];
                const uiWeather = SmartHub.UI.weather;
                if (!uiWeather.icon || !uiWeather.temp || !uiWeather.desc) return;
                const randIndex = Math.floor(Math.random() * weatherOptions.length);
                const chosenWeather = weatherOptions[randIndex];
                const tempFluctuation = Math.floor(Math.random() * 5) - 2;
                const displayTemp = chosenWeather.tempBase + tempFluctuation;
                uiWeather.icon.setAttribute('data-lucide', chosenWeather.icon);
                uiWeather.icon.className = `w-10 h-10 ${chosenWeather.color}`;
                uiWeather.temp.innerHTML = `${displayTemp}&deg;F`;
                uiWeather.desc.textContent = chosenWeather.desc;
                if (window.lucide) { lucide.createIcons({ nodes: [uiWeather.icon] }); }
            }
        },

        // --- Audio Player Module ---
        AudioPlayer: {
             // ... (AudioPlayer logic remains the same)
             el: null,
            init: function() {
                this.el = SmartHub.UI.audio.player;
                if (!this.el) { console.warn("Audio player element not found."); return; }
                this.el.volume = SmartHub.state.speaker.volume / 100;
                this.el.addEventListener('ended', () => this.next());
                this.el.addEventListener('play', () => { SmartHub.state.speaker.isPlaying = true; SmartHub.UIUpdater.updateSpeakerUI(); });
                this.el.addEventListener('pause', () => { SmartHub.state.speaker.isPlaying = false; SmartHub.UIUpdater.updateSpeakerUI(); });
                this.el.addEventListener('timeupdate', () => this.updateProgress());
                this.el.addEventListener('loadedmetadata', () => this.updateProgress());
                if (SmartHub.config.playlist.length) { this.loadTrack(SmartHub.state.speaker.trackIndex, false); }
            },
            loadTrack: function(index, shouldSaveState = true) {
                if (!this.el) return;
                const playlist = SmartHub.config.playlist;
                if (!playlist || playlist.length === 0) return;
                SmartHub.state.speaker.trackIndex = ((index % playlist.length) + playlist.length) % playlist.length;
                const file = playlist[SmartHub.state.speaker.trackIndex];
                const trackName = file.split('/').pop().replace('.mp3', '');
                this.el.src = file; this.el.load();
                SmartHub.UI.speaker.trackTitle.textContent = trackName;
                if (shouldSaveState) SmartHub.Persistence.save();
                this.updateProgress();
            },
            play: function() {
                if (!this.el) return;
                if (!this.el.src && SmartHub.config.playlist.length > 0) { this.loadTrack(SmartHub.state.speaker.trackIndex); }
                const playPromise = this.el.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.warn("Audio playback error:", error);
                        SmartHub.Speech.showStatus('Tap play to enable audio playback.', 4000, false);
                        SmartHub.state.speaker.isPlaying = false; SmartHub.UIUpdater.updateSpeakerUI();
                    });
                }
            },
            pause: function() { if (this.el) this.el.pause(); },
            next: function() { this.loadTrack(SmartHub.state.speaker.trackIndex + 1); this.play(); SmartHub.Speech.showStatus('Skipped to next track', 2000, false); },
            prev: function() { this.loadTrack(SmartHub.state.speaker.trackIndex - 1); this.play(); SmartHub.Speech.showStatus('Playing previous track', 2000, false); },
            setVolume: function(v) {
                if (!this.el) return;
                const value = Math.max(0, Math.min(100, Number(v)));
                SmartHub.state.speaker.volume = value; this.el.volume = value / 100;
                SmartHub.UIUpdater.updateSpeakerUI();
            },
             seek: function(event) {
                if (!this.el || isNaN(this.el.duration)) return;
                const progressBar = SmartHub.UI.speaker.progressBarContainer;
                const rect = progressBar.getBoundingClientRect();
                const offsetX = event.clientX - rect.left;
                const width = progressBar.offsetWidth;
                const seekTime = (offsetX / width) * this.el.duration;
                this.el.currentTime = Math.max(0, Math.min(seekTime, this.el.duration));
            },
            updateProgress: function() {
                if (!this.el) return;
                const { currentTime, duration } = this.el; const ui = SmartHub.UI.speaker;
                if (isNaN(duration) || duration <= 0) {
                    ui.trackProgress.style.width = '0%'; ui.trackCurrentTime.textContent = '0:00'; ui.trackDuration.textContent = '0:00'; return;
                }
                const formatTime = (timeInSeconds) => {
                    const minutes = Math.floor(timeInSeconds / 60);
                    const seconds = Math.floor(timeInSeconds % 60).toString().padStart(2, '0');
                    return `${minutes}:${seconds}`;
                };
                const progressPercent = (currentTime / duration) * 100;
                ui.trackProgress.style.width = `${progressPercent}%`;
                ui.trackCurrentTime.textContent = formatTime(currentTime);
                ui.trackDuration.textContent = formatTime(duration);
            },
            playEffect: function(soundId) {
                const audioEl = SmartHub.UI.audio[soundId];
                if (audioEl) { audioEl.currentTime = 0; audioEl.play().catch(e => {}); }
            }
        },

        // --- Slider Tooltip Module ---
        SliderTooltip: {
             // ... (SliderTooltip logic remains the same)
             init: function() {
                const sliders = document.querySelectorAll('input[type="range"]');
                sliders.forEach(slider => {
                    const container = slider.closest('.slider-container');
                    const tooltip = container ? container.querySelector('.slider-tooltip') : null;
                    if (tooltip) {
                        slider.addEventListener('input', () => this.update(slider, tooltip));
                        this.update(slider, tooltip); // Initial update
                    }
                });
                 window.addEventListener('resize', () => this.updateAllTooltips());
            },
             updateAllTooltips: function() {
                const sliders = document.querySelectorAll('input[type="range"]');
                sliders.forEach(slider => {
                    const container = slider.closest('.slider-container');
                    const tooltip = container ? container.querySelector('.slider-tooltip') : null;
                    if (tooltip) { this.update(slider, tooltip); }
                });
            },
            update: function(slider, tooltip) {
                const value = parseFloat(slider.value); const min = parseFloat(slider.min); const max = parseFloat(slider.max);
                const percent = (max === min) ? 0 : (value - min) / (max - min); // Avoid division by zero
                if (slider.id === 'light-intensity') tooltip.textContent = `${Math.round(value)}%`;
                else if (slider.id === 'light-color') {
                    tooltip.textContent = `Hue: ${Math.round(value)}°`; tooltip.style.backgroundColor = `hsl(${value}, 100%, 50%)`;
                }
                else if (slider.id === 'fan-speed') tooltip.textContent = `Level ${value}`;
                else if (slider.id === 'speaker-volume') tooltip.textContent = `${Math.round(value)}%`;
                const sliderWidth = slider.offsetWidth; const thumbWidth = 20;
                const trackWidth = sliderWidth - thumbWidth; const thumbCenterPosition = (percent * trackWidth) + (thumbWidth / 2);
                tooltip.style.left = `${thumbCenterPosition}px`;
            }
        },

        // --- UI Updater Module (Handles visual updates based on state) ---
        UIUpdater: {
            updateSliderBackground: function(slider, color = '#3b82f6') {
                 if (!slider) return;
                const value = (slider.max === slider.min) ? 0 : (slider.value - slider.min) / (slider.max - slider.min) * 100;
                slider.style.background = `linear-gradient(to right, ${color} ${value}%, #374151 ${value}%)`;
            },
            // --- MODIFIED: Light UI Update (Border only, no shadow) ---
            updateLightUI: function() {
                const { intensity, hue } = SmartHub.state.light;
                const isOn = intensity > 0;
                const ui = SmartHub.UI.light;
                if (!ui.card) return;
                const activeColor = `hsl(${hue},100%,50%)`;

                ui.card.style.setProperty('--light-hue', hue);
                ui.intensity.style.setProperty('--thumb-border-color', activeColor);
                ui.intensity.value = intensity;
                ui.value.textContent = `${intensity}%`;
                ui.colorSlider.value = hue;
                this.updateSliderBackground(ui.intensity, activeColor);

                ui.icon.classList.toggle('icon-on', isOn);
                ui.card.setAttribute('aria-pressed', isOn ? 'true' : 'false');

                // Apply/remove dynamic border ONLY for active state
                if (isOn) {
                    ui.card.style.borderColor = activeColor;
                    ui.card.style.boxShadow = ''; // Ensure no shadow
                } else {
                    ui.intensity.style.setProperty('--thumb-border-color', '#3b82f6');
                    ui.card.style.borderColor = ''; // Revert to default border
                    ui.card.style.boxShadow = ''; // Ensure no shadow
                }

                SmartHub.SliderTooltip.update(ui.intensity, ui.intensityTooltip);
                SmartHub.SliderTooltip.update(ui.colorSlider, ui.colorTooltip);
            },
            // --- Fan UI Update (Uses CSS class, includes spin) ---
            updateFanUI: function() {
                const { speed } = SmartHub.state.fan;
                const isOn = speed > 0;
                const ui = SmartHub.UI.fan;
                if (!ui.card) return;
                const activeColor = '#22d3ee'; // Cyan

                ui.speed.value = speed;
                ui.value.textContent = `Level ${speed}`;
                ui.speed.style.setProperty('--thumb-border-color', isOn ? activeColor : '#3b82f6');
                this.updateSliderBackground(ui.speed, activeColor);

                ui.card.classList.toggle('card-active-cyan', isOn); // Toggle border class
                ui.icon.classList.toggle('animate-spin', isOn);
                ui.icon.classList.toggle('text-cyan-400', isOn);
                ui.icon.style.animationDuration = isOn ? `${Math.max(0.5, 6 - speed)}s` : '';

                ui.card.setAttribute('aria-pressed', isOn ? 'true' : 'false');
                SmartHub.SliderTooltip.update(ui.speed, ui.speedTooltip);
            },
            // --- MODIFIED: Thermostat UI Update (Uses CSS classes for border) ---
             updateThermostatUI: function() {
                const { temperature, mode } = SmartHub.state.thermostat;
                const ui = SmartHub.UI.thermostat;
                if (!ui.card) return;

                ui.display.textContent = `${temperature}\u00B0`;
                ui.modeDisplay.textContent = `Mode: ${mode}`;

                ui.card.classList.remove('card-active-red', 'card-active-blue'); // Remove border classes first
                ui.icon.classList.remove('text-red-500', 'text-blue-500', 'text-gray-500');

                ui.modeButtons.forEach(btn => {
                    btn.classList.remove('bg-gray-600');
                    const icon = btn.querySelector('i');
                    if (icon) icon.className = 'w-6 h-6 text-gray-500 pointer-events-none transition-colors';
                });

                let activeBtn;
                let activeColorClass = 'text-gray-500';
                let activeCardClass = '';

                if (mode === 'Heat') {
                    activeCardClass = 'card-active-red'; // Set border class
                    activeBtn = ui.modeContainer.querySelector('#temp-mode-heat');
                    activeColorClass = 'text-red-500';
                } else if (mode === 'Cool') {
                    activeCardClass = 'card-active-blue'; // Set border class
                    activeBtn = ui.modeContainer.querySelector('#temp-mode-cool');
                    activeColorClass = 'text-blue-500';
                } else { // Off mode
                    activeBtn = ui.modeContainer.querySelector('#temp-mode-off');
                    activeColorClass = 'text-white';
                }

                if(activeCardClass) ui.card.classList.add(activeCardClass); // Apply border class
                ui.icon.classList.add(mode === 'Off' ? 'text-gray-500' : activeColorClass);

                if (activeBtn) {
                    activeBtn.classList.add('bg-gray-600');
                    const activeIcon = activeBtn.querySelector('i');
                    if (activeIcon) activeIcon.classList.replace('text-gray-500', activeColorClass);
                }
            },
             // --- MODIFIED: Lock UI Update (Uses CSS classes for border) ---
            updateLockUI: function() {
                const { isLocked } = SmartHub.state.lock;
                const ui = SmartHub.UI.lock;
                if (!ui.card) return;

                ui.iconLocked.classList.toggle('hidden', !isLocked);
                ui.iconUnlocked.classList.toggle('hidden', isLocked);
                ui.button.textContent = isLocked ? 'Unlock' : 'Lock';

                ui.button.classList.toggle('bg-gray-700', isLocked);
                ui.button.classList.toggle('hover:bg-gray-600', isLocked);
                ui.button.classList.toggle('bg-green-600', !isLocked);
                ui.button.classList.toggle('hover:bg-green-500', !isLocked);

                ui.card.classList.toggle('card-active-red', isLocked); // Toggle border classes
                ui.card.classList.toggle('card-active-green', !isLocked);
                ui.card.setAttribute('aria-pressed', isLocked ? 'true' : 'false');
            },
            // --- Speaker UI Update (Uses CSS class for border) ---
             updateSpeakerUI: function() {
                const { isPlaying, volume, trackIndex } = SmartHub.state.speaker;
                const ui = SmartHub.UI.speaker;
                if (!ui.card) return;
                const playlist = SmartHub.config.playlist;
                const trackName = (playlist && playlist.length > trackIndex && playlist[trackIndex] || 'No track loaded').split('/').pop().replace('.mp3', '');
                const activeColor = '#a78bfa'; // Purple

                ui.volume.value = volume;
                ui.value.textContent = `${volume}%`;
                ui.volume.style.setProperty('--thumb-border-color', isPlaying ? activeColor : '#3b82f6');
                this.updateSliderBackground(ui.volume, activeColor);
                ui.trackProgress.style.backgroundColor = activeColor;

                ui.playButton.setAttribute('aria-label', isPlaying ? 'Pause Music' : 'Play Music');
                ui.playIcon.classList.toggle('hidden', isPlaying);
                ui.pauseIcon.classList.toggle('hidden', !isPlaying);
                ui.icon.classList.toggle('text-purple-400', isPlaying);

                ui.card.classList.toggle('card-active-purple', isPlaying); // Toggle border class

                ui.trackTitle.textContent = isPlaying ? trackName : (SmartHub.UI.audio.player.src ? `Paused: ${trackName}` : 'Paused');

                ui.nowIcon.classList.toggle('text-purple-400', isPlaying);
                ui.nowIcon.classList.toggle('glow-animate', isPlaying); // Keep glow for 'Now Playing'
                ui.nowText.textContent = isPlaying ? 'Now Playing' : 'Idle';
                ui.nowText.classList.toggle('text-purple-300', isPlaying);

                SmartHub.SliderTooltip.update(ui.volume, ui.volumeTooltip);
            },
            updateActiveScene: function() {
                // ... (Scene button update remains the same)
                 SmartHub.UI.scenes.forEach(button => {
                     if (!button) return;
                    button.classList.toggle('active', button.dataset.scene === SmartHub.state.activeScene);
                });
            },
            updateAllUIs: function() {
                this.updateLightUI();
                this.updateFanUI();
                this.updateThermostatUI();
                this.updateLockUI();
                this.updateSpeakerUI();
                this.updateActiveScene();
                SmartHub.Persistence.save(); // Save state after all UI updates
            }
        },

        // --- Speech Recognition & TTS Module ---
        Speech: {
             // ... (Speech logic remains the same)
             recognition: null,
            init: function() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    this.showStatus("Speech recognition not supported.", 5000, false);
                    if (SmartHub.UI.voice.micButton) { SmartHub.UI.voice.micButton.disabled = true; SmartHub.UI.voice.micButton.classList.add('opacity-50', 'cursor-not-allowed'); } return;
                }
                this.recognition = new SpeechRecognition(); this.recognition.continuous = false; this.recognition.lang = 'en-US';
                this.recognition.interimResults = false; this.recognition.maxAlternatives = 1;
                this.recognition.onstart = this.onStart.bind(this); this.recognition.onresult = this.onResult.bind(this);
                this.recognition.onspeechend = () => this.recognition.stop(); this.recognition.onerror = this.onError.bind(this); this.recognition.onend = this.onEnd.bind(this);
            },
            toggleListen: function() {
                if (!this.recognition) return; if (SmartHub.state.listening) { this.recognition.stop(); } else { try { this.recognition.start(); } catch (err) { console.error("Speech recognition start error:", err); this.showStatus("Cannot start mic. Check permissions.", 5000, false); } }
            },
            onStart: function() {
                SmartHub.state.listening = true; this.showStatus("Listening...", 10000, false); if (SmartHub.UI.voice.transcriptDisplay) SmartHub.UI.voice.transcriptDisplay.textContent = "";
                if (SmartHub.UI.voice.micButton) { SmartHub.UI.voice.micButton.classList.add('animate-pulse', 'bg-red-600', 'hover:bg-red-700'); SmartHub.UI.voice.micButton.classList.remove('bg-blue-600', 'hover:bg-blue-700'); SmartHub.UI.voice.micIcon.classList.add('hidden'); SmartHub.UI.voice.micActiveIcon.classList.remove('hidden'); }
            },
            onEnd: function() {
                SmartHub.state.listening = false;
                if (SmartHub.UI.voice.micButton) { SmartHub.UI.voice.micButton.classList.remove('animate-pulse', 'bg-red-600', 'hover:bg-red-700'); SmartHub.UI.voice.micButton.classList.add('bg-blue-600', 'hover:bg-blue-700'); SmartHub.UI.voice.micIcon.classList.remove('hidden'); SmartHub.UI.voice.micActiveIcon.classList.add('hidden'); }
                 if (SmartHub.UI.voice.statusMessage && SmartHub.UI.voice.statusMessage.textContent === "Listening...") { setTimeout(() => { if (!SmartHub.state.listening && SmartHub.UI.voice.statusMessage.textContent === "Listening...") { SmartHub.UI.voice.statusMessage.textContent = "Tap mic to speak"; } }, 1000); }
            },
            onError: function(event) {
                console.error("Speech recognition error:", event.error); let message = `Error: ${event.error}`;
                if (event.error === 'no-speech') message = "Didn't hear anything."; if (event.error === 'audio-capture') message = "Microphone error."; if (event.error === 'not-allowed') message = "Mic permission denied."; this.showStatus(message, 5000, false);
            },
            onResult: function(event) {
                const transcript = event.results[0][0].transcript.toLowerCase().trim(); if (SmartHub.UI.voice.transcriptDisplay) { SmartHub.UI.voice.transcriptDisplay.textContent = `"${transcript}"`; } this.processCommand(transcript);
            },
             speak: function(text) {
                if (!('speechSynthesis' in window)) { console.warn("Speech synthesis not supported."); return; } try { window.speechSynthesis.cancel(); const utterance = new SpeechSynthesisUtterance(text); utterance.lang = 'en-US'; window.speechSynthesis.speak(utterance); } catch (e) { console.warn('Speech synthesis failed', e); }
            },
            showStatus: function(message, duration = 4000, speakMessage = true) {
                if (SmartHub.UI.voice.statusMessage) { SmartHub.UI.voice.statusMessage.textContent = message; } if (SmartHub.state.statusTimer) clearTimeout(SmartHub.state.statusTimer);
                SmartHub.state.statusTimer = setTimeout(() => { if (SmartHub.UI.voice.statusMessage && SmartHub.UI.voice.statusMessage.textContent === message) { SmartHub.UI.voice.statusMessage.textContent = "Tap mic to speak"; } }, duration);
                if (speakMessage) this.speak(message);
            },
            parseNumber: function(command) {
                if (!command || typeof command !== 'string') return null; const digitMatch = command.match(/(\d+)/); if (digitMatch) return parseInt(digitMatch[1], 10);
                const tokens = command.toLowerCase().split(/[^a-z]+/).filter(Boolean); let total = 0; let currentNumber = 0; let foundNumberWord = false; const map = SmartHub.config.wordToNumberMap;
                for (const token of tokens) { if (token in map) { foundNumberWord = true; const value = map[token]; if (value === 100) { currentNumber = (currentNumber || 1) * 100; } else { currentNumber += value; } } else { if (currentNumber > 0) { total += currentNumber; currentNumber = 0; } } } total += currentNumber; return foundNumberWord ? total : null;
            },
             processCommand: function(command) {
                let processed = true; const state = SmartHub.state; const parser = this.parseNumber; const colorMap = SmartHub.config.colorMap;
                if (command.includes('good morning')) { SmartHub.EventHandlers.runScene('goodMorning'); }
                else if (command.includes('movie night')) { SmartHub.EventHandlers.runScene('movieNight'); }
                else if (command.includes('good night')) { SmartHub.EventHandlers.runScene('goodNight'); }
                else if (command.includes('turn everything off') || command.includes('all off')) { SmartHub.EventHandlers.runScene('allOff'); }
                else if (command.includes('party')) { SmartHub.EventHandlers.runScene('party'); }
                else if (command.includes('focus')) { SmartHub.EventHandlers.runScene('focus'); }
                else if (command.includes('light on')) { if (state.light.intensity === 0) { state.light.intensity = state.light.lastKnownIntensity || 50; this.showStatus("OK, turning on the light."); } else { processed = false; } }
                else if (command.includes('light off')) { if (state.light.intensity > 0) { state.light.intensity = 0; this.showStatus("OK, turning off the light."); } else { processed = false; } }
                else if (command.includes('set light') || command.includes('change light')) { const colorWord = Object.keys(colorMap).find(c => command.includes(c)); const intensity = parser(command); if (colorWord) { state.light.hue = colorMap[colorWord]; if (state.light.intensity === 0) state.light.intensity = state.light.lastKnownIntensity || 50; this.showStatus(`Set light color to ${colorWord}.`); } else if (intensity !== null && intensity >= 0 && intensity <= 100) { state.light.intensity = intensity; if (intensity > 0) state.light.lastKnownIntensity = intensity; this.showStatus(`Set light intensity to ${intensity}%.`); } else { processed = false; this.showStatus("Set light to what color or intensity (0-100)?"); } }
                else if (command.includes('fan on')) { if (state.fan.speed === 0) { state.fan.speed = state.fan.lastKnownSpeed || 1; this.showStatus("OK, turning on the fan."); } else { processed = false; } }
                else if (command.includes('fan off')) { if (state.fan.speed > 0) { state.fan.speed = 0; this.showStatus("OK, turning off the fan."); } else { processed = false; } }
                else if (command.includes('set fan speed')) { const speed = parser(command); if (speed !== null && speed >= 0 && speed <= 5) { state.fan.speed = speed; if (speed > 0) state.fan.lastKnownSpeed = speed; this.showStatus(`Set fan speed to level ${speed}.`); } else { this.showStatus("Sorry, fan speed must be between 0 and 5."); } }
                else if (command.includes('set temperature to') || command.includes('set thermostat to')) { const temp = parser(command); if (temp !== null && temp >= 50 && temp <= 90) { state.thermostat.temperature = temp; if (state.thermostat.mode === 'Off') state.thermostat.mode = 'Heat'; this.showStatus(`Set temperature to ${temp} degrees.`); } else { this.showStatus("Please set a temperature between 50 and 90."); } }
                else if (command.includes('heat on') || command.includes('set to heat')) { state.thermostat.mode = 'Heat'; this.showStatus("OK, heating mode is on."); }
                else if (command.includes('cool on') || command.includes('ac on') || command.includes('set to cool')) { state.thermostat.mode = 'Cool'; this.showStatus("OK, cooling mode is on."); }
                else if (command.includes('thermostat off') || command.includes('turn off thermostat')) { state.thermostat.mode = 'Off'; this.showStatus("OK, thermostat is off."); }
                else if (command.includes('lock the door')) { state.lock.isLocked = true; this.showStatus("OK, front door is locked."); }
                else if (command.includes('unlock the door')) { state.lock.isLocked = false; this.showStatus("OK, front door is unlocked."); }
                else if (command.includes('play music') || command.includes('play song') || command === 'play') { SmartHub.AudioPlayer.play(); this.showStatus("OK, playing music."); }
                else if (command.includes('pause music') || command.includes('pause song') || command === 'pause' || command.includes('stop music')) { SmartHub.AudioPlayer.pause(); this.showStatus("OK, pausing music."); }
                else if (command.includes('next track') || command.includes('next song') || command.includes('skip')) { SmartHub.AudioPlayer.next(); }
                else if (command.includes('previous track') || command.includes('previous song') || command.includes('last song')) { SmartHub.AudioPlayer.prev(); }
                else if (command.includes('set volume') || command.includes('volume to')) { const vol = parser(command); if (vol !== null && vol >= 0 && vol <= 100) { SmartHub.AudioPlayer.setVolume(vol); this.showStatus(`Setting volume to ${vol}%.`); } else { this.showStatus("Set volume to what level (0-100)?"); } }
                else { processed = false; this.showStatus("Sorry, I didn't understand that.", 4000, false); }
                if (processed) { SmartHub.UIUpdater.updateAllUIs(); }
            }
        },

        // --- Event Handlers Module ---
        EventHandlers: {
             // ... (Most event handlers remain the same, relying on UIUpdater for visuals)
              init: function() {
                const ui = SmartHub.UI;
                document.querySelectorAll('.ripple-button').forEach(btn => { btn.addEventListener('click', this.createRipple); });
                // Light
                if (ui.light.card) { const handler = this.onLightCardClick; ui.light.card.addEventListener('click', handler); ui.light.card.addEventListener('keydown', (e) => this.handleCardKeyPress(e, handler)); ui.light.intensity.addEventListener('input', this.onLightIntensityInput); ui.light.intensity.addEventListener('blur', this.onSliderBlur); ui.light.colorSlider.addEventListener('input', this.onLightColorInput); ui.light.colorSlider.addEventListener('blur', this.onSliderBlur); }
                // Fan
                if (ui.fan.card) { const handler = this.onFanCardClick; ui.fan.card.addEventListener('click', handler); ui.fan.card.addEventListener('keydown', (e) => this.handleCardKeyPress(e, handler)); ui.fan.speed.addEventListener('input', this.onFanSpeedInput); ui.fan.speed.addEventListener('blur', this.onSliderBlur); }
                // Thermostat
                if (ui.thermostat.card) { ui.thermostat.tempUp.addEventListener('click', this.onTempUp); ui.thermostat.tempDown.addEventListener('click', this.onTempDown); ui.thermostat.modeContainer.addEventListener('click', this.onTempModeClick); }
                // Lock
                if (ui.lock.button) { ui.lock.button.addEventListener('click', this.onLockClick); }
                // Speaker
                if (ui.speaker.card) { ui.speaker.volume.addEventListener('input', this.onVolumeInput); ui.speaker.volume.addEventListener('blur', this.onSliderBlur); ui.speaker.playButton.addEventListener('click', this.onPlayPauseClick); ui.speaker.nextButton.addEventListener('click', this.onNextTrackClick); ui.speaker.prevButton.addEventListener('click', this.onPrevTrackClick); ui.speaker.progressBarContainer.addEventListener('click', SmartHub.AudioPlayer.seek.bind(SmartHub.AudioPlayer)); }
                // Scenes
                ui.scenes.forEach(button => { if (!button) return; button.addEventListener('click', (e) => { this.runScene(e.currentTarget.dataset.scene); SmartHub.AudioPlayer.playEffect('click'); }); });
                // Voice
                if (ui.voice.micButton) { ui.voice.micButton.addEventListener('click', () => { SmartHub.Speech.toggleListen(); SmartHub.AudioPlayer.playEffect('click'); }); }
                // Modal
                if (ui.modal.addButton) { ui.modal.addButton.addEventListener('click', () => { SmartHub.UI.showModal(); SmartHub.AudioPlayer.playEffect('click'); }); ui.modal.addButton.addEventListener('keydown', (e) => this.handleCardKeyPress(e, SmartHub.UI.showModal.bind(SmartHub.UI))); }
                if (ui.modal.closeButton) ui.modal.closeButton.addEventListener('click', () => SmartHub.UI.hideModal()); if (ui.modal.overlay) ui.modal.overlay.addEventListener('click', () => SmartHub.UI.hideModal());
            },
             createRipple: function(event) {
                const button = event.currentTarget; const existingRipple = button.querySelector(".ripple"); if (existingRipple) existingRipple.remove();
                const circle = document.createElement("span"); const diameter = Math.max(button.clientWidth, button.clientHeight); const radius = diameter / 2; const rect = button.getBoundingClientRect();
                circle.style.width = circle.style.height = `${diameter}px`; circle.style.left = `${event.clientX - rect.left - radius}px`; circle.style.top = `${event.clientY - rect.top - radius}px`; circle.classList.add("ripple"); button.appendChild(circle); setTimeout(() => circle.remove(), 600);
            },
            handleCardKeyPress: function(event, clickHandler) { if (event.key === 'Enter' || event.key === ' ') { event.preventDefault(); clickHandler(event); } },
            onLightCardClick: function(e) { if (e.target.type === 'range') return; const state = SmartHub.state.light; state.intensity = (state.intensity > 0) ? 0 : (state.lastKnownIntensity || 50); SmartHub.AudioPlayer.playEffect('toggle'); SmartHub.UIUpdater.updateLightUI(); SmartHub.Persistence.save(); },
            onLightIntensityInput: function(e) { const newValue = Number(e.target.value); SmartHub.state.light.intensity = newValue; if (newValue > 0) SmartHub.state.light.lastKnownIntensity = newValue; SmartHub.UIUpdater.updateLightUI(); },
            onLightColorInput: function(e) { SmartHub.state.light.hue = e.target.value; if (SmartHub.state.light.intensity === 0) { SmartHub.state.light.intensity = SmartHub.state.light.lastKnownIntensity || 50; } SmartHub.UIUpdater.updateLightUI(); },
            onFanCardClick: function(e) { if (e.target.type === 'range') return; const state = SmartHub.state.fan; state.speed = (state.speed > 0) ? 0 : (state.lastKnownSpeed || 1); SmartHub.AudioPlayer.playEffect('toggle'); SmartHub.UIUpdater.updateFanUI(); SmartHub.Persistence.save(); },
            onFanSpeedInput: function(e) { const newValue = Number(e.target.value); SmartHub.state.fan.speed = newValue; if (newValue > 0) SmartHub.state.fan.lastKnownSpeed = newValue; SmartHub.UIUpdater.updateFanUI(); },
            onTempUp: function() { SmartHub.state.thermostat.temperature++; SmartHub.AudioPlayer.playEffect('click'); SmartHub.UIUpdater.updateThermostatUI(); SmartHub.Persistence.save(); },
            onTempDown: function() { SmartHub.state.thermostat.temperature--; SmartHub.AudioPlayer.playEffect('click'); SmartHub.UIUpdater.updateThermostatUI(); SmartHub.Persistence.save(); },
            onTempModeClick: function(e) { const btn = e.target.closest('.temp-mode-button'); if (btn && btn.dataset.mode) { SmartHub.state.thermostat.mode = btn.dataset.mode; SmartHub.AudioPlayer.playEffect('click'); SmartHub.UIUpdater.updateThermostatUI(); SmartHub.Persistence.save(); } },
            onLockClick: function() { SmartHub.state.lock.isLocked = !SmartHub.state.lock.isLocked; SmartHub.AudioPlayer.playEffect('toggle'); SmartHub.UIUpdater.updateLockUI(); SmartHub.Persistence.save(); },
            onVolumeInput: function(e) { SmartHub.AudioPlayer.setVolume(Number(e.target.value)); },
            onSliderBlur: function() { SmartHub.Persistence.save(); }, // Save on slider release
            onPlayPauseClick: function(e) { e.stopPropagation(); SmartHub.AudioPlayer.playEffect('click'); if (SmartHub.state.speaker.isPlaying) SmartHub.AudioPlayer.pause(); else SmartHub.AudioPlayer.play(); },
            onNextTrackClick: function(e) { e.stopPropagation(); SmartHub.AudioPlayer.playEffect('click'); SmartHub.AudioPlayer.next(); },
            onPrevTrackClick: function(e) { e.stopPropagation(); SmartHub.AudioPlayer.playEffect('click'); SmartHub.AudioPlayer.prev(); },
            runScene: function(sceneName) {
                 // ... (Scene logic remains the same)
                 if (!sceneName) return; SmartHub.state.activeScene = sceneName; const state = SmartHub.state; let message = `Activated '${sceneName}' scene.`;
                switch(sceneName) {
                    case 'goodMorning': state.light = { ...state.light, intensity: 70, lastKnownIntensity: 70, hue: 50 }; state.fan = { ...state.fan, speed: 0 }; state.thermostat = { temperature: 68, mode: 'Heat' }; state.lock = { isLocked: false }; SmartHub.AudioPlayer.pause(); message = "Good morning! Starting the day."; break;
                    case 'movieNight': state.light = { ...state.light, intensity: 15, lastKnownIntensity: 15, hue: 240 }; state.fan = { ...state.fan, speed: 1, lastKnownSpeed: 1 }; SmartHub.AudioPlayer.setVolume(40); state.lock = { isLocked: true }; message = "Movie night ready!"; break;
                    case 'goodNight': state.light = { ...state.light, intensity: 0 }; state.fan = { ...state.fan, speed: 0 }; SmartHub.AudioPlayer.pause(); SmartHub.AudioPlayer.setVolume(0); state.lock = { isLocked: true }; state.thermostat = { temperature: 65, mode: 'Heat' }; message = "Good night! Turning things off."; break;
                    case 'allOff': state.light = { ...state.light, intensity: 0 }; state.fan = { ...state.fan, speed: 0 }; SmartHub.AudioPlayer.pause(); SmartHub.AudioPlayer.setVolume(0); state.thermostat.mode = 'Off'; message = "Turning everything off."; break;
                    case 'party': state.light = { ...state.light, intensity: 100, lastKnownIntensity: 100, hue: 300 }; state.fan = { ...state.fan, speed: 2, lastKnownSpeed: 2 }; SmartHub.AudioPlayer.setVolume(70); SmartHub.AudioPlayer.play(); state.thermostat = { temperature: 70, mode: 'Cool' }; message = "Let's get this party started!"; break;
                    case 'focus': state.light = { ...state.light, intensity: 80, lastKnownIntensity: 80, hue: 190 }; state.fan = { ...state.fan, speed: 1, lastKnownSpeed: 1 }; SmartHub.AudioPlayer.pause(); message = "Focus mode activated."; break;
                    default: console.warn(`Unknown scene: ${sceneName}`); message = `Scene '${sceneName}' applied.`; break;
                } SmartHub.Speech.showStatus(message); SmartHub.UIUpdater.updateAllUIs();
            }
        },

        // --- Application Initializer ---
        init: function() {
            console.log("SmartHub Initializing (V1 Effects)...");
            this.Persistence.load();
            this.UI.cache();
            this.Clock.init();
            this.AudioPlayer.init();
            this.Speech.init();
            this.EventHandlers.init();
            this.SliderTooltip.init();
            this.UIUpdater.updateAllUIs(); // Initial UI sync

            if (window.lucide) {
                lucide.createIcons({ width: 24, height: 24 });
                console.log("Lucide icons created.");
            } else { console.warn("Lucide library not found."); }
            console.log("SmartHub Initialized Successfully (V1 Effects).");
        }
    };

    // --- Start the application ---
    document.addEventListener('DOMContentLoaded', () => {
        SmartHub.init();
    });
    </script>
</body>
</html>
