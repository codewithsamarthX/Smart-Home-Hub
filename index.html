<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Advanced Smart Home Hub - Room UI</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --thumb-border-color: #3b82f6;
            --light-hue: 60;
            --fan-hue: 200;
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            --glass-bg: rgba(17, 24, 39, 0.7);
            --glass-border: rgba(55, 65, 81, 0.5);
        }

        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #111827; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* --- Sliders --- */
        input[type="range"] {
            -webkit-appearance: none; appearance: none; width: 100%; height: 8px;
            background-color: #374151; border-radius: 8px; outline: none;
            transition: background 0.2s ease;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px;
            background-color: white; border-radius: 50%;
            border: 3px solid var(--thumb-border-color);
            cursor: pointer; margin-top: -6px;
            transition: all 0.2s ease;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px; height: 20px; background-color: white; border-radius: 50%;
            border: 3px solid var(--thumb-border-color);
            cursor: pointer; transition: all 0.2s ease;
        }
        input[type="range"].color-slider {
            background: linear-gradient(to right,
                #ff0000, #ff8000, #ffff00, #00ff00, #00ffff, #0000ff, #8000ff, #ff0080, #ff0000
            );
        }

        /* --- Ripple Effect --- */
        .ripple-button { position: relative; overflow: hidden; }
        .ripple {
            position: absolute; border-radius: 50%;
            transform: scale(0); animation: ripple 0.6s linear;
            background-color: rgba(255, 255, 255, 0.4);
            pointer-events: none;
        }
        @keyframes ripple { to { transform: scale(4); opacity: 0; } }

        /* --- Buttons --- */
        .temp-button {
            width: 3rem; height: 3rem; border-radius: 9999px; background-color: #374151; color: white;
            display: flex; align-items: center; justify-content: center; font-size: 1.875rem; font-weight: bold;
            transition: all 150ms;
        }
        .temp-button:active { background-color: #4B5563; transform: scale(0.95); }

        .scene-button { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 1rem; border-radius: .5rem; 
            background-color: var(--glass-bg);
            border: 1px solid var(--glass-border); backdrop-filter: blur(8px); color: #D1D5DB; transition: 200ms;
            position: relative; overflow: hidden;
        }
        .scene-button:hover { background-color: rgba(55,65,81,0.8); color:white; }
        .scene-button.active { background-color: rgba(37,99,235,0.9); color:white; border-color:#3B82F6; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }

        /* --- Icons --- */
        .icon-on { color: hsl(var(--light-hue,60),100%,50%); filter: drop-shadow(0 0 8px hsl(var(--light-hue,60),100%,50%)); }
        .icon-locked { color: #EF4444; }
        .icon-unlocked { color: #10B981; }
        #fan-icon { will-change: transform; }
        .icon-fan-on { color: hsl(var(--fan-hue, 200), 100%, 50%); filter: drop-shadow(0 0 8px hsl(var(--fan-hue, 200), 100%, 50%)); }

        @keyframes glow {
            0%,100% { filter: drop-shadow(0 0 6px var(--glow-color, #3b82f6)); }
            50% { filter: drop-shadow(0 0 12px var(--glow-color, #3b82f6)); }
        }
        .glow-animate { animation: glow 1.5s infinite; }

        /* --- Device Card --- */
        .device-card {
            background-color: var(--glass-bg);
            backdrop-filter: blur(8px);
            border: 1px solid var(--glass-border);
            border-radius: 0.75rem;
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            transition: transform 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease, 
                        opacity 0.3s ease, max-height 0.4s ease, 
                        margin 0.4s ease, padding 0.4s ease;
            transform-origin: center top;
            overflow: hidden;
            position: relative;
        }
        .device-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .device-card:hover:not(.card-is-active):not(:has(input:focus)):not(:has(button:focus)) {
            transform: translateY(-4px) scale(1.02);
            border-color: rgba(107, 114, 128, 0.7);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }
        .device-card.card-is-active::before {
            opacity: 1;
        }

        .device-hidden {
            opacity: 0;
            transform: scale(0.95);
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-bottom: 0;
            border-width: 0;
            pointer-events: none;
        }

        /* --- Card Active States --- */
        .card-active-blue { border-color: #3b82f6; }
        .card-active-red { border-color: #ef4444; }
        .card-active-green { border-color: #10b981; }
        .card-active-cyan { border-color: #22d3ee; }
        .card-active-purple { border-color: #a78bfa; }

        /* --- Expandable Card UX --- */
        .collapsible-controls {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.4s ease-in-out;
            overflow: hidden;
        }
        .collapsible-controls > div {
            min-height: 0;
            opacity: 0;
            transition: opacity 0.3s ease-out 0.1s;
        }
        .card-is-active .collapsible-controls {
            grid-template-rows: 1fr;
            margin-top: 1rem;
        }
        .card-is-active .collapsible-controls > div {
            opacity: 1;
        }
        .card-status-text {
            transition: color 0.3s ease;
        }
        .card-is-active .card-status-text {
            color: white;
            font-weight: 600;
        }

        /* --- Active Card Glow Effects --- */
        .card-is-active[data-device="light"] {
            border-color: hsl(var(--light-hue), 100%, 70%);
            box-shadow: 0 0 20px 5px hsla(var(--light-hue), 100%, 60%, 0.3);
        }
        .card-is-active[data-device="fan"] {
            border-color: hsl(var(--fan-hue), 100%, 70%);
            box-shadow: 0 0 20px 5px hsla(var(--fan-hue), 100%, 60%, 0.3);
        }

        /* --- Add Device Button --- */
        @keyframes pulse-border {
            0%, 100% { border-color: rgba(107, 114, 128, 0.7); }
            50% { border-color: rgba(59, 130, 246, 0.9); }
        }
        #add-device-button { animation: pulse-border 2.5s infinite; }

        /* --- Modal --- */
        .modal-hidden { display: none; }
        #modal-overlay {
            position: fixed; inset: 0;
            background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px);
            opacity: 0; transition: opacity 0.3s ease; z-index: 40;
        }
        #modal-overlay.active { opacity: 1; }
        #modal-box {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background-color: #111827; color: white;
            border-radius: 0.75rem; border: 1px solid #4b5563;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
            padding: 1.5rem; width: 90%; max-width: 512px;
            opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease; z-index: 50;
        }
        #modal-box.active { opacity: 1; transform: translate(-50%, -50%) scale(1); }

        /* --- Slider Tooltip --- */
        .slider-tooltip {
            position: absolute; background-color: #3b82f6;
            color: white; font-weight: 600; padding: 4px 8px;
            border-radius: 4px; font-size: 0.875rem;
            bottom: 30px; left: 50%;
            transform: translateX(-50%);
            pointer-events: none; opacity: 0;
            transition: opacity 0.2s ease, bottom 0.2s ease;
            white-space: nowrap; z-index: 10;
        }
        .slider-container:has(input[type="range"]:active) .slider-tooltip {
            opacity: 1; bottom: 40px;
        }

        /* --- Room Tab Button --- */
        .room-tab-button {
            padding: 0.5rem 1.25rem;
            border-radius: 9999px;
            font-weight: 500;
            color: #9ca3af;
            background-color: transparent;
            border: 1px solid #374151;
            transition: all 0.2s ease;
        }
        .room-tab-button:hover {
            color: white;
            background-color: #374151;
        }
        .room-tab-button.active {
            color: white;
            background-color: #2563eb;
            border-color: #2563eb;
        }

        /* --- Notification System --- */
        .notification {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background-color: rgba(31, 41, 55, 0.9);
            backdrop-filter: blur(10px);
            border-left: 4px solid #3b82f6;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 30;
            max-width: 350px;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.error {
            border-left-color: #ef4444;
        }
        .notification.success {
            border-left-color: #10b981;
        }
        .notification.warning {
            border-left-color: #f59e0b;
        }

        /* --- Schedule Modal --- */
        .schedule-item {
            background-color: rgba(31, 41, 55, 0.5);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .schedule-time {
            font-weight: bold;
            color: #3b82f6;
        }
        .schedule-action {
            color: #d1d5db;
        }
        .schedule-toggle {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }
        .schedule-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .schedule-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #374151;
            transition: .4s;
            border-radius: 24px;
        }
        .schedule-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .schedule-slider {
            background-color: #3b82f6;
        }
        input:checked + .schedule-slider:before {
            transform: translateX(24px);
        }

        /* --- Security Log --- */
        .security-log {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 8px;
        }
        .log-entry {
            display: flex;
            padding: 8px 0;
            border-bottom: 1px solid rgba(55, 65, 81, 0.5);
        }
        .log-time {
            color: #9ca3af;
            width: 80px;
            flex-shrink: 0;
        }
        .log-message {
            flex-grow: 1;
        }
        .log-type {
            width: 100px;
            text-align: right;
            font-weight: bold;
            flex-shrink: 0;
        }
        .log-type.info {
            color: #3b82f6;
        }
        .log-type.warning {
            color: #f59e0b;
        }
        .log-type.danger {
            color: #ef4444;
        }

        /* --- User Profile --- */
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            margin: 0 auto 1rem;
        }
        .profile-info {
            text-align: center;
        }
        .profile-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .profile-role {
            color: #9ca3af;
            margin-bottom: 1rem;
        }
        .profile-preferences {
            margin-top: 1.5rem;
        }
        .preference-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(55, 65, 81, 0.5);
        }
        .preference-label {
            font-weight: 500;
        }

        /* --- User Management Modal --- */
        .user-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .form-group label {
            font-weight: 500;
            color: #d1d5db;
        }
        .form-group input, .form-group select {
            padding: 0.5rem;
            border-radius: 0.375rem;
            background-color: #374151;
            border: 1px solid #4b5563;
            color: white;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body class="bg-black text-white font-sans antialiased min-h-screen flex flex-col">

    <main class="flex-grow p-4 md:p-8">
        <header class="mb-10 max-w-xl mx-auto p-4 rounded-xl shadow-2xl 
                        bg-gray-900/70 backdrop-blur-md border border-gray-700/50">
            <div class="flex justify-between items-center">
                <div class="text-left">
                    <h1 id="time-display" class="text-3xl font-extrabold leading-none">--:--:--</h1>
                    <p id="date-display" class="text-sm text-gray-400 font-medium">Loading date...</p>
                </div>
                <div class="text-center">
                    <h2 class="text-xl font-bold">Smart Hub</h2>
                    <p id="ampm-display" class="text-sm text-gray-400">&nbsp;</p>
                </div>
                <div class="flex items-center gap-2 text-right">
                    <div id="weather-icon-container" class="flex-shrink-0">
                        <i data-lucide="cloud-sun" class="w-7 h-7 text-yellow-400" id="weather-icon"></i>
                    </div>
                    <div>
                        <div id="weather-temp" class="text-xl font-bold">75&deg;F</div>
                        <div id="weather-desc" class="text-xs text-gray-400">Partly Cloudy</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <section class="max-w-7xl mx-auto mb-6">
            <div class="flex flex-wrap gap-3 border-b border-gray-700 pb-3">
                <button class="room-tab-button ripple-button" data-tab="devices">Devices</button>
                <button class="room-tab-button ripple-button" data-tab="scenes">Scenes</button>
                <button class="room-tab-button ripple-button" data-tab="automation">Automation</button>
                <button class="room-tab-button ripple-button" data-tab="security">Security</button>
                <button class="room-tab-button ripple-button" data-tab="profile">Profile</button>
            </div>
        </section>

        <!-- Devices Tab -->
        <section id="devices-tab" class="max-w-7xl mx-auto mb-6 tab-content">
            <h2 class="text-2xl font-semibold mb-4">Devices</h2>
            <div id="room-tab-container" class="flex flex-wrap gap-3 mb-6">
                <button class="room-tab-button ripple-button active" data-room="all">All</button>
                <button class="room-tab-button ripple-button" data-room="bedroom">Bedroom</button>
                <button class="room-tab-button ripple-button" data-room="entry">Entry</button>
                <button class="room-tab-button ripple-button" data-room="outdoor">Outdoor</button>
            </div>
            <div id="device-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Bedroom Light -->
                <div id="bed-light-card" class="device-card cursor-pointer" 
                     style="--light-hue: 30;"
                     role="button" tabindex="0" aria-pressed="false" aria-label="Bedroom Light toggle"
                     data-device="light" data-room="bedroom">
                   
                    <div class="flex justify-between items-center pointer-events-none">
                        <div class="flex items-center space-x-3">
                            <i id="bed-light-icon" data-lucide="lightbulb" class="w-7 h-7 text-gray-500 transition-all duration-300"></i>
                            <h2 class="text-2xl font-semibold">Bedroom Light</h2>
                        </div>
                        <span id="bed-light-status-text" class="text-lg font-medium text-gray-400 card-status-text">Off</span>
                    </div>

                    <div class="collapsible-controls">
                        <div class="space-y-3">
                            <div class="space-y-3 transition-opacity duration-300">
                                <label for="bed-light-intensity" class="block text-sm font-medium text-gray-400">Intensity</label>
                                <div class="slider-container relative">
                                    <input type="range" id="bed-light-intensity" min="0" max="100" value="50" class="w-full" aria-label="Light intensity">
                                    <div id="bed-light-intensity-tooltip" class="slider-tooltip">50%</div>
                                </div>
                            </div>
                            <div class="space-y-3 mt-4 transition-opacity duration-300">
                                <label for="bed-light-color" class="block text-sm font-medium text-gray-400">Color</label>
                                <div class="slider-container relative">
                                    <input type="range" id="bed-light-color" min="0" max="360" value="30" class="w-full color-slider" aria-label="Light color">
                                    <div id="bed-light-color-tooltip" class="slider-tooltip" style="background-color: hsl(30, 100%, 50%)">Hue: 30°</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fan -->
                <div id="fan-card" class="device-card cursor-pointer"
                     role="button" tabindex="0" aria-pressed="false" aria-label="Bedroom Fan toggle"
                     data-device="fan" data-room="bedroom">
                   
                    <div class="flex justify-between items-center pointer-events-none">
                        <div class="flex items-center space-x-3">
                            <i id="fan-icon" data-lucide="fan" class="w-7 h-7 text-gray-500 transition-all duration-300"></i>
                            <h2 class="text-2xl font-semibold">Bedroom Fan</h2>
                        </div>
                        <span id="fan-status-text" class="text-lg font-medium text-gray-400 card-status-text">Off</span>
                    </div>
                   
                    <div class="collapsible-controls">
                        <div class="space-y-3">
                            <div class="space-y-3 transition-opacity duration-300">
                                <label for="fan-speed" class="block text-sm font-medium text-gray-400">Speed</label>
                                <div class="slider-container relative">
                                    <input type="range" id="fan-speed" min="0" max="5" value="2" step="1" class="w-full" aria-label="Fan speed">
                                    <div id="fan-speed-tooltip" class="slider-tooltip">Level 2</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Thermostat -->
                <div id="thermostat-card" class="device-card" data-room="all">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-3">
                            <i id="thermostat-icon" data-lucide="thermometer" class="w-7 h-7 text-gray-500 transition-colors duration-300"></i>
                            <h2 class="text-2xl font-semibold">Thermostat</h2>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <button id="temp-down" class="temp-button ripple-button" aria-label="Temperature Down">-</button>
                        <div class="text-center">
                            <div id="temp-display" class="text-6xl font-bold">68&deg;</div>
                            <div id="temp-mode-display" class="text-lg text-gray-400">Off</div>
                        </div>
                        <button id="temp-up" class="temp-button ripple-button" aria-label="Temperature Up">+</button>
                    </div>
                    <div id="temp-mode-container" class="flex justify-around mt-4">
                        <button id="temp-mode-heat" class="temp-mode-button ripple-button p-2 rounded-lg" data-mode="Heat" aria-label="Set Heat Mode"><i data-lucide="flame" class="w-6 h-6 text-gray-500 pointer-events-none transition-colors"></i></button>
                        <button id="temp-mode-cool" class="temp-mode-button ripple-button p-2 rounded-lg" data-mode="Cool" aria-label="Set Cool Mode"><i data-lucide="snowflake" class="w-6 h-6 text-gray-500 pointer-events-none transition-colors"></i></button>
                        <button id="temp-mode-off" class="temp-mode-button ripple-button p-2 rounded-lg bg-gray-600" data-mode="Off" aria-label="Set Mode Off"><i data-lucide="power" class="w-6 h-6 text-white pointer-events-none transition-colors"></i></button>
                    </div>
                </div>

                <!-- Smart Lock -->
                <div id="lock-card" class="device-card card-active-red" data-room="entry">
                     <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-3">
                            <i id="lock-icon-locked" data-lucide="lock" class="w-7 h-7 icon-locked transition-all duration-300"></i>
                            <i id="lock-icon-unlocked" data-lucide="lock-open" class="w-7 h-7 icon-unlocked transition-all duration-300 hidden"></i>
                            <h2 class="text-2xl font-semibold">Front Door</h2>
                        </div>
                    </div>
                    <button id="lock-toggle-button" class="w-full h-24 rounded-lg text-2xl font-semibold transition-colors duration-200 ripple-button bg-gray-700 hover:bg-gray-600">
                        Unlock
                    </button>
                </div>

                <!-- Security Camera -->
                <div id="camera-card" class="device-card" data-room="outdoor">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-3">
                            <i id="camera-icon" data-lucide="camera" class="w-7 h-7 text-gray-500 transition-colors duration-300"></i>
                            <h2 class="text-2xl font-semibold">Front Camera</h2>
                        </div>
                        <span id="camera-status-text" class="text-lg font-medium text-gray-400 card-status-text">Active</span>
                    </div>
                    <div class="bg-gray-800 rounded-lg h-40 flex items-center justify-center mb-4">
                        <i data-lucide="video-off" class="w-12 h-12 text-gray-600"></i>
                    </div>
                    <div class="flex justify-between">
                        <button id="camera-record-button" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg ripple-button">Record</button>
                        <button id="camera-snapshot-button" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg ripple-button">Snapshot</button>
                    </div>
                </div>

                <!-- Smart Blinds -->
                <div id="blinds-card" class="device-card cursor-pointer" data-room="bedroom">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-3">
                            <i id="blinds-icon" data-lucide="blinds" class="w-7 h-7 text-gray-500 transition-colors duration-300"></i>
                            <h2 class="text-2xl font-semibold">Room Blinds</h2>
                        </div>
                        <span id="blinds-status-text" class="text-lg font-medium text-gray-400 card-status-text">50%</span>
                    </div>
                    <div class="space-y-3">
                        <label for="blinds-position" class="block text-sm font-medium text-gray-400">Position</label>
                        <div class="slider-container relative">
                            <input type="range" id="blinds-position" min="0" max="100" value="50" class="w-full" aria-label="Blinds position">
                            <div id="blinds-position-tooltip" class="slider-tooltip">50%</div>
                        </div>
                    </div>
                </div>

                <!-- Smart Speaker -->
                <div id="speaker-card" class="device-card" data-room="bedroom">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center space-x-3">
                            <i id="speaker-icon" data-lucide="volume-2" class="w-7 h-7 text-gray-500 transition-colors duration-300"></i>
                            <h2 class="text-2xl font-semibold">Bedroom Speaker</h2>
                        </div>
                    </div>
                    <div id="speaker-controls" class="space-y-3">
                        <label for="speaker-volume" class="block text-sm font-medium text-gray-400">Volume</label>
                        <div class="slider-container relative">
                            <input type="range" id="speaker-volume" min="0" max="100" value="30" class="w-full" aria-label="Speaker volume">
                            <div class="slider-tooltip" id="speaker-volume-tooltip">30%</div>
                        </div>
                        <div id="speaker-volume-value" class="text-center text-lg font-medium">30%</div>
                    </div>
                    <div class="mt-4 text-center">
                        <div id="track-title" class="text-lg text-gray-300 mb-2 h-6 truncate">Paused</div>
                        <div class="relative w-full h-1 bg-gray-700 rounded-full my-3 group cursor-pointer" id="progress-bar-container">
                            <div id="track-progress" class="absolute h-1 bg-purple-500 rounded-full" style="width: 0%;"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-400">
                            <span id="track-current-time">0:00</span>
                            <span id="track-duration">0:00</span>
                        </div>
                        <div class="flex justify-center items-center space-x-4 mt-2">
                            <button id="prev-track" class="p-3 rounded-full bg-gray-700 hover:bg-gray-600 transition-all shadow-md hover:scale-110 ripple-button" aria-label="Previous Track"><i data-lucide="skip-back" class="w-6 h-6 pointer-events-none"></i></button>
                            <button id="play-pause" class="p-4 rounded-full bg-blue-600 hover:bg-blue-700 transition-all transform hover:scale-110 shadow-lg ripple-button" aria-label="Play Music">
                                <i id="play-icon" data-lucide="play" class="w-7 h-7 pointer-events-none"></i>
                                <i id="pause-icon" data-lucide="pause" class="w-7 h-7 pointer-events-none hidden"></i>
                            </button>
                            <button id="next-track" class="p-3 rounded-full bg-gray-700 hover:bg-gray-600 transition-all shadow-md hover:scale-110 ripple-button" aria-label="Next Track"><i data-lucide="skip-forward" class="w-6 h-6 pointer-events-none"></i></button>
                        </div>
                        <div class="mt-3 flex justify-center items-center space-x-2">
                            <i id="now-playing-icon" data-lucide="radio" class="w-5 h-5 text-gray-500 transition-all duration-300" style="--glow-color: #a78bfa;"></i>
                            <span id="now-playing-text" class="text-sm text-gray-400">Idle</span>
                        </div>
                    </div>
                </div>

                <!-- Add Device Button -->
                <div id="add-device-button" class="device-card border-dashed cursor-pointer"
                     role="button" tabindex="0" aria-label="Add new device" data-room="all">
                    <div class="flex items-center justify-center h-full pointer-events-none">
                        <div class="text-center text-gray-500">
                            <i data-lucide="plus-circle" class="w-12 h-12 mb-2 inline-block"></i>
                            <p>Add New Device</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Scenes Tab -->
        <section id="scenes-tab" class="max-w-7xl mx-auto tab-content hidden">
            <h2 class="text-2xl font-semibold mb-4">Scenes</h2>
            <div class="grid grid-cols-3 md:grid-cols-6 gap-4">
                <button id="scene-good-morning" class="scene-button ripple-button" data-scene="goodMorning">
                    <i data-lucide="sunrise" class="mb-2"></i>
                    <span class="pointer-events-none">Good Morning</span>
                </button>
                <button id="scene-movie-night" class="scene-button ripple-button" data-scene="movieNight">
                    <i data-lucide="film" class="mb-2"></i>
                    <span class="pointer-events-none">Movie Night</span>
                </button>
                <button id="scene-good-night" class="scene-button ripple-button" data-scene="goodNight">
                    <i data-lucide="moon" class="mb-2"></i>
                    <span class="pointer-events-none">Good Night</span>
                </button>
                <button id="scene-all-off" class="scene-button ripple-button" data-scene="allOff">
                    <i data-lucide="power-off" class="mb-2"></i>
                    <span class="pointer-events-none">All Off</span>
                </button>
                <button id="scene-party-time" class="scene-button ripple-button" data-scene="partyTime">
                    <i data-lucide="party-popper" class="mb-2"></i>
                    <span class="pointer-events-none">Party Time</span>
                </button>
                <button id="scene-focus-mode" class="scene-button ripple-button" data-scene="focusMode">
                    <i data-lucide="brain" class="mb-2"></i>
                    <span class="pointer-events-none">Focus Mode</span>
                </button>
                <button id="scene-vacation" class="scene-button ripple-button" data-scene="vacation">
                    <i data-lucide="plane" class="mb-2"></i>
                    <span class="pointer-events-none">Vacation</span>
                </button>
                <button id="scene-dinner" class="scene-button ripple-button" data-scene="dinner">
                    <i data-lucide="utensils" class="mb-2"></i>
                    <span class="pointer-events-none">Dinner</span>
                </button>
                <button id="scene-date-night" class="scene-button ripple-button" data-scene="dateNight">
                    <i data-lucide="heart" class="mb-2"></i>
                    <span class="pointer-events-none">Date Night</span>
                </button>
                <button id="scene-exercise" class="scene-button ripple-button" data-scene="exercise">
                    <i data-lucide="dumbbell" class="mb-2"></i>
                    <span class="pointer-events-none">Exercise</span>
                </button>
                <button id="scene-reading" class="scene-button ripple-button" data-scene="reading">
                    <i data-lucide="book-open" class="mb-2"></i>
                    <span class="pointer-events-none">Reading</span>
                </button>
                <button id="scene-gaming" class="scene-button ripple-button" data-scene="gaming">
                    <i data-lucide="gamepad-2" class="mb-2"></i>
                    <span class="pointer-events-none">Gaming</span>
                </button>
            </div>
        </section>

        <!-- Automation Tab -->
        <section id="automation-tab" class="max-w-7xl mx-auto tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold">Automation & Scheduling</h2>
                <button id="add-automation-button" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg ripple-button">
                    <i data-lucide="plus" class="w-5 h-5 inline mr-2"></i>
                    Add Automation
                </button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="dashboard-card">
                    <h3 class="text-xl font-semibold mb-4">Scheduled Actions</h3>
                    <div class="schedule-item">
                        <div>
                            <div class="schedule-time">6:30 AM</div>
                            <div class="schedule-action">Good Morning Scene</div>
                        </div>
                        <label class="schedule-toggle">
                            <input type="checkbox" checked>
                            <span class="schedule-slider"></span>
                        </label>
                    </div>
                    <div class="schedule-item">
                        <div>
                            <div class="schedule-time">8:00 AM</div>
                            <div class="schedule-action">Arm Security System</div>
                        </div>
                        <label class="schedule-toggle">
                            <input type="checkbox" checked>
                            <span class="schedule-slider"></span>
                        </label>
                    </div>
                    <div class="schedule-item">
                        <div>
                            <div class="schedule-time">6:00 PM</div>
                            <div class="schedule-action">Turn on Bedroom Lights</div>
                        </div>
                        <label class="schedule-toggle">
                            <input type="checkbox">
                            <span class="schedule-slider"></span>
                        </label>
                    </div>
                    <div class="schedule-item">
                        <div>
                            <div class="schedule-time">10:30 PM</div>
                            <div class="schedule-action">Good Night Scene</div>
                        </div>
                        <label class="schedule-toggle">
                            <input type="checkbox" checked>
                            <span class="schedule-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <h3 class="text-xl font-semibold mb-4">Triggers & Actions</h3>
                    <div class="space-y-4">
                        <div class="p-4 bg-gray-800 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-medium">Motion Detection</h4>
                                <label class="schedule-toggle">
                                    <input type="checkbox" checked>
                                    <span class="schedule-slider"></span>
                                </label>
                            </div>
                            <p class="text-sm text-gray-400">When motion is detected at the front door, turn on porch light and send notification</p>
                        </div>
                        <div class="p-4 bg-gray-800 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-medium">Sunset</h4>
                                <label class="schedule-toggle">
                                    <input type="checkbox" checked>
                                    <span class="schedule-slider"></span>
                                </label>
                            </div>
                            <p class="text-sm text-gray-400">At sunset, close blinds and turn on outdoor lights</p>
                        </div>
                        <div class="p-4 bg-gray-800 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-medium">Temperature</h4>
                                <label class="schedule-toggle">
                                    <input type="checkbox">
                                    <span class="schedule-slider"></span>
                                </label>
                            </div>
                            <p class="text-sm text-gray-400">When temperature exceeds 75°F, turn on fan and adjust thermostat</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Security Tab -->
        <section id="security-tab" class="max-w-7xl mx-auto tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold">Security System</h2>
                <div class="flex gap-3">
                    <button id="arm-away-button" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg ripple-button">
                        <i data-lucide="shield" class="w-5 h-5 inline mr-2"></i>
                        Arm Away
                    </button>
                    <button id="arm-home-button" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg ripple-button">
                        <i data-lucide="home" class="w-5 h-5 inline mr-2"></i>
                        Arm Home
                    </button>
                    <button id="disarm-button" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg ripple-button">
                        <i data-lucide="shield-off" class="w-5 h-5 inline mr-2"></i>
                        Disarm
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="dashboard-card">
                    <h3 class="text-xl font-semibold mb-4">Security Status</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-gray-800 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="lock" class="w-5 h-5 text-green-500"></i>
                                <span>Front Door</span>
                            </div>
                            <span class="text-green-500">Locked</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-800 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="lock" class="w-5 h-5 text-green-500"></i>
                                <span>Back Door</span>
                            </div>
                            <span class="text-green-500">Locked</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-800 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="video" class="w-5 h-5 text-green-500"></i>
                                <span>Front Camera</span>
                            </div>
                            <span class="text-green-500">Active</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-800 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="video" class="w-5 h-5 text-green-500"></i>
                                <span>Backyard Camera</span>
                            </div>
                            <span class="text-green-500">Active</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-gray-800 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="activity" class="w-5 h-5 text-yellow-500"></i>
                                <span>Motion Sensors</span>
                            </div>
                            <span class="text-yellow-500">Armed</span>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <h3 class="text-xl font-semibold mb-4">Security Log</h3>
                    <div class="security-log">
                        <div class="log-entry">
                            <div class="log-time">10:45 AM</div>
                            <div class="log-message">Front door unlocked</div>
                            <div class="log-type info">Info</div>
                        </div>
                        <div class="log-entry">
                            <div class="log-time">09:30 AM</div>
                            <div class="log-message">Motion detected in backyard</div>
                            <div class="log-type warning">Warning</div>
                        </div>
                        <div class="log-entry">
                            <div class="log-time">08:15 AM</div>
                            <div class="log-message">System armed (Away mode)</div>
                            <div class="log-type info">Info</div>
                        </div>
                        <div class="log-entry">
                            <div class="log-time">07:00 AM</div>
                            <div class="log-message">Front door opened</div>
                            <div class="log-type info">Info</div>
                        </div>
                        <div class="log-entry">
                            <div class="log-time">11:30 PM</div>
                            <div class="log-message">System armed (Home mode)</div>
                            <div class="log-type info">Info</div>
                        </div>
                        <div class="log-entry">
                            <div class="log-time">10:15 PM</div>
                            <div class="log-message">Motion detected at front door</div>
                            <div class="log-type warning">Warning</div>
                        </div>
                        <div class="log-entry">
                            <div class="log-time">09:45 PM</div>
                            <div class="log-message">Backyard camera activated</div>
                            <div class="log-type info">Info</div>
                        </div>
                        <div class="log-entry">
                            <div class="log-time">06:30 PM</div>
                            <div class="log-message">Unknown person detected at front door</div>
                            <div class="log-type danger">Alert</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Profile Tab -->
        <section id="profile-tab" class="max-w-7xl mx-auto tab-content hidden">
            <h2 class="text-2xl font-semibold mb-6">User Profile</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="dashboard-card">
                    <div class="profile-avatar">SN</div>
                    <div class="profile-info">
                        <div class="profile-name">Samanth Nagpure</div>
                        <div class="profile-role">Home Administrator</div>
                        <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg ripple-button mt-4">Edit Profile</button>
                    </div>
                </div>
                
                <div class="dashboard-card lg:col-span-2">
                    <h3 class="text-xl font-semibold mb-4">Preferences</h3>
                    <div class="profile-preferences">
                        <div class="preference-item">
                            <div class="preference-label">Voice Control</div>
                            <label class="schedule-toggle">
                                <input type="checkbox" checked>
                                <span class="schedule-slider"></span>
                            </label>
                        </div>
                        <div class="preference-item">
                            <div class="preference-label">Notifications</div>
                            <label class="schedule-toggle">
                                <input type="checkbox" checked>
                                <span class="schedule-slider"></span>
                            </label>
                        </div>
                        <div class="preference-item">
                            <div class="preference-label">Auto-Lock Doors</div>
                            <label class="schedule-toggle">
                                <input type="checkbox" checked>
                                <span class="schedule-slider"></span>
                            </label>
                        </div>
                        <div class="preference-item">
                            <div class="preference-label">Energy Saving Mode</div>
                            <label class="schedule-toggle">
                                <input type="checkbox">
                                <span class="schedule-slider"></span>
                            </label>
                        </div>
                        <div class="preference-item">
                            <div class="preference-label">Security Alerts</div>
                            <label class="schedule-toggle">
                                <input type="checkbox" checked>
                                <span class="schedule-slider"></span>
                            </label>
                        </div>
                        <div class="preference-item">
                            <div class="preference-label">Guest Access</div>
                            <label class="schedule-toggle">
                                <input type="checkbox">
                                <span class="schedule-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-card mt-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Connected Users</h3>
                    <button id="add-user-button" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg ripple-button">
                        <i data-lucide="user-plus" class="w-5 h-5 inline mr-2"></i>
                        Add New User
                    </button>
                </div>
                <div id="users-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Users will be dynamically added here -->
                </div>
            </div>
        </section>
    </main>

    <footer class="sticky bottom-0 bg-gray-900/80 backdrop-blur-md p-4 w-full border-t border-gray-700/50 z-20">
        <div class="max-w-3xl mx-auto flex flex-col items-center space-y-3">
            <div id="status-message" class="text-gray-400 text-sm h-5 transition-opacity">Tap mic to speak</div>
            <button id="mic-button" class="bg-blue-600 hover:bg-blue-700 text-white p-5 rounded-full shadow-lg transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-500/50 ripple-button"
                    aria-label="Activate voice control">
                <i id="mic-icon" data-lucide="mic" class="w-7 h-7"></i>
                <i id="mic-active-icon" data-lucide="radio" class="w-7 h-7 hidden"></i>
            </button>
            <p id="transcript-display" class="text-center text-gray-300 min-h-[1.5em] text-lg px-4"></p>
        </div>
    </footer>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <!-- Add Device Modal -->
    <div id="modal-overlay" class="modal-hidden"></div>
    <div id="modal-box" class="modal-hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-semibold">Add New Device</h2>
            <button id="modal-close-button" class="p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white ripple-button" aria-label="Close modal">
                <i data-lucide="x" class="w-6 h-6 pointer-events-none"></i>
            </button>
        </div>
        <p class="text-gray-300 mb-6">Select a device type to add to your hub. (This is a demo, no new device will be added).</p>
        <div class="grid grid-cols-2 gap-4">
            <button class="scene-button ripple-button" aria-label="Add smart light">
                <i data-lucide="lightbulb" class="mb-2"></i><span>Smart Light</span>
            </button>
            <button class="scene-button ripple-button" aria-label="Add smart plug">
                <i data-lucide="plug" class="mb-2"></i><span>Smart Plug</span>
            </button>
            <button class="scene-button ripple-button" aria-label="Add camera">
                <i data-lucide="camera" class="mb-2"></i><span>Camera</span>
            </button>
            <button class="scene-button ripple-button" aria-label="Add door lock">
                <i data-lucide="lock" class="mb-2"></i><span>Door Lock</span>
            </button>
            <button class="scene-button ripple-button" aria-label="Add thermostat">
                <i data-lucide="thermometer" class="mb-2"></i><span>Thermostat</span>
            </button>
            <button class="scene-button ripple-button" aria-label="Add sensor">
                <i data-lucide="activity" class="mb-2"></i><span>Sensor</span>
            </button>
        </div>
    </div>

    <!-- Add Automation Modal -->
    <div id="automation-modal-overlay" class="modal-hidden"></div>
    <div id="automation-modal-box" class="modal-hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-semibold">Add Automation</h2>
            <button id="automation-modal-close-button" class="p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white ripple-button" aria-label="Close modal">
                <i data-lucide="x" class="w-6 h-6 pointer-events-none"></i>
            </button>
        </div>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-2">Trigger</label>
                <select class="w-full p-2 bg-gray-800 rounded-lg">
                    <option>Time of Day</option>
                    <option>Sunrise/Sunset</option>
                    <option>Motion Detected</option>
                    <option>Door Opened</option>
                    <option>Temperature Change</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-2">Action</label>
                <select class="w-full p-2 bg-gray-800 rounded-lg">
                    <option>Turn On Device</option>
                    <option>Turn Off Device</option>
                    <option>Activate Scene</option>
                    <option>Send Notification</option>
                    <option>Adjust Thermostat</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-400 mb-2">Device/Scene</label>
                <select class="w-full p-2 bg-gray-800 rounded-lg">
                    <option>Bedroom Light</option>
                    <option>Front Door Lock</option>
                    <option>Good Morning Scene</option>
                    <option>Good Night Scene</option>
                </select>
            </div>
            <button class="w-full p-2 bg-blue-600 hover:bg-blue-700 rounded-lg ripple-button">Save Automation</button>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="user-modal-overlay" class="modal-hidden"></div>
    <div id="user-modal-box" class="modal-hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-semibold">Add New User</h2>
            <button id="user-modal-close-button" class="p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white ripple-button" aria-label="Close modal">
                <i data-lucide="x" class="w-6 h-6 pointer-events-none"></i>
            </button>
        </div>
        <form id="user-form" class="user-form">
            <div class="form-group">
                <label for="user-name">Name</label>
                <input type="text" id="user-name" placeholder="Enter user name" required>
            </div>
            <div class="form-group">
                <label for="user-email">Email</label>
                <input type="email" id="user-email" placeholder="Enter user email" required>
            </div>
            <div class="form-group">
                <label for="user-role">Role</label>
                <select id="user-role">
                    <option value="Family Member">Family Member</option>
                    <option value="Guest">Guest</option>
                    <option value="Administrator">Administrator</option>
                    <option value="Child">Child</option>
                </select>
            </div>
            <div class="form-group">
                <label for="user-access">Access Level</label>
                <select id="user-access">
                    <option value="Full">Full Access</option>
                    <option value="Limited">Limited Access</option>
                    <option value="View Only">View Only</option>
                </select>
            </div>
            <button type="submit" class="w-full p-2 bg-blue-600 hover:bg-blue-700 rounded-lg ripple-button">Add User</button>
        </form>
    </div>

    <audio id="audio-player" preload="metadata"></audio>
    <audio id="audio-click" preload="auto" src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1d1c="></audio>
    <audio id="audio-toggle" preload="auto" src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA"></audio>

    <script>
    // --- Main App Initializer ---
    document.addEventListener('DOMContentLoaded', () => {
        SmartHub.init();
    });

    // --- Icon Helper Function ---
    function createIcons() {
        if (window.lucide) {
            lucide.createIcons();
        }
    }

    // --- Main SmartHub Application Object ---
    const SmartHub = {

        // --- 1. Application State ---
        state: {
            // Device states
            bedLight: { intensity: 50, lastKnownIntensity: 50, hue: 30 },
            fan: { speed: 2, lastKnownSpeed: 2 },
            thermostat: { temperature: 68, mode: 'Off' },
            lock: { isLocked: true },
            camera: { isRecording: false, isActive: true },
            blinds: { position: 50 },
            speaker: { isPlaying: false, volume: 30, trackIndex: 0 },
            
            // UI states
            activeScene: null,
            currentRoom: 'all',
            currentTab: 'devices',
            statusTimer: null,
            listening: false,
            currentMockWeatherIndex: 1,
            currentTheme: null,
            
            // Security states
            securityMode: 'disarmed', // 'armed_away', 'armed_home', 'disarmed'
            
            // User profile
            userProfile: {
                name: 'Samanth Nagpure',
                role: 'Home Administrator',
                preferences: {
                    voiceControl: true,
                    notifications: true,
                    autoLock: true,
                    energySaving: false,
                    securityAlerts: true,
                    guestAccess: false
                }
            },
            
            // Connected users
            connectedUsers: []
        },

        // --- 2. Static Configuration ---
        config: {
            playlist: [
                'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
                'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3',
                'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3'
            ],
            colorMap: { red: 0, orange: 30, yellow: 60, green: 120, cyan: 180, blue: 240, purple: 270, magenta: 300, pink: 330 },
            wordToNumberMap: { 'zero':0,'oh':0,'one':1,'two':2,'three':3,'four':4,'five':5,'six':6,'seven':7,'eight':8,'nine':9,'ten':10,'eleven':11,'twelve':12,'thirteen':13,'fourteen':14,'fifteen':15,'sixteen':16,'seventeen':17,'eighteen':18,'nineteen':19,'twenty':20,'thirty':30,'forty':40,'fifty':50,'sixty':60,'seventy':70,'eighty':80,'ninety':90,'hundred':100,'a':1 },
            mockWeather: [
                { desc: 'Sunny', temp: 78, icon: 'sun', color: 'text-yellow-400' },
                { desc: 'Partly Cloudy', temp: 75, icon: 'cloud-sun', color: 'text-yellow-400' },
                { desc: 'Cloudy', temp: 72, icon: 'cloud', color: 'text-gray-400' },
                { desc: 'Rain', temp: 68, icon: 'cloud-rain', color: 'text-blue-400' },
                { desc: 'Clear Night', temp: 65, icon: 'moon', color: 'text-blue-200' }
            ],
            scenes: {
                'goodMorning': {
                    message: "Activated 'Good Morning' scene.",
                    updates: {
                        bedLight: { intensity: 60, lastKnownIntensity: 60, hue: 40 },
                        fan: { speed: 0 },
                        thermostat: { temperature: 68, mode: 'Heat' },
                        lock: { isLocked: false },
                        blinds: { position: 30 }
                    }
                },
                'movieNight': {
                    message: "Activated 'Movie Night' scene.",
                    updates: {
                        bedLight: { intensity: 0 },
                        fan: { speed: 1, lastKnownSpeed: 1 },
                        lock: { isLocked: true },
                        blinds: { position: 0 }
                    },
                    audio: { volume: 40, play: true }
                },
                'goodNight': {
                    message: "Activated 'Good Night' scene.",
                    updates: {
                        bedLight: { intensity: 0 },
                        fan: { speed: 0 },
                        thermostat: { temperature: 65, mode: 'Heat' },
                        lock: { isLocked: true },
                        blinds: { position: 0 }
                    },
                    audio: { volume: 0, pause: true }
                },
                'allOff': {
                    message: "Turned all devices off.",
                    updates: {
                        bedLight: { intensity: 0 },
                        fan: { speed: 0 },
                        thermostat: { mode: 'Off' },
                        blinds: { position: 0 }
                    },
                    audio: { volume: 0, pause: true }
                },
                'partyTime': {
                    message: "Let's get this party started!",
                    updates: {
                        bedLight: { intensity: 80, lastKnownIntensity: 80, hue: 200 },
                        fan: { speed: 1, lastKnownSpeed: 1 },
                        thermostat: { temperature: 70, mode: 'Cool' },
                        lock: { isLocked: true },
                        blinds: { position: 50 }
                    },
                    audio: { volume: 70, play: true }
                },
                'focusMode': {
                    message: "Activating 'Focus Mode'.",
                    updates: {
                        bedLight: { intensity: 0 },
                        fan: { speed: 1, lastKnownSpeed: 1 },
                        thermostat: { temperature: 68, mode: 'Heat' },
                        lock: { isLocked: true },
                        blinds: { position: 70 }
                    },
                    audio: { volume: 0, pause: true }
                },
                'vacation': {
                    message: "Activating 'Vacation' mode.",
                    updates: {
                        bedLight: { intensity: 0 },
                        fan: { speed: 0 },
                        thermostat: { temperature: 62, mode: 'Cool' },
                        lock: { isLocked: true },
                        blinds: { position: 50 }
                    },
                    security: { mode: 'armed_away' }
                },
                'dinner': {
                    message: "Setting up for dinner.",
                    updates: {
                        bedLight: { intensity: 0 },
                        fan: { speed: 1, lastKnownSpeed: 1 },
                        lock: { isLocked: false },
                        blinds: { position: 30 }
                    }
                },
                'dateNight': {
                    message: "Creating romantic atmosphere.",
                    updates: {
                        bedLight: { intensity: 0 },
                        fan: { speed: 0 },
                        lock: { isLocked: true },
                        blinds: { position: 20 }
                    },
                    audio: { volume: 30, play: true }
                },
                'exercise': {
                    message: "Starting exercise mode.",
                    updates: {
                        bedLight: { intensity: 0 },
                        fan: { speed: 3, lastKnownSpeed: 3 },
                        thermostat: { temperature: 65, mode: 'Cool' },
                        blinds: { position: 80 }
                    },
                    audio: { volume: 60, play: true }
                },
                'reading': {
                    message: "Setting up reading environment.",
                    updates: {
                        bedLight: { intensity: 70, lastKnownIntensity: 70, hue: 50 },
                        fan: { speed: 0 },
                        blinds: { position: 60 }
                    }
                },
                'gaming': {
                    message: "Activating gaming mode.",
                    updates: {
                        bedLight: { intensity: 0 },
                        fan: { speed: 2, lastKnownSpeed: 2 },
                        thermostat: { temperature: 68, mode: 'Cool' },
                        blinds: { position: 10 }
                    },
                    audio: { volume: 50, play: true }
                }
            },
            commands: [
                // Scene commands
                { regex: /good morning/i, handler: () => SmartHub.EventHandlers.runScene('goodMorning') },
                { regex: /movie night/i, handler: () => SmartHub.EventHandlers.runScene('movieNight') },
                { regex: /good night/i, handler: () => SmartHub.EventHandlers.runScene('goodNight') },
                { regex: /(turn everything off|all off)/i, handler: () => SmartHub.EventHandlers.runScene('allOff') },
                { regex: /party time/i, handler: () => SmartHub.EventHandlers.runScene('partyTime') },
                { regex: /focus mode/i, handler: () => SmartHub.EventHandlers.runScene('focusMode') },
                { regex: /vacation mode/i, handler: () => SmartHub.EventHandlers.runScene('vacation') },
                { regex: /dinner time/i, handler: () => SmartHub.EventHandlers.runScene('dinner') },
                { regex: /date night/i, handler: () => SmartHub.EventHandlers.runScene('dateNight') },
                { regex: /exercise mode/i, handler: () => SmartHub.EventHandlers.runScene('exercise') },
                { regex: /reading mode/i, handler: () => SmartHub.EventHandlers.runScene('reading') },
                { regex: /gaming mode/i, handler: () => SmartHub.EventHandlers.runScene('gaming') },
                
                // Light commands
                { 
                    regex: /(bedroom light|bed light) (on|off)/i,
                    handler: (matches) => {
                        const state = SmartHub.state.bedLight;
                        if (matches[2] === 'on') {
                            state.intensity = state.lastKnownIntensity;
                        } else {
                            state.intensity = 0;
                        }
                        SmartHub.Speech.showStatus(`OK, turning ${matches[2]} the bedroom light.`);
                    }
                },
                { 
                    regex: /(turn on all lights|lights on)/i,
                    handler: () => {
                        SmartHub.state.bedLight.intensity = SmartHub.state.bedLight.lastKnownIntensity;
                        SmartHub.Speech.showStatus(`OK, turning on all lights.`);
                    }
                },
                { 
                    regex: /(turn off all lights|lights off)/i,
                    handler: () => {
                        SmartHub.state.bedLight.intensity = 0;
                        SmartHub.Speech.showStatus(`OK, turning off all lights.`);
                    }
                },
                { 
                    regex: /(set bedroom light to|set bed light to)/i,
                    handler: (matches, command) => SmartHub.EventHandlers.handleLightCommand(command, 'bedLight')
                },
                // Fan commands
                { 
                    regex: /fan (on|off)/i,
                    handler: (matches) => {
                        const state = SmartHub.state;
                        if (matches[1] === 'on') {
                            state.fan.speed = state.fan.lastKnownSpeed;
                            SmartHub.Speech.showStatus("OK, turning on the fan.");
                        } else {
                            state.fan.speed = 0;
                            SmartHub.Speech.showStatus("OK, turning off the fan.");
                        }
                    }
                },
                { 
                    regex: /set fan speed to/i,
                    handler: (matches, command) => {
                        const speed = SmartHub.Speech.parseNumber(command);
                        if (speed !== null && speed >= 0 && speed <= 5) {
                            SmartHub.state.fan.speed = speed;
                            if (speed > 0) SmartHub.state.fan.lastKnownSpeed = speed;
                            SmartHub.Speech.showStatus(`Set fan speed to level ${speed}.`);
                        } else {
                            SmartHub.Speech.showStatus("Sorry, fan speed is from 0 to 5.");
                        }
                    }
                },
                // Thermostat commands
                { 
                    regex: /set temperature to/i,
                    handler: (matches, command) => {
                        const temp = SmartHub.Speech.parseNumber(command);
                        if (temp) { 
                            SmartHub.state.thermostat.temperature = temp; 
                            SmartHub.Speech.showStatus(`Set temperature to ${temp} degrees.`); 
                        } else {
                            SmartHub.Speech.showStatus("Didn't catch the temperature.");
                        }
                    }
                },
                { regex: /(heat on|set to heat)/i, handler: () => { SmartHub.state.thermostat.mode = 'Heat'; SmartHub.Speech.showStatus("OK, heat mode is on."); } },
                { regex: /(ac on|set to cool|turn on ac)/i, handler: () => { SmartHub.state.thermostat.mode = 'Cool'; SmartHub.Speech.showStatus("OK, AC mode is on."); } },
                { regex: /thermostat off/i, handler: () => { SmartHub.state.thermostat.mode = 'Off'; SmartHub.Speech.showStatus("OK, thermostat is off."); } },
                // Lock commands
                { regex: /lock the door/i, handler: () => { SmartHub.state.lock.isLocked = true; SmartHub.Speech.showStatus("OK, front door is locked."); } },
                { regex: /unlock the door/i, handler: () => { SmartHub.state.lock.isLocked = false; SmartHub.Speech.showStatus("OK, front door is unlocked."); } },
                // Blinds commands
                { 
                    regex: /open blinds/i,
                    handler: () => {
                        SmartHub.state.blinds.position = 100;
                        SmartHub.Speech.showStatus("Opening blinds.");
                    }
                },
                { 
                    regex: /close blinds/i,
                    handler: () => {
                        SmartHub.state.blinds.position = 0;
                        SmartHub.Speech.showStatus("Closing blinds.");
                    }
                },
                { 
                    regex: /set blinds to/i,
                    handler: (matches, command) => {
                        const position = SmartHub.Speech.parseNumber(command);
                        if (position !== null && position >= 0 && position <= 100) {
                            SmartHub.state.blinds.position = position;
                            SmartHub.Speech.showStatus(`Setting blinds to ${position}%.`);
                        } else {
                            SmartHub.Speech.showStatus("Sorry, blinds position is from 0 to 100.");
                        }
                    }
                },
                // Security commands
                { regex: /arm away/i, handler: () => { SmartHub.state.securityMode = 'armed_away'; SmartHub.Speech.showStatus("Security system armed in away mode."); } },
                { regex: /arm home/i, handler: () => { SmartHub.state.securityMode = 'armed_home'; SmartHub.Speech.showStatus("Security system armed in home mode."); } },
                { regex: /disarm/i, handler: () => { SmartHub.state.securityMode = 'disarmed'; SmartHub.Speech.showStatus("Security system disarmed."); } },
                // Speaker commands
                { regex: /(play music|play)/i, handler: () => { SmartHub.AudioPlayer.play(); SmartHub.Speech.showStatus("OK, playing music."); } },
                { regex: /(pause music|pause|stop music|stop)/i, handler: () => { SmartHub.AudioPlayer.pause(); SmartHub.Speech.showStatus("OK, stopping music."); } },
                { regex: /(next track|skip)/i, handler: () => SmartHub.AudioPlayer.next() },
                { regex: /previous track/i, handler: () => SmartHub.AudioPlayer.prev() },
                { 
                    regex: /volume/i,
                    handler: (matches, command) => {
                        const vol = SmartHub.Speech.parseNumber(command);
                        if (vol !== null && vol >= 0 && vol <= 100) { 
                            SmartHub.AudioPlayer.setVolume(vol); 
                            SmartHub.Speech.showStatus(`Setting volume to ${vol}%`); 
                        } else {
                            SmartHub.Speech.showStatus("Didn't catch the volume level.");
                        }
                    }
                },
                // Tab navigation
                { regex: /show devices/i, handler: () => { SmartHub.UIUpdater.switchTab('devices'); SmartHub.Speech.showStatus("Showing devices."); } },
                { regex: /show scenes/i, handler: () => { SmartHub.UIUpdater.switchTab('scenes'); SmartHub.Speech.showStatus("Showing scenes."); } },
                { regex: /show automation/i, handler: () => { SmartHub.UIUpdater.switchTab('automation'); SmartHub.Speech.showStatus("Showing automation."); } },
                { regex: /show security/i, handler: () => { SmartHub.UIUpdater.switchTab('security'); SmartHub.Speech.showStatus("Showing security."); } },
                { regex: /show profile/i, handler: () => { SmartHub.UIUpdater.switchTab('profile'); SmartHub.Speech.showStatus("Showing profile."); } },
            ]
        },

        // --- 3. UI Element Cache ---
        UI: {},

        // --- 4. Main Initializer ---
        init: function() {
            // Initialize icons first
            createIcons();
            
            // --- UI Element Cache ---
            SmartHub.UI = {
              body: document.body,
              timeDisplay: document.getElementById('time-display'),
              ampmDisplay: document.getElementById('ampm-display'),
              dateDisplay: document.getElementById('date-display'),
              weather: {
                iconContainer: (function(){
                  const ico = document.getElementById('weather-icon');
                  if (!ico) return null;
                  const wrap = document.createElement('div');
                  wrap.id = 'weather-icon-container';
                  ico.parentNode.insertBefore(wrap, ico);
                  wrap.appendChild(ico);
                  return wrap;
                })(),
                temp: document.getElementById('weather-temp'),
                desc: document.getElementById('weather-desc')
              },
              // Light devices
              bedLight: {
                card: document.getElementById('bed-light-card'),
                intensity: document.getElementById('bed-light-intensity'),
                statusText: document.getElementById('bed-light-status-text'),
                icon: document.getElementById('bed-light-icon'),
                colorSlider: document.getElementById('bed-light-color'),
                intensityTooltip: document.getElementById('bed-light-intensity-tooltip'),
                colorTooltip: document.getElementById('bed-light-color-tooltip')
              },
              // Other devices
              fan: {
                card: document.getElementById('fan-card'),
                speed: document.getElementById('fan-speed'),
                statusText: document.getElementById('fan-status-text'),
                icon: document.getElementById('fan-icon'),
                speedTooltip: document.getElementById('fan-speed-tooltip')
              },
              thermostat: {
                card: document.getElementById('thermostat-card'),
                display: document.getElementById('temp-display'),
                modeDisplay: document.getElementById('temp-mode-display'),
                icon: document.getElementById('thermostat-icon'),
                tempUp: document.getElementById('temp-up'),
                tempDown: document.getElementById('temp-down'),
                modeContainer: document.getElementById('temp-mode-container'),
                modeButtons: document.querySelectorAll('.temp-mode-button')
              },
              lock: {
                card: document.getElementById('lock-card'),
                iconLocked: document.getElementById('lock-icon-locked'),
                iconUnlocked: document.getElementById('lock-icon-unlocked'),
                button: document.getElementById('lock-toggle-button')
              },
              camera: {
                card: document.getElementById('camera-card'),
                icon: document.getElementById('camera-icon'),
                statusText: document.getElementById('camera-status-text'),
                recordButton: document.getElementById('camera-record-button'),
                snapshotButton: document.getElementById('camera-snapshot-button')
              },
              blinds: {
                card: document.getElementById('blinds-card'),
                icon: document.getElementById('blinds-icon'),
                statusText: document.getElementById('blinds-status-text'),
                position: document.getElementById('blinds-position'),
                positionTooltip: document.getElementById('blinds-position-tooltip')
              },
              speaker: {
                card: document.getElementById('speaker-card'),
                icon: document.getElementById('speaker-icon'),
                volume: document.getElementById('speaker-volume'),
                value: document.getElementById('speaker-volume-value'),
                volumeTooltip: document.getElementById('speaker-volume-tooltip'),
                playButton: document.getElementById('play-pause'),
                playIcon: document.getElementById('play-icon'),
                pauseIcon: document.getElementById('pause-icon'),
                prevButton: document.getElementById('prev-track'),
                nextButton: document.getElementById('next-track'),
                trackTitle: document.getElementById('track-title'),
                nowIcon: document.getElementById('now-playing-icon'),
                nowText: document.getElementById('now-playing-text')
              },
              // Scenes
              scenes: {
                goodMorning: document.getElementById('scene-good-morning'),
                movieNight: document.getElementById('scene-movie-night'),
                goodNight: document.getElementById('scene-good-night'),
                allOff: document.getElementById('scene-all-off'),
                partyTime: document.getElementById('scene-party-time'),
                focusMode: document.getElementById('scene-focus-mode'),
                vacation: document.getElementById('scene-vacation'),
                dinner: document.getElementById('scene-dinner'),
                dateNight: document.getElementById('scene-date-night'),
                exercise: document.getElementById('scene-exercise'),
                reading: document.getElementById('scene-reading'),
                gaming: document.getElementById('scene-gaming')
              },
              // Voice control
              voice: {
                micButton: document.getElementById('mic-button'),
                micIcon: document.getElementById('mic-icon'),
                micActiveIcon: document.getElementById('mic-active-icon'),
                statusMessage: document.getElementById('status-message'),
                transcriptDisplay: document.getElementById('transcript-display')
              },
              // Modals
              addDeviceCard: document.getElementById('add-device-button'),
              modal: {
                overlay: document.getElementById('modal-overlay'),
                box: document.getElementById('modal-box'),
                closeButton: document.getElementById('modal-close-button')
              },
              automationModal: {
                overlay: document.getElementById('automation-modal-overlay'),
                box: document.getElementById('automation-modal-box'),
                closeButton: document.getElementById('automation-modal-close-button'),
                addButton: document.getElementById('add-automation-button')
              },
              userModal: {
                overlay: document.getElementById('user-modal-overlay'),
                box: document.getElementById('user-modal-box'),
                closeButton: document.getElementById('user-modal-close-button'),
                addButton: document.getElementById('add-user-button'),
                form: document.getElementById('user-form'),
                usersContainer: document.getElementById('users-container')
              },
              // Security
              security: {
                armAwayButton: document.getElementById('arm-away-button'),
                armHomeButton: document.getElementById('arm-home-button'),
                disarmButton: document.getElementById('disarm-button')
              },
              // Tab navigation
              tabs: {
                devices: document.getElementById('devices-tab'),
                scenes: document.getElementById('scenes-tab'),
                automation: document.getElementById('automation-tab'),
                security: document.getElementById('security-tab'),
                profile: document.getElementById('profile-tab')
              },
              tabButtons: document.querySelectorAll('[data-tab]'),
              // Room filtering
              room: {
                tabContainer: document.getElementById('room-tab-container'),
                tabs: document.querySelectorAll('.room-tab-button'),
                deviceGrid: document.getElementById('device-grid'),
                allDevices: document.querySelectorAll('#device-grid .device-card')
              },
              // Notifications
              notificationContainer: document.getElementById('notification-container'),
              // Audio
              audioElement: document.getElementById('audio-player')
            };

            // --- Initialize Modules ---
            SmartHub.Persistence.loadState();
            SmartHub.AudioPlayer.init();
            SmartHub.Speech.init();
            SmartHub.EventHandlers.registerAll();
            SmartHub.Notifications.init();
            SmartHub.UserManager.init();

            // --- Run Initial Updates ---
            SmartHub.UIUpdater.updateAllUIs();
            SmartHub.HeaderDisplay.updateClock();
            SmartHub.HeaderDisplay.updateWeather(); 
            SmartHub.UIUpdater.filterDevicesByRoom();
            SmartHub.UIUpdater.switchTab(SmartHub.state.currentTab);
            
            // --- Start Timers ---
            setInterval(() => SmartHub.HeaderDisplay.updateClock(), 1000); 
            setInterval(() => SmartHub.HeaderDisplay.updateWeather(), 300000); 
        },
        
        // --- 5. Persistence Module ---
        Persistence: {
            saveState: function() {
                try {
                    const stateToSave = { ...SmartHub.state };
                    // Delete transient state
                    delete stateToSave.statusTimer;
                    delete stateToSave.listening;
                    delete stateToSave.activeScene;
                    delete stateToSave.currentTheme;
                    localStorage.setItem('smartHubState', JSON.stringify(stateToSave));
                } catch (e) {
                    console.warn("Could not save state to localStorage", e);
                }
            },
            loadState: function() {
                try {
                    const savedState = localStorage.getItem('smartHubState');
                    if (savedState) {
                        const parsedState = JSON.parse(savedState);
                        Object.assign(SmartHub.state, parsedState);
                        // Reset transient state
                        SmartHub.state.listening = false;
                        SmartHub.state.statusTimer = null;
                        SmartHub.state.activeScene = null;
                        SmartHub.state.currentTheme = null;
                    }
                } catch (e) {
                    console.warn("Could not load state from localStorage", e);
                }
            }
        },

        // --- 6. Audio Player Module ---
        AudioPlayer: {
            init: function() {
                const el = SmartHub.UI.audioElement;
                if (!el) { console.warn("Audio element not found."); return; }
                el.volume = SmartHub.state.speaker.volume / 100;
                el.addEventListener('ended', () => SmartHub.AudioPlayer.next());
                el.addEventListener('play', () => {
                    SmartHub.state.speaker.isPlaying = true;
                    SmartHub.UIUpdater.updateSpeakerUI();
                });
                el.addEventListener('pause', () => {
                    SmartHub.state.speaker.isPlaying = false;
                    SmartHub.UIUpdater.updateSpeakerUI();
                });
            },
            loadTrack: function(index) {
                const el = SmartHub.UI.audioElement;
                if (!el) return;
                const playlist = SmartHub.config.playlist;
                if (!playlist.length) return;
                
                SmartHub.state.speaker.trackIndex = ((index % playlist.length) + playlist.length) % playlist.length;
                const file = playlist[SmartHub.state.speaker.trackIndex];
                
                el.src = file;
                el.load();
                if (SmartHub.UI.speaker.trackTitle) {
                    SmartHub.UI.speaker.trackTitle.textContent = file.split('/').pop().replace('.mp3', '');
                }
                SmartHub.Persistence.saveState();
            },
            play: function() {
                const el = SmartHub.UI.audioElement;
                if (!el) return;
                if (!el.src) {
                    this.loadTrack(SmartHub.state.speaker.trackIndex);
                }
                const p = el.play();
                if (p && p.catch) {
                    p.catch(err => {
                        console.warn("Audio playback error:", err);
                        SmartHub.Speech.showStatus('Tap play to enable audio playback.', 4000, false);
                    });
                }
            },
            pause: function() {
                const el = SmartHub.UI.audioElement;
                if (!el) return;
                el.pause();
            },
            next: function() {
                this.loadTrack(SmartHub.state.speaker.trackIndex + 1);
                this.play();
                SmartHub.Speech.showStatus('Skipped to next track', 2000, false);
            },
            prev: function() {
                this.loadTrack(SmartHub.state.speaker.trackIndex - 1);
                this.play();
                SmartHub.Speech.showStatus('Playing previous track', 2000, false);
            },
            setVolume: function(v) {
                const el = SmartHub.UI.audioElement;
                if (!el) return;
                const value = Math.max(0, Math.min(100, Number(v)));
                SmartHub.state.speaker.volume = value;
                el.volume = value / 100;
                SmartHub.UIUpdater.updateSpeakerUI();
            }
        },
        
        // --- 7. Header Display Module ---
        HeaderDisplay: {
            updateClock: function() {
                const now = new Date();
                const UI = SmartHub.UI;
                
                if (UI.dateDisplay) {
                    UI.dateDisplay.textContent = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                }
                
                let hours = now.getHours();
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const seconds = now.getSeconds().toString().padStart(2, '0');
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 ? (hours % 12) : 12; 
                
                if (UI.timeDisplay) {
                    UI.timeDisplay.textContent = `${displayHours.toString().padStart(2, ' ')}:${minutes}:${seconds}`;
                }
                if (UI.ampmDisplay) {
                    UI.ampmDisplay.textContent = ampm;
                }
                
                let newTheme = 'theme-day';
                if (hours >= 5 && hours < 12) newTheme = 'theme-morning';
                else if (hours >= 12 && hours < 18) newTheme = 'theme-day';
                else if (hours >= 18 && hours < 22) newTheme = 'theme-evening';
                else newTheme = 'theme-night';

                if (newTheme !== SmartHub.state.currentTheme && UI.body) {
                    if (SmartHub.state.currentTheme) UI.body.classList.remove(SmartHub.state.currentTheme);
                    UI.body.classList.add(newTheme);
                    SmartHub.state.currentTheme = newTheme;
                }
            },
           updateWeather: function() {
                const mockWeather = SmartHub.config.mockWeather;
                SmartHub.state.currentMockWeatherIndex = (SmartHub.state.currentMockWeatherIndex + 1) % mockWeather.length;
                const weather = mockWeather[SmartHub.state.currentMockWeatherIndex];
                
                const tempFluctuation = Math.floor(Math.random() * 3) - 1; 
                const displayTemp = weather.temp + tempFluctuation;
                
                if (SmartHub.UI.weather && SmartHub.UI.weather.temp && SmartHub.UI.weather.iconContainer) {
                    SmartHub.UI.weather.temp.innerHTML = `${displayTemp}&deg;F`;
                    SmartHub.UI.weather.desc.textContent = weather.desc;
                    SmartHub.UI.weather.iconContainer.innerHTML = `<i data-lucide="${weather.icon}" class="w-10 h-10 ${weather.color}"></i>`;
                    
                    // Recreate icons after updating weather
                    createIcons();
                }
            }
        },

        // --- 8. UI Updater Module ---
        UIUpdater: {
            updateSliderBackground: function(slider, color = '#3b82f6') {
                if (!slider) return;
                const value = (slider.value - slider.min) / (slider.max - slider.min) * 100;
                slider.style.background = `linear-gradient(to right, ${color} ${value}%, #374151 ${value}%)`;
            },

            _updateLightUI: function(state, UI) {
                if (!UI || !UI.card) return;
                const { intensity, hue } = state;
                const isOn = intensity > 0;
                const color = `hsl(${hue}, 100%, 50%)`;
                
                UI.card.style.setProperty('--light-hue', hue);
                UI.intensity.style.setProperty('--thumb-border-color', isOn ? color : '#3b82f6');

                UI.intensity.value = intensity;
                UI.colorSlider.value = hue;
                SmartHub.UIUpdater.updateSliderBackground(UI.intensity, color);
                
                if (UI.intensityTooltip) UI.intensityTooltip.textContent = `${intensity}%`;
                if (UI.colorTooltip) {
                    UI.colorTooltip.textContent = `Hue: ${hue}°`;
                    UI.colorTooltip.style.backgroundColor = color;
                }

                if (isOn) {
                    UI.card.classList.add('card-is-active');
                    UI.icon.classList.add('icon-on');
                    if (UI.statusText) UI.statusText.textContent = `${intensity}%`;
                } else {
                    UI.card.classList.remove('card-is-active');
                    UI.icon.classList.remove('icon-on');
                    if (UI.statusText) UI.statusText.textContent = "Off";
                }
                
                UI.card.setAttribute('aria-pressed', isOn ? 'true' : 'false');
            },
            
            updateBedLightUI: function() {
                SmartHub.UIUpdater._updateLightUI(SmartHub.state.bedLight, SmartHub.UI.bedLight);
                SmartHub.Persistence.saveState();
            },

            updateFanUI: function() {
                const { speed } = SmartHub.state.fan;
                const isOn = speed > 0;
                const UI = SmartHub.UI.fan;
                if (!UI || !UI.card) return;
                const color = `hsl(${UI.card.style.getPropertyValue('--fan-hue') || 200}, 100%, 50%)`;
                UI.speed.value = speed;
                UI.speed.style.setProperty('--thumb-border-color', isOn ? color : '#3b82f6');
                SmartHub.UIUpdater.updateSliderBackground(UI.speed, color);
                if (UI.speedTooltip) UI.speedTooltip.textContent = `Level ${speed}`;
                if (isOn) {
                    UI.card.classList.add('card-is-active');
                    UI.icon.classList.add('icon-fan-on', 'animate-spin');
                    if (UI.statusText) UI.statusText.textContent = `Level ${speed}`;
                    const duration = Math.max(0.5, 6 - speed); 
                    UI.icon.style.animationDuration = `${duration}s`;
                } else {
                    UI.card.classList.remove('card-is-active');
                    UI.icon.classList.remove('icon-fan-on', 'animate-spin');
                    if (UI.statusText) UI.statusText.textContent = "Off";
                    UI.icon.style.animationDuration = ``;
                }
                UI.card.setAttribute('aria-pressed', isOn ? 'true' : 'false');
                SmartHub.Persistence.saveState();
            },
            updateThermostatUI: function() {
                const { temperature, mode } = SmartHub.state.thermostat;
                const UI = SmartHub.UI.thermostat;
                if (!UI || !UI.card) return;
                UI.display.textContent = `${temperature}\u00B0`;
                UI.modeDisplay.textContent = `Mode: ${mode}`;
                UI.icon.classList.remove('text-red-500', 'text-blue-500', 'text-gray-500');
                UI.card.classList.remove('card-active-red', 'card-active-blue');
                UI.modeButtons.forEach(btn => {
                    btn.classList.remove('bg-gray-600', 'text-white');
                    const icon = btn.querySelector('i');
                    if (icon) { icon.classList.add('text-gray-500'); icon.classList.remove('text-red-500', 'text-blue-500', 'text-white'); }
                });
                let activeBtn;
                if (mode === 'Heat') { 
                    UI.icon.classList.add('text-red-500'); 
                    UI.card.classList.add('card-active-red'); 
                    activeBtn = document.getElementById('temp-mode-heat'); 
                    if (activeBtn) activeBtn.querySelector('i').classList.add('text-red-500'); 
                }
                else if (mode === 'Cool') { 
                    UI.icon.classList.add('text-blue-500'); 
                    UI.card.classList.add('card-active-blue'); 
                    activeBtn = document.getElementById('temp-mode-cool'); 
                    if (activeBtn) activeBtn.querySelector('i').classList.add('text-blue-500'); 
                }
                else { 
                    UI.icon.classList.add('text-gray-500');
                    activeBtn = document.getElementById('temp-mode-off'); 
                    if (activeBtn) activeBtn.querySelector('i').classList.add('text-white'); 
                }
                if (activeBtn) activeBtn.classList.add('bg-gray-600');
                SmartHub.Persistence.saveState();
            },
            updateLockUI: function() {
                const { isLocked } = SmartHub.state.lock;
                const UI = SmartHub.UI.lock;
                if (!UI || !UI.card) return;
                if (isLocked) {
                    UI.iconLocked.classList.remove('hidden');
                    UI.iconUnlocked.classList.add('hidden');
                    UI.button.textContent = 'Unlock';
                    UI.button.classList.add('bg-gray-700', 'hover:bg-gray-600');
                    UI.button.classList.remove('bg-green-600', 'hover:bg-green-500');
                    UI.card.classList.add('card-active-red');
                    UI.card.classList.remove('card-active-green');
                } else {
                    UI.iconLocked.classList.add('hidden');
                    UI.iconUnlocked.classList.remove('hidden');
                    UI.button.textContent = 'Lock';
                    UI.button.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                    UI.button.classList.add('bg-green-600', 'hover:bg-green-500');
                    UI.card.classList.remove('card-active-red');
                    UI.card.classList.add('card-active-green');
                }
                SmartHub.Persistence.saveState();
            },
            updateCameraUI: function() {
                const { isRecording, isActive } = SmartHub.state.camera;
                const UI = SmartHub.UI.camera;
                if (!UI || !UI.card) return;
                
                if (isActive) {
                    UI.statusText.textContent = "Active";
                    UI.statusText.classList.remove('text-gray-400');
                    UI.statusText.classList.add('text-green-500');
                    UI.icon.classList.remove('text-gray-500');
                    UI.icon.classList.add('text-green-500');
                } else {
                    UI.statusText.textContent = "Inactive";
                    UI.statusText.classList.remove('text-green-500');
                    UI.statusText.classList.add('text-gray-400');
                    UI.icon.classList.remove('text-green-500');
                    UI.icon.classList.add('text-gray-500');
                }
                
                if (isRecording) {
                    UI.recordButton.textContent = "Stop Recording";
                    UI.recordButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                    UI.recordButton.classList.add('bg-gray-600', 'hover:bg-gray-700');
                } else {
                    UI.recordButton.textContent = "Record";
                    UI.recordButton.classList.add('bg-red-600', 'hover:bg-red-700');
                    UI.recordButton.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                }
                
                SmartHub.Persistence.saveState();
            },
            updateBlindsUI: function() {
                const { position } = SmartHub.state.blinds;
                const UI = SmartHub.UI.blinds;
                if (!UI || !UI.card) return;
                
                UI.position.value = position;
                UI.statusText.textContent = `${position}%`;
                if (UI.positionTooltip) UI.positionTooltip.textContent = `${position}%`;
                SmartHub.UIUpdater.updateSliderBackground(UI.position, '#3b82f6');
                
                SmartHub.Persistence.saveState();
            },
            updateSpeakerUI: function() {
                const { isPlaying, volume, trackIndex } = SmartHub.state.speaker;
                const UI = SmartHub.UI.speaker;
                if (!UI || !UI.card) return; 
                const trackName = (SmartHub.config.playlist[trackIndex] || 'Unknown track').split('/').pop().replace('.mp3', '');
                UI.volume.value = volume;
                UI.value.textContent = `${volume}%`;
                if (UI.volumeTooltip) UI.volumeTooltip.textContent = `${volume}%`;
                SmartHub.UIUpdater.updateSliderBackground(UI.volume, '#a78bfa');
                UI.playButton.setAttribute('aria-label', isPlaying ? 'Pause Music' : 'Play Music');
                if (isPlaying) {
                    UI.playIcon.classList.add('hidden');
                    UI.pauseIcon.classList.remove('hidden');
                    UI.icon.classList.add('text-purple-400');
                    UI.card.classList.add('card-active-purple');
                    UI.trackTitle.textContent = `Playing: ${trackName}`;
                    UI.nowIcon.classList.add('text-purple-400', 'glow-animate');
                    UI.nowText.textContent = 'Now Playing';
                    UI.nowText.classList.add('text-purple-300');
                } else {
                    UI.playIcon.classList.remove('hidden');
                    UI.pauseIcon.classList.add('hidden');
                    UI.icon.classList.remove('text-purple-400');
                    UI.card.classList.remove('card-active-purple');
                    UI.trackTitle.textContent = SmartHub.UI.audioElement && SmartHub.UI.audioElement.src ? `Paused: ${trackName}` : 'Paused';
                    UI.nowIcon.classList.remove('text-purple-400', 'glow-animate');
                    UI.nowText.textContent = 'Idle';
                    UI.nowText.classList.remove('text-purple-300');
                }
                SmartHub.Persistence.saveState();
            },
            updateActiveScene: function() {
                Object.values(SmartHub.UI.scenes).forEach(button => {
                    if (button) button.classList.remove('active');
                });
                const key = SmartHub.state.activeScene;
                if (key && SmartHub.UI.scenes[key]) SmartHub.UI.scenes[key].classList.add('active');
            },
            updateSecurityUI: function() {
                const { securityMode } = SmartHub.state;
                const UI = SmartHub.UI.security;
                
                // Update button states
                if (securityMode === 'armed_away') {
                    UI.armAwayButton.classList.add('bg-red-700');
                    UI.armHomeButton.classList.remove('bg-yellow-700');
                    UI.disarmButton.classList.remove('bg-gray-700');
                } else if (securityMode === 'armed_home') {
                    UI.armAwayButton.classList.remove('bg-red-700');
                    UI.armHomeButton.classList.add('bg-yellow-700');
                    UI.disarmButton.classList.remove('bg-gray-700');
                } else {
                    UI.armAwayButton.classList.remove('bg-red-700');
                    UI.armHomeButton.classList.remove('bg-yellow-700');
                    UI.disarmButton.classList.add('bg-gray-700');
                }
                
                SmartHub.Persistence.saveState();
            },
            filterDevicesByRoom: function() {
                const newRoom = SmartHub.state.currentRoom;
                const UI = SmartHub.UI.room;
                
                // Update Tab active states
                UI.tabs.forEach(tab => {
                    if (tab.dataset.room === newRoom) {
                        tab.classList.add('active');
                    } else {
                        tab.classList.remove('active');
                    }
                });

                // Filter device cards
                UI.allDevices.forEach(card => {
                    const cardRoom = card.dataset.room;
                    if (newRoom === 'all' || cardRoom === 'all' || cardRoom === newRoom) {
                        card.classList.remove('device-hidden');
                    } else {
                        card.classList.add('device-hidden');
                    }
                });
            },
            switchTab: function(tabName) {
                const UI = SmartHub.UI;
                
                // Update tab button states
                UI.tabButtons.forEach(button => {
                    if (button.dataset.tab === tabName) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                });
                
                // Show/hide tab content
                Object.keys(UI.tabs).forEach(key => {
                    if (key === tabName) {
                        UI.tabs[key].classList.remove('hidden');
                    } else {
                        UI.tabs[key].classList.add('hidden');
                    }
                });
                
                SmartHub.state.currentTab = tabName;
                SmartHub.Persistence.saveState();
            },
            updateAllUIs: function() {
                this.updateBedLightUI();
                this.updateFanUI();
                this.updateThermostatUI();
                this.updateLockUI();
                this.updateCameraUI();
                this.updateBlindsUI();
                this.updateSpeakerUI();
                this.updateActiveScene();
                this.updateSecurityUI();
            }
        },
        
        // --- 9. Event Handlers Module ---
        EventHandlers: {
            registerAll: function() {
                const UI = SmartHub.UI;
                const Handlers = SmartHub.EventHandlers;

                // Tab navigation
                UI.tabButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        const tabName = e.currentTarget.dataset.tab;
                        SmartHub.UIUpdater.switchTab(tabName);
                    });
                });

                // Bedroom Light
                if (UI.bedLight.card) {
                    UI.bedLight.card.addEventListener('click', (e) => Handlers.lightCardClickHandler(e, 'bedLight'));
                    UI.bedLight.card.addEventListener('keydown', (e) => Handlers.handleCardKeyPress(e, (e) => Handlers.lightCardClickHandler(e, 'bedLight')));
                    UI.bedLight.intensity.addEventListener('input', (e) => {
                        const newValue = Number(e.target.value);
                        SmartHub.state.bedLight.intensity = newValue;
                        if (newValue > 0) { SmartHub.state.bedLight.lastKnownIntensity = newValue; }
                        SmartHub.UIUpdater.updateBedLightUI();
                    });
                    UI.bedLight.colorSlider.addEventListener('input', (e) => { 
                        SmartHub.state.bedLight.hue = e.target.value; 
                        if (SmartHub.state.bedLight.intensity === 0) { SmartHub.state.bedLight.intensity = SmartHub.state.bedLight.lastKnownIntensity; }
                        SmartHub.UIUpdater.updateBedLightUI(); 
                    });
                }

                // Fan
                if (UI.fan.card) {
                    UI.fan.card.addEventListener('click', Handlers.fanCardClickHandler);
                    UI.fan.card.addEventListener('keydown', (e) => Handlers.handleCardKeyPress(e, Handlers.fanCardClickHandler));
                    UI.fan.speed.addEventListener('input', (e) => {
                        const newValue = Number(e.target.value);
                        SmartHub.state.fan.speed = newValue;
                        if (newValue > 0) { SmartHub.state.fan.lastKnownSpeed = newValue; }
                        SmartHub.UIUpdater.updateFanUI();
                    });
                }

                // Thermostat
                if (UI.thermostat.tempUp) {
                    UI.thermostat.tempUp.addEventListener('click', () => { SmartHub.state.thermostat.temperature++; SmartHub.UIUpdater.updateThermostatUI(); });
                    UI.thermostat.tempDown.addEventListener('click', () => { SmartHub.state.thermostat.temperature--; SmartHub.UIUpdater.updateThermostatUI(); });
                    UI.thermostat.modeContainer.addEventListener('click', (e) => { 
                        const btn = e.target.closest('.temp-mode-button'); 
                        if (btn && btn.dataset.mode) { 
                            SmartHub.state.thermostat.mode = btn.dataset.mode; 
                            SmartHub.UIUpdater.updateThermostatUI(); 
                        } 
                    });
                }

                // Lock
                if (UI.lock.button) {
                    UI.lock.button.addEventListener('click', () => { SmartHub.state.lock.isLocked = !SmartHub.state.lock.isLocked; SmartHub.UIUpdater.updateLockUI(); });
                }

                // Camera
                if (UI.camera.recordButton) {
                    UI.camera.recordButton.addEventListener('click', () => {
                        SmartHub.state.camera.isRecording = !SmartHub.state.camera.isRecording;
                        SmartHub.UIUpdater.updateCameraUI();
                        SmartHub.Notifications.show(
                            SmartHub.state.camera.isRecording ? 'Camera recording started' : 'Camera recording stopped',
                            SmartHub.state.camera.isRecording ? 'warning' : 'info'
                        );
                    });
                    UI.camera.snapshotButton.addEventListener('click', () => {
                        SmartHub.Notifications.show('Snapshot captured', 'success');
                    });
                }

                // Blinds
                if (UI.blinds.position) {
                    UI.blinds.position.addEventListener('input', (e) => {
                        SmartHub.state.blinds.position = Number(e.target.value);
                        SmartHub.UIUpdater.updateBlindsUI();
                    });
                }

                // Speaker
                if (UI.speaker.volume) {
                    UI.speaker.volume.addEventListener('input', (e) => SmartHub.AudioPlayer.setVolume(Number(e.target.value)));
                    UI.speaker.playButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (!SmartHub.state.speaker.isPlaying) { 
                            SmartHub.AudioPlayer.play();
                        } else {
                            SmartHub.AudioPlayer.pause();
                        }
                    });
                    UI.speaker.nextButton.addEventListener('click', (e) => { e.stopPropagation(); SmartHub.AudioPlayer.next(); });
                    UI.speaker.prevButton.addEventListener('click', (e) => { e.stopPropagation(); SmartHub.AudioPlayer.prev(); });
                }

                // Scenes
                Object.values(UI.scenes).forEach(button => { 
                    if (button) button.addEventListener('click', (e) => Handlers.runScene(e.currentTarget.dataset.scene)); 
                });

                // Room filtering
                if (UI.room.tabContainer) {
                    UI.room.tabContainer.addEventListener('click', (e) => {
                        const button = e.target.closest('.room-tab-button');
                        if (button && button.dataset.room) {
                            SmartHub.state.currentRoom = button.dataset.room;
                            SmartHub.UIUpdater.filterDevicesByRoom();
                        }
                    });
                }

                // Modals
                if (UI.addDeviceCard) {
                    UI.addDeviceCard.addEventListener('click', SmartHub.Modal.open);
                    UI.addDeviceCard.addEventListener('keydown', (e) => Handlers.handleCardKeyPress(e, SmartHub.Modal.open));
                }
                if (UI.modal.closeButton) {
                    UI.modal.closeButton.addEventListener('click', SmartHub.Modal.close);
                    UI.modal.overlay.addEventListener('click', SmartHub.Modal.close);
                }
                if (UI.automationModal.addButton) {
                    UI.automationModal.addButton.addEventListener('click', SmartHub.AutomationModal.open);
                }
                if (UI.automationModal.closeButton) {
                    UI.automationModal.closeButton.addEventListener('click', SmartHub.AutomationModal.close);
                    UI.automationModal.overlay.addEventListener('click', SmartHub.AutomationModal.close);
                }

                // Security
                if (UI.security.armAwayButton) {
                    UI.security.armAwayButton.addEventListener('click', () => {
                        SmartHub.state.securityMode = 'armed_away';
                        SmartHub.UIUpdater.updateSecurityUI();
                        SmartHub.Notifications.show('Security system armed in away mode', 'warning');
                    });
                    UI.security.armHomeButton.addEventListener('click', () => {
                        SmartHub.state.securityMode = 'armed_home';
                        SmartHub.UIUpdater.updateSecurityUI();
                        SmartHub.Notifications.show('Security system armed in home mode', 'warning');
                    });
                    UI.security.disarmButton.addEventListener('click', () => {
                        SmartHub.state.securityMode = 'disarmed';
                        SmartHub.UIUpdater.updateSecurityUI();
                        SmartHub.Notifications.show('Security system disarmed', 'info');
                    });
                }

                // Ripple effects
                document.querySelectorAll(".ripple-button").forEach(button => {
                    button.addEventListener("click", SmartHub.Effects.createRipple);
                });

                // Voice control
                if (UI.voice.micButton) {
                    UI.voice.micButton.addEventListener('click', () => SmartHub.Speech.toggleListen());
                }
            },

            lightCardClickHandler: function(e, lightKey) {
                if (e.target.closest('.collapsible-controls')) return;
                
                const state = SmartHub.state[lightKey];
                const updater = lightKey === 'bedLight' ? SmartHub.UIUpdater.updateBedLightUI : null;

                if (state.intensity > 0) {
                    state.intensity = 0;
                } else {
                    state.intensity = state.lastKnownIntensity;
                }
                if (updater) updater();
            },
            
            handleLightCommand: function(command, lightKey) {
                const state = SmartHub.state[lightKey];
                const parser = SmartHub.Speech.parseNumber;
                const colorMap = SmartHub.config.colorMap;
                
                const colorWord = Object.keys(colorMap).find(c => command.includes(c));
                const intensity = parser(command);
                const lightName = lightKey === 'bedLight' ? 'Bedroom light' : '';

                if (colorWord) {
                    state.hue = colorMap[colorWord];
                    if (state.intensity === 0) state.intensity = state.lastKnownIntensity;
                    SmartHub.Speech.showStatus(`Set ${lightName} color to ${colorWord}.`);
                } else if (intensity !== null && intensity >= 0 && intensity <= 100) {
                    state.intensity = intensity;
                    if (intensity > 0) state.lastKnownIntensity = intensity;
                    SmartHub.Speech.showStatus(`Set ${lightName} intensity to ${intensity}%.`);
                } else {
                    SmartHub.Speech.showStatus("Didn't catch that. Try 'set light to 50%' or 'set light to blue'.");
                }
            },

            fanCardClickHandler: function(e) {
                if (e.target.closest('.collapsible-controls')) return;
                if (SmartHub.state.fan.speed > 0) {
                    SmartHub.state.fan.speed = 0;
                } else {
                    SmartHub.state.fan.speed = SmartHub.state.fan.lastKnownSpeed;
                }
                SmartHub.UIUpdater.updateFanUI();
            },

            handleCardKeyPress: function(event, clickHandler) {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    clickHandler(event);
                }
            },

            runScene: function(sceneName) {
                const scene = SmartHub.config.scenes[sceneName];
                if (!scene) {
                    console.warn(`Scene "${sceneName}" not found.`);
                    return;
                }
                SmartHub.state.activeScene = sceneName;
                if (scene.updates) {
                    for (const key in scene.updates) {
                        if (SmartHub.state[key]) {
                            Object.assign(SmartHub.state[key], scene.updates[key]);
                        }
                    }
                }
                if (scene.security) {
                    for (const key in scene.security) {
                        SmartHub.state[key] = scene.security[key];
                    }
                    SmartHub.UIUpdater.updateSecurityUI();
                }
                if (scene.audio) {
                    if (scene.audio.volume !== undefined) {
                        SmartHub.AudioPlayer.setVolume(scene.audio.volume);
                    }
                    if (scene.audio.play) {
                        SmartHub.AudioPlayer.play();
                    } else if (scene.audio.pause) {
                        SmartHub.AudioPlayer.pause();
                    }
                }
                SmartHub.Speech.showStatus(scene.message);
                SmartHub.UIUpdater.updateAllUIs();
                SmartHub.Notifications.show(scene.message, 'success');
            }
        },
        
        // --- 10. Modal Module ---
        Modal: {
            open: function() {
                if (!SmartHub.UI.modal.overlay) return; 
                SmartHub.UI.modal.overlay.classList.remove('modal-hidden');
                SmartHub.UI.modal.box.classList.remove('modal-hidden');
                
                // Recreate icons after modal opens
                setTimeout(() => {
                    createIcons();
                }, 10);
                
                setTimeout(() => {
                    SmartHub.UI.modal.overlay.classList.add('active');
                    SmartHub.UI.modal.box.classList.add('active');
                }, 10);
            },
            close: function() {
                if (!SmartHub.UI.modal.overlay) return;
                SmartHub.UI.modal.overlay.classList.remove('active');
                SmartHub.UI.modal.box.classList.remove('active');
                setTimeout(() => {
                    SmartHub.UI.modal.overlay.classList.add('modal-hidden');
                    SmartHub.UI.modal.box.classList.add('modal-hidden');
                }, 300);
            }
        },

        // --- 11. Automation Modal Module ---
        AutomationModal: {
            open: function() {
                if (!SmartHub.UI.automationModal.overlay) return; 
                SmartHub.UI.automationModal.overlay.classList.remove('modal-hidden');
                SmartHub.UI.automationModal.box.classList.remove('modal-hidden');
                
                // Recreate icons after modal opens
                setTimeout(() => {
                    createIcons();
                }, 10);
                
                setTimeout(() => {
                    SmartHub.UI.automationModal.overlay.classList.add('active');
                    SmartHub.UI.automationModal.box.classList.add('active');
                }, 10);
            },
            close: function() {
                if (!SmartHub.UI.automationModal.overlay) return;
                SmartHub.UI.automationModal.overlay.classList.remove('active');
                SmartHub.UI.automationModal.box.classList.remove('active');
                setTimeout(() => {
                    SmartHub.UI.automationModal.overlay.classList.add('modal-hidden');
                    SmartHub.UI.automationModal.box.classList.add('modal-hidden');
                }, 300);
            }
        },

        // --- 12. User Management Module ---
        UserManager: {
            init: function() {
                const UI = SmartHub.UI.userModal;
                
                if (UI.addButton) {
                    UI.addButton.addEventListener('click', SmartHub.UserModal.open);
                }
                
                if (UI.closeButton) {
                    UI.closeButton.addEventListener('click', SmartHub.UserModal.close);
                    UI.overlay.addEventListener('click', SmartHub.UserModal.close);
                }
                
                if (UI.form) {
                    UI.form.addEventListener('submit', SmartHub.UserManager.addUser);
                }
                
                // Load users from state
                SmartHub.UserManager.renderUsers();
            },
            
            addUser: function(e) {
                e.preventDefault();
                
                const UI = SmartHub.UI.userModal;
                const name = document.getElementById('user-name').value;
                const email = document.getElementById('user-email').value;
                const role = document.getElementById('user-role').value;
                const access = document.getElementById('user-access').value;
                
                // Check if user already exists
                const existingUser = SmartHub.state.connectedUsers.find(user => user.email === email);
                if (existingUser) {
                    SmartHub.Notifications.show('User with this email already exists', 'error');
                    return;
                }
                
                // Generate initials for avatar
                const initials = name.split(' ').map(part => part.charAt(0)).join('').toUpperCase();
                
                // Generate a color for the avatar
                const colors = ['bg-blue-600', 'bg-purple-600', 'bg-green-600', 'bg-yellow-600', 'bg-red-600'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                // Add user to state
                const newUser = {
                    id: Date.now(),
                    name,
                    email,
                    role,
                    access,
                    initials,
                    color
                };
                
                SmartHub.state.connectedUsers.push(newUser);
                SmartHub.Persistence.saveState();
                
                // Update UI
                SmartHub.UserManager.renderUsers();
                
                // Reset form and close modal
                UI.form.reset();
                SmartHub.UserModal.close();
                
                // Show notification
                SmartHub.Notifications.show(`User ${name} added successfully`, 'success');
            },
            
            removeUser: function(userId) {
                // Find and remove user from state
                const userIndex = SmartHub.state.connectedUsers.findIndex(user => user.id === userId);
                if (userIndex !== -1) {
                    const userName = SmartHub.state.connectedUsers[userIndex].name;
                    SmartHub.state.connectedUsers.splice(userIndex, 1);
                    SmartHub.Persistence.saveState();
                    
                    // Update UI
                    SmartHub.UserManager.renderUsers();
                    
                    // Show notification
                    SmartHub.Notifications.show(`User ${userName} removed`, 'info');
                }
            },
            
            renderUsers: function() {
                const container = SmartHub.UI.userModal.usersContainer;
                if (!container) return;
                
                // Clear existing users
                container.innerHTML = '';
                
                // Add user cards
                SmartHub.state.connectedUsers.forEach(user => {
                    const userCard = document.createElement('div');
                    userCard.className = 'p-4 bg-gray-800 rounded-lg flex items-center space-x-3 relative';
                    userCard.innerHTML = `
                        <div class="w-10 h-10 rounded-full ${user.color} flex items-center justify-center font-bold">${user.initials}</div>
                        <div class="flex-grow">
                            <div class="font-medium">${user.name}</div>
                            <div class="text-sm text-gray-400">${user.role}</div>
                        </div>
                        <button class="remove-user-btn p-1 rounded-full text-gray-400 hover:bg-gray-700 hover:text-red-500" data-user-id="${user.id}">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    `;
                    
                    // Add remove user event listener
                    const removeBtn = userCard.querySelector('.remove-user-btn');
                    removeBtn.addEventListener('click', () => {
                        SmartHub.UserManager.removeUser(user.id);
                    });
                    
                    container.appendChild(userCard);
                });
                
                // Recreate icons after rendering users
                setTimeout(() => {
                    createIcons();
                }, 10);
            }
        },
        
        // --- 13. User Modal Module ---
        UserModal: {
            open: function() {
                if (!SmartHub.UI.userModal.overlay) return; 
                SmartHub.UI.userModal.overlay.classList.remove('modal-hidden');
                SmartHub.UI.userModal.box.classList.remove('modal-hidden');
                
                // Recreate icons after modal opens
                setTimeout(() => {
                    createIcons();
                }, 10);
                
                setTimeout(() => {
                    SmartHub.UI.userModal.overlay.classList.add('active');
                    SmartHub.UI.userModal.box.classList.add('active');
                }, 10);
            },
            close: function() {
                if (!SmartHub.UI.userModal.overlay) return;
                SmartHub.UI.userModal.overlay.classList.remove('active');
                SmartHub.UI.userModal.box.classList.remove('active');
                setTimeout(() => {
                    SmartHub.UI.userModal.overlay.classList.add('modal-hidden');
                    SmartHub.UI.userModal.box.classList.add('modal-hidden');
                }, 300);
            }
        },

        // --- 14. Effects Module ---
        Effects: {
            createRipple: function(event) {
                const button = event.currentTarget;
                if (!button) return;
                const oldRipple = button.querySelector(".ripple");
                if (oldRipple) { oldRipple.remove(); }
                const circle = document.createElement("span");
                const diameter = Math.max(button.clientWidth, button.clientHeight);
                const radius = diameter / 2;
                const rect = button.getBoundingClientRect();
                circle.style.width = circle.style.height = `${diameter}px`;
                circle.style.left = `${event.clientX - rect.left - radius}px`;
                circle.style.top = `${event.clientY - rect.top - radius}px`;
                circle.classList.add("ripple");
                button.appendChild(circle);
            }
        },
        
        // --- 15. Speech Recognition & TTS Module ---
        Speech: {
            recognition: null,
            init: function() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    if (SmartHub.UI.voice && SmartHub.UI.voice.statusMessage) { 
                        this.showStatus("Speech recognition not supported.", 4000, false); 
                        if (SmartHub.UI.voice.micButton) {
                            SmartHub.UI.voice.micButton.disabled = true;
                            SmartHub.UI.voice.micButton.classList.add('opacity-50', 'cursor-not-allowed');
                        }
                    }
                    return;
                }
                
                this.recognition = new SpeechRecognition();
                this.recognition.continuous = false;
                this.recognition.lang = 'en-US';
                this.recognition.interimResults = false;
                this.recognition.maxAlternatives = 1;

                this.recognition.onstart = this.onStart.bind(this);
                this.recognition.onresult = this.onResult.bind(this);
                this.recognition.onspeechend = () => this.recognition.stop();
                this.recognition.onerror = this.onError.bind(this);
                this.recognition.onend = this.onEnd.bind(this);
            },
            toggleListen: function() {
                if (!this.recognition) return;
                if (SmartHub.state.listening) {
                    this.recognition.stop();
                } else {
                    try { this.recognition.start(); } 
                    catch (err) { this.showStatus("Cannot start mic. Check permissions.", 4000, false); }
                }
            },
            onStart: function() {
                if (!SmartHub.UI.voice) return;
                SmartHub.state.listening = true;
                this.showStatus("Listening...", 10000, false);
                SmartHub.UI.voice.transcriptDisplay.textContent = "";
                SmartHub.UI.voice.micButton.classList.add('animate-pulse', 'bg-red-600');
                SmartHub.UI.voice.micIcon.classList.add('hidden');
                SmartHub.UI.voice.micActiveIcon.classList.remove('hidden');
            },
            onEnd: function() {
                if (!SmartHub.UI.voice) return;
                SmartHub.state.listening = false;
                SmartHub.UI.voice.micButton.classList.remove('animate-pulse', 'bg-red-600');
                SmartHub.UI.voice.micIcon.classList.remove('hidden');
                SmartHub.UI.voice.micActiveIcon.classList.add('hidden');
            },
            onError: function(event) {
                this.showStatus(event.error === 'no-speech' ? "Didn't hear anything." : `Error: ${event.error}`, 4000, false);
            },
            onResult: function(event) {
                if (!SmartHub.UI.voice) return;
                const transcript = event.results[0][0].transcript.toLowerCase().trim();
                SmartHub.UI.voice.transcriptDisplay.textContent = `"${transcript}"`;
                this.processCommand(transcript);
            },
            speak: function(text) {
                if (!('speechSynthesis' in window)) return;
                try {
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = 'en-US';
                    window.speechSynthesis.speak(u);
                } catch (e) { console.warn('TTS failed', e); }
            },
            showStatus: function(message, duration = 4000, speakMessage = true) {
                if (SmartHub.UI.voice && SmartHub.UI.voice.statusMessage) {
                    SmartHub.UI.voice.statusMessage.textContent = message;
                }
                if (SmartHub.state.statusTimer) clearTimeout(SmartHub.state.statusTimer);
                SmartHub.state.statusTimer = setTimeout(() => {
                    if (SmartHub.UI.voice && SmartHub.UI.voice.statusMessage && SmartHub.UI.voice.statusMessage.textContent === message) {
                        SmartHub.UI.voice.statusMessage.textContent = "Tap mic to speak";
                    }
                }, duration);
                if (speakMessage) this.speak(message);
            },
            parseNumber: function(command) {
                if (!command || typeof command !== 'string') return null;
                const digitMatch = command.match(/(\d+)/);
                if (digitMatch) return parseInt(digitMatch[1], 10);
                
                const tokens = command.toLowerCase().split(/[^a-z]+/).filter(Boolean);
                let total = 0, current = 0, found = false;
                for (const t of tokens) {
                    const map = SmartHub.config.wordToNumberMap;
                    if (!(t in map)) { if (current > 0) { total += current; current = 0; } continue; }
                    found = true;
                    const val = map[t];
                    if (val === 100) current = (current || 1) * 100; else current += val;
                }
                total += current;
                return found ? total : null;
            },
            
            processCommand: function(command) {
                let processed = false;
                for (const cmd of SmartHub.config.commands) {
                    const matches = command.match(cmd.regex);
                    if (matches) {
                        cmd.handler(matches, command);
                        processed = true;
                        break;
                    }
                }
                
                if (processed) {
                    SmartHub.UIUpdater.updateAllUIs();
                } else {
                    this.showStatus("Sorry, I don't understand that command.", 4000, false);
                }
            }
        },

        // --- 16. Notifications Module ---
        Notifications: {
            init: function() {
                // Initialize notification system
            },
            show: function(message, type = 'info', duration = 5000) {
                const container = SmartHub.UI.notificationContainer;
                if (!container) return;
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            ${type === 'success' ? '<i data-lucide="check-circle" class="w-5 h-5"></i>' : 
                              type === 'error' ? '<i data-lucide="x-circle" class="w-5 h-5"></i>' : 
                              type === 'warning' ? '<i data-lucide="alert-triangle" class="w-5 h-5"></i>' : 
                              '<i data-lucide="info" class="w-5 h-5"></i>'}
                        </div>
                        <div class="ml-3">
                            <p class="text-sm">${message}</p>
                        </div>
                        <div class="ml-auto pl-3">
                            <div class="-mx-1.5 -my-1.5">
                                <button type="button" class="notification-close inline-flex rounded-md p-1.5 hover:bg-gray-700 focus:outline-none">
                                    <span class="sr-only">Dismiss</span>
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(notification);
                
                // Recreate icons after adding notification
                setTimeout(() => {
                    createIcons();
                }, 10);
                
                // Show notification
                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);
                
                // Add close functionality
                const closeBtn = notification.querySelector('.notification-close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        this.hide(notification);
                    });
                }
                
                // Auto hide after duration
                setTimeout(() => {
                    this.hide(notification);
                }, duration);
            },
            hide: function(notification) {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }
    };
        function updateClockAndDate() {
        const now = new Date();

        const dateStr = now.toLocaleDateString(undefined, {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric"
        });

        const timeStr = now.toLocaleTimeString(undefined, { hour12: true });

        const dateEl = document.getElementById("date-display");
        const timeEl = document.getElementById("time-display");
        const ampmEl = document.getElementById("ampm-display");

        if (dateEl) dateEl.textContent = dateStr;

        if (timeEl && ampmEl) {
          const [time, ampm] = timeStr.split(" ");
          timeEl.textContent = time;
          ampmEl.textContent = ampm || "";
        }
      }

      updateClockAndDate();
      setInterval(updateClockAndDate, 1000);
    </script>
</body>
</html>

